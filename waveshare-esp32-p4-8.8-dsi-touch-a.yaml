# ESPHome config for Waveshare 8.8-DSI-TOUCH-A on ESP32-P4
# Uses MIPI-DSI display with LVGL and a centered "hello world" label

substitutions:
  device_name: touchpanel
  friendly_name: Waveshare 8.8" Touch Panel Controller
  project_name: waveshare-8.8-touch-panel
  project_version: "1.0.2"
  log_level: DEBUG

# Local external component for DSI display init with BSP-correct order
# Required because built-in mipi_dsi sends DCS after panel_init (blank screen).
# OTA7290B bridge needs DCS SLPOUT/DISPON BEFORE DPI video starts.
external_components:
  - source:
      type: local
      path: components
    components: [waveshare_dsi]

web_server:
  port: 80

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}
  on_boot:
    - priority: 600
      then:
        - lambda: |-
            // === Waveshare OTA7290B Bridge Init (BSP-matched order) ===
            // BSP: HW Reset -> MCU Init -> 1s delay -> DSI bus -> DCS -> DPI
            // We match this by doing HW reset + MCU init with a BLOCKING
            // 1s delay here, before the display component runs at priority ~250.

            // Step 1: Hardware reset via GPIO27 (BSP_LCD_DSI_RST)
            gpio_set_direction(GPIO_NUM_27, GPIO_MODE_OUTPUT);
            gpio_set_level(GPIO_NUM_27, 1);
            delay(10);
            gpio_set_level(GPIO_NUM_27, 0);
            delay(10);
            gpio_set_level(GPIO_NUM_27, 1);
            delay(50);

            // Step 2: MCU init (register 0x95) per Waveshare OTA7290B driver
            id(display_backlight_i2c).write_byte(0x95, 0x11);
            delay(10);
            id(display_backlight_i2c).write_byte(0x95, 0x17);

            // Step 3: Backlight on (direct I2C)
            id(display_backlight_i2c).write_byte(0x96, 0xFF);

            // Step 4: Wait for bridge to stabilize (BLOCKING)
            delay(200);
            ESP_LOGI("waveshare", "OTA7290B bridge init complete");
    - priority: 200
      then:
        - light.turn_on:
            id: display_backlight

# ESP32-C6 co-processor for WiFi via SDIO
# See: https://esphome.github.io/esp-hosted-firmware/
esp32_hosted:
  active_high: true
  variant: ESP32C6
  reset_pin: GPIO54
  cmd_pin: GPIO19
  clk_pin: GPIO18
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17

# Embedded co-processor firmware update (no WiFi/HTTP needed)
update:
  - platform: esp32_hosted
    name: "ESP32-C6 Firmware"
    type: embedded
    path: network_adapter_esp32c6.bin
    sha256: 2aa46dbcd18f5b2046f58b82cdc62bdf21af137930e67c4b3b114f6e3e0daf15
    update_interval: never

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: packages/display/sleep.yaml
        vars:
          touchscreen_id: dsi_touchscreen
          backlight_id: display_backlight

# Ethernet - DISABLED (Waveshare 8.8" DSI may not have IP101 PHY)
# ethernet:
#   type: IP101
#   mdc_pin: GPIO31
#   mdio_pin: GPIO52
#   power_pin: GPIO51
#   clk:
#     mode: CLK_EXT_IN
#     pin: GPIO50
#   phy_addr: 1

esp32:
  board: esp32-p4-evboard
  variant: esp32p4
  flash_size: 16MB
  framework:
    type: esp-idf

# Required for MIPI-DSI display
psram:
  mode: hex
  speed: 200MHZ

# LDO for MIPI-DSI PHY - required for display to initialize
esp_ldo:
  - voltage: 2.5V
    channel: 3

logger:
  level: DEBUG
  hardware_uart: UART0

# I2C for GT911 Touchscreen and panel/backlight MCU
# ESP32-P4 EVBoard default I2C used here
i2c:
  sda: GPIO7
  scl: GPIO8
  frequency: 400kHz
  scan: false

# I2C device for panel/backlight control (address 0x45)
i2c_device:
  - address: 0x45
    id: display_backlight_i2c

# Backlight brightness control as a light
output:
  - platform: template
    id: backlight_output
    type: float
    write_action:
      - lambda: |-
          // Write brightness to register 0x96 (0x00=off, 0xFF=full)
          // Per Waveshare wiki: ESP32-P4 uses register 0x96 at I2C address 0x45
          uint8_t brightness = (uint8_t)(state * 255);
          id(display_backlight_i2c).write_byte(0x96, brightness);

light:
  - platform: monochromatic
    name: "Display Backlight"
    id: display_backlight
    output: backlight_output
    default_transition_length: 250ms
    restore_mode: RESTORE_DEFAULT_ON

# MIPI-DSI Display - Waveshare 8.8" (480x1920 portrait)
# Using waveshare_dsi external component because built-in mipi_dsi sends DCS
# commands AFTER panel_init (starts DPI video), but OTA7290B bridge needs
# DCS SLPOUT/DISPON in LP mode BEFORE DPI video starts.
waveshare_dsi:
  id: dsi_display
  rotation: 270

# GT911 Touchscreen
touchscreen:
  - platform: gt911
    id: dsi_touchscreen
    update_interval: 200ms
    transform:
      swap_xy: true
      mirror_x: true
    on_touch:
      - lambda: |-
          for (auto &tp : touches) {
            ESP_LOGI("touch", "x=%d y=%d (display: 1920x480)", tp.x, tp.y);
          }

# ---- Home Assistant Sensors ----

# Pending brightness globals for slider debounce
globals:
  - id: pending_bright_main_cans
    type: int
    initial_value: '0'
  - id: pending_bright_bed_cans
    type: int
    initial_value: '0'
  - id: pending_bright_door
    type: int
    initial_value: '0'
  - id: pending_bright_dog_crate
    type: int
    initial_value: '0'
  - id: pending_bright_bed_capsule
    type: int
    initial_value: '0'
  - id: pending_bright_awning_out
    type: int
    initial_value: '0'
  - id: pending_bright_awning_in
    type: int
    initial_value: '0'
  - id: pending_bright_exterior
    type: int
    initial_value: '0'

# Debounce scripts: mode restart + 300ms delay = only fires after user stops dragging
script:
  - id: debounce_main_cans
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_main_can_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_main_cans);'

  - id: debounce_bed_cans
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_bed_can_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_bed_cans);'

  - id: debounce_door
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_door_light
          data_template:
            brightness: !lambda 'return id(pending_bright_door);'

  - id: debounce_dog_crate
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_dog_crate_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_dog_crate);'

  - id: debounce_bed_capsule
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_bed_capsule_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_bed_capsule);'

  - id: debounce_awning_out
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_awning_outside_light_strip
          data_template:
            brightness: !lambda 'return id(pending_bright_awning_out);'

  - id: debounce_awning_in
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_awning_inside_light_strip
          data_template:
            brightness: !lambda 'return id(pending_bright_awning_in);'

  - id: debounce_exterior
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_capsule_passenger_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_capsule_driver_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_passenger_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_driver_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_rear_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'

  # ── Tab Highlight Scripts ──
  - id: highlight_tab_home
    then:
      - lvgl.widget.update:
          id: btn_tab_home
          bg_color: 0x3A506B
      - lvgl.widget.update:
          id: btn_tab_weather
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_lights
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_power
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_water
          bg_color: 0x1A1A2E

  - id: highlight_tab_weather
    then:
      - lvgl.widget.update:
          id: btn_tab_home
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_weather
          bg_color: 0x3A506B
      - lvgl.widget.update:
          id: btn_tab_lights
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_power
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_water
          bg_color: 0x1A1A2E

  - id: highlight_tab_lights
    then:
      - lvgl.widget.update:
          id: btn_tab_home
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_weather
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_lights
          bg_color: 0x3A506B
      - lvgl.widget.update:
          id: btn_tab_power
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_water
          bg_color: 0x1A1A2E

  - id: highlight_tab_power
    then:
      - lvgl.widget.update:
          id: btn_tab_home
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_weather
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_lights
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_power
          bg_color: 0x3A506B
      - lvgl.widget.update:
          id: btn_tab_water
          bg_color: 0x1A1A2E

  - id: highlight_tab_water
    then:
      - lvgl.widget.update:
          id: btn_tab_home
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_weather
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_lights
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_power
          bg_color: 0x1A1A2E
      - lvgl.widget.update:
          id: btn_tab_water
          bg_color: 0x3A506B

text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_weather_condition
            text: !lambda |-
              if (x.empty()) return "Unknown";
              static const std::map<std::string, std::string> cond = {
                {"clear-night", "Clear"}, {"cloudy", "Cloudy"}, {"exceptional", "Exceptional"},
                {"fog", "Foggy"}, {"hail", "Hail"}, {"lightning", "Lightning"},
                {"lightning-rainy", "Thunderstorm"}, {"partlycloudy", "Partly Cloudy"},
                {"pouring", "Pouring"}, {"rainy", "Rainy"}, {"snowy", "Snowy"},
                {"snowy-rainy", "Sleet"}, {"sunny", "Sunny"}, {"windy", "Windy"},
                {"windy-variant", "Windy"},
              };
              auto it = cond.find(x);
              if (it != cond.end()) return it->second.c_str();
              return x.c_str();
        - lvgl.label.update:
            id: lbl_weather_icon
            text: !lambda |-
              static const std::map<std::string, std::string> icons = {
                {"clear-night", "\U000F0594"}, {"cloudy", "\U000F0590"},
                {"exceptional", "\U000F0F2F"}, {"fog", "\U000F0591"},
                {"hail", "\U000F0592"}, {"lightning", "\U000F0593"},
                {"lightning-rainy", "\U000F067E"}, {"partlycloudy", "\U000F0595"},
                {"pouring", "\U000F0596"}, {"rainy", "\U000F0597"},
                {"snowy", "\U000F0598"}, {"snowy-rainy", "\U000F067F"},
                {"sunny", "\U000F0599"}, {"windy", "\U000F059D"},
                {"windy-variant", "\U000F059E"},
              };
              auto it = icons.find(x);
              if (it != icons.end()) return it->second.c_str();
              return "\U000F0599";
        - lvgl.label.update:
            id: lbl_weather_cond_lg
            text: !lambda |-
              if (x.empty()) return "Unknown";
              static const std::map<std::string, std::string> cond = {
                {"clear-night", "Clear"}, {"cloudy", "Cloudy"}, {"exceptional", "Exceptional"},
                {"fog", "Foggy"}, {"hail", "Hail"}, {"lightning", "Lightning"},
                {"lightning-rainy", "Thunderstorm"}, {"partlycloudy", "Partly Cloudy"},
                {"pouring", "Pouring"}, {"rainy", "Rainy"}, {"snowy", "Snowy"},
                {"snowy-rainy", "Sleet"}, {"sunny", "Sunny"}, {"windy", "Windy"},
                {"windy-variant", "Windy"},
              };
              auto it = cond.find(x);
              if (it != cond.end()) return it->second.c_str();
              return x.c_str();
        - lvgl.label.update:
            id: lbl_weather_icon_lg
            text: !lambda |-
              static const std::map<std::string, std::string> icons = {
                {"clear-night", "\U000F0594"}, {"cloudy", "\U000F0590"},
                {"exceptional", "\U000F0F2F"}, {"fog", "\U000F0591"},
                {"hail", "\U000F0592"}, {"lightning", "\U000F0593"},
                {"lightning-rainy", "\U000F067E"}, {"partlycloudy", "\U000F0595"},
                {"pouring", "\U000F0596"}, {"rainy", "\U000F0597"},
                {"snowy", "\U000F0598"}, {"snowy-rainy", "\U000F067F"},
                {"sunny", "\U000F0599"}, {"windy", "\U000F059D"},
                {"windy-variant", "\U000F059E"},
              };
              auto it = icons.find(x);
              if (it != icons.end()) return it->second.c_str();
              return "\U000F0599";

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home
    attribute: temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_weather_temp
            text: !lambda |-
              if (x.empty()) return "--°";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%s°", x.c_str());
              return buf;
        - lvgl.label.update:
            id: lbl_weather_temp_lg
            text: !lambda |-
              if (x.empty()) return "--°";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%s°", x.c_str());
              return buf;

  - platform: homeassistant
    id: ha_latitude
    entity_id: sensor.latitude
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_location
            text: !lambda |-
              static char buf[48];
              std::string lat = id(ha_latitude).state;
              std::string lon = id(ha_longitude).state;
              if (lat.empty() || lon.empty()) return "--";
              snprintf(buf, sizeof(buf), "%s, %s", lat.c_str(), lon.c_str());
              return buf;

  - platform: homeassistant
    id: ha_longitude
    entity_id: sensor.longitude
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_location
            text: !lambda |-
              static char buf[48];
              std::string lat = id(ha_latitude).state;
              std::string lon = id(ha_longitude).state;
              if (lat.empty() || lon.empty()) return "--";
              snprintf(buf, sizeof(buf), "%s, %s", lat.c_str(), lon.c_str());
              return buf;

  - platform: homeassistant
    id: sunrise_time
    entity_id: sensor.sunrise
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_sunrise
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'
        - lvgl.label.update:
            id: lbl_sunrise_wx
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'

  - platform: homeassistant
    id: sunset_time
    entity_id: sensor.sunset
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_sunset
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'
        - lvgl.label.update:
            id: lbl_sunset_wx
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'

sensor:
  - platform: homeassistant
    id: water_level
    entity_id: sensor.water_tank_display_fresh_water_tank_level
    on_value:
      then:
        - lvgl.bar.update:
            id: bar_water
            value: !lambda 'return isnan(x) ? 0 : (int)x;'
        - lvgl.bar.update:
            id: bar_water_wtr
            value: !lambda 'return isnan(x) ? 0 : (int)x;'
        - lvgl.label.update:
            id: lbl_water_pct_wtr
            text: !lambda |-
              if (isnan(x)) return "0%";
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.0f%%", x);
              return buf;

  - platform: homeassistant
    id: water_gallons
    entity_id: sensor.water_tank_display_tank_gallons_remaining
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_water_pct
            text: !lambda |-
              if (isnan(x)) return "-- gal";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%.1f gal", x);
              return buf;
        - lvgl.label.update:
            id: lbl_water_gallons_wtr
            text: !lambda |-
              if (isnan(x)) return "-- gal";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%.1f gal", x);
              return buf;

  # TODO: Replace with real HA sensor once hooked up
  - platform: template
    id: battery_time_remaining
    name: "Battery Time (Test)"
    update_interval: 10s
    lambda: 'return (float)(rand() % 49);'  # 0-48 hours
    internal: true
    on_value:
      then:
        - lvgl.bar.update:
            id: bar_battery
            value: !lambda 'return isnan(x) ? 0 : (int)fminf(x, 48);'
        - lvgl.bar.update:
            id: bar_battery_pwr
            value: !lambda 'return isnan(x) ? 0 : (int)fminf(x, 48);'
        - lvgl.label.update:
            id: lbl_battery_time
            text: !lambda |-
              if (isnan(x)) return "-- hrs";
              static char buf[16];
              if (x >= 24) snprintf(buf, sizeof(buf), "%.0f days", x / 24.0f);
              else snprintf(buf, sizeof(buf), "%.1f hrs", x);
              return buf;
        - lvgl.label.update:
            id: lbl_battery_time_pwr
            text: !lambda |-
              if (isnan(x)) return "-- hrs remaining";
              static char buf[32];
              if (x >= 24) snprintf(buf, sizeof(buf), "%.0f days remaining", x / 24.0f);
              else snprintf(buf, sizeof(buf), "%.1f hrs remaining", x);
              return buf;

  # Interior climate sensors
  - platform: homeassistant
    id: ha_interior_temp
    entity_id: sensor.interior_temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_interior_temp
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;
        - lvgl.label.update:
            id: lbl_interior_temp_wx
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;

  - platform: homeassistant
    id: ha_interior_humidity
    entity_id: sensor.interior_humidity
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_interior_humidity
            text: !lambda |-
              if (isnan(x)) return "--%";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.0f%%", x);
              return buf;
        - lvgl.label.update:
            id: lbl_interior_hum_wx
            text: !lambda |-
              if (isnan(x)) return "--%";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.0f%%", x);
              return buf;

  - platform: homeassistant
    id: ha_fridge_temp
    entity_id: sensor.fridge_temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_fridge_temp
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;
        - lvgl.label.update:
            id: lbl_fridge_temp_wx
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;

  # Light brightness sensors (HA brightness is 0-255)
  - platform: homeassistant
    id: ha_bright_main_cans
    entity_id: light.light_controller_main_can_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_main_cans
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_bed_cans
    entity_id: light.light_controller_bed_can_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_bed_cans
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_door
    entity_id: light.light_controller_door_light
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_door
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_dog_crate
    entity_id: light.light_controller_dog_crate_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_dog_crate
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_bed_capsule
    entity_id: light.light_controller_bed_capsule_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_bed_capsule
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_awning_out
    entity_id: light.light_controller_awning_outside_light_strip
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_awning_out
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_awning_in
    entity_id: light.light_controller_awning_inside_light_strip
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_awning_in
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_exterior
    entity_id: light.light_controller_exterior_capsule_passenger_flood_light
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_exterior
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

# ---- Water Control State Sensors ----
# Track hot water heater and water pump state from the water tank controller
binary_sensor:
  - platform: homeassistant
    id: ha_hot_water_heater_state
    entity_id: switch.water_tank_display_hot_water_heater
    internal: true
    on_state:
      then:
        - lvgl.label.update:
            id: lbl_heater_status
            text: !lambda 'return x ? "ON" : "OFF";'
            text_color: !lambda 'return x ? lv_color_hex(0xFF6600) : lv_color_hex(0x888888);'
        - lvgl.label.update:
            id: lbl_heater_icon
            text: !lambda 'return x ? "\U000F0F92" : "\U000F0F91";'
            text_color: !lambda 'return x ? lv_color_hex(0xFF6600) : lv_color_hex(0x808080);'

  - platform: homeassistant
    id: ha_water_pump_state
    entity_id: switch.water_tank_display_water_pump
    internal: true
    on_state:
      then:
        - lvgl.label.update:
            id: lbl_pump_status
            text: !lambda 'return x ? "ON" : "OFF";'
            text_color: !lambda 'return x ? lv_color_hex(0x00BFFF) : lv_color_hex(0x888888);'
        - lvgl.label.update:
            id: lbl_pump_icon
            text: !lambda 'return x ? "\U000F058E" : "\U000F0F93";'
            text_color: !lambda 'return x ? lv_color_hex(0x00BFFF) : lv_color_hex(0x808080);'

# ---- 7-Day Forecast Sensors ----
# These pull from HA template sensors. Create them in HA configuration.yaml:
#   template:
#     - sensor:
#         - name: "Forecast Day 1 High"
#           state: "{{ state_attr('weather.forecast_home', 'forecast')[0].temperature | round(0) }}"
#         - name: "Forecast Day 1 Low"
#           state: "{{ state_attr('weather.forecast_home', 'forecast')[0].templow | round(0) }}"
#     - trigger:
#         - platform: time_pattern
#           hours: "/1"
#       action:
#         - service: weather.get_forecasts
#           target:
#             entity_id: weather.forecast_home
#           data:
#             type: daily
#           response_variable: forecast
#       sensor:
#         - name: "Forecast Day 0 Condition"
#           state: "{{ forecast['weather.forecast_home'].forecast[0].condition }}"
#         # ... repeat for days 0-6, high, low, condition

# ---- Fonts ----
font:
  # Large weather condition icon
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_weather_160
    size: 160
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      ]

  # Small icons for sunrise/sunset, water, battery, lightbulb
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_40
    size: 40
    bpp: 4
    glyphs: [
      "\U000F059C", # weather-sunset-up (sunrise)
      "\U000F059B", # weather-sunset-down (sunset)
      "\U000F058C", # water (drop)
      "\U000F0079", # battery (full)
      "\U000F008E", # battery-outline (empty)
      "\U000F0335", # lightbulb
      "\U000F0336", # lightbulb-on
      "\U000F12A3", # lightbulb-off
      "\U000F0143", # chevron-up (open)
      "\U000F04DB", # stop
      "\U000F0140", # chevron-down (close)
      "\U000F11B3", # awning-outline
      "\U000F0425", # power
      "\U000F050F", # thermometer
      "\U000F058E", # water-percent (humidity)
      "\U000F0290", # fridge
      "\U000F02DC", # home (tab icon)
      "\U000F0238", # fire (hot water heater)
      "\U000F0F92", # water-boiler (on)
      "\U000F0F91", # water-boiler-off
      "\U000F0F93", # water-pump-off
      # Weather condition icons (for forecast cards)
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      ]

  # UI text font
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_20
    size: 20
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

  # Large value font
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_32
    size: 32
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

# Update date/time labels every 60 seconds
interval:
  - interval: 60s
    then:
      - lvgl.label.update:
          id: lbl_time
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) return "--:--";
            static char buf[12];
            int hr = time.hour % 12;
            if (hr == 0) hr = 12;
            snprintf(buf, sizeof(buf), "%d:%02d %s", hr, time.minute, time.hour < 12 ? "AM" : "PM");
            return buf;
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) return "---";
            static char buf[24];
            static const char* days[] = {"Sun","Mon","Tue","Wed","Thu","Fri","Sat"};
            static const char* months[] = {"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"};
            snprintf(buf, sizeof(buf), "%s, %s %d", days[time.day_of_week-1], months[time.month-1], time.day_of_month);
            return buf;

# LVGL tabbed dashboard
# Layout: 80px left tab bar | 1840px content area (1920x480 total)
lvgl:
  displays:
    - dsi_display
  touchscreens:
    - dsi_touchscreen
  color_depth: 16
  buffer_size: 100%
  byte_order: little_endian
  pages:
    - id: main_page
      bg_color: 0x0D1B2A
      widgets:
        # ═══════════════════════════════════════════════════
        # LEFT TAB BAR (80px wide, full height)
        # ═══════════════════════════════════════════════════
        - obj:
            width: 80
            height: 480
            x: 0
            y: 0
            bg_color: 0x0D1B2A
            bg_opa: COVER
            border_width: 0
            pad_top: 20
            pad_bottom: 20
            pad_row: 8
            scrollbar_mode: "OFF"
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: CENTER
            widgets:
              # ── Home Tab Button ──
              - button:
                  id: btn_tab_home
                  width: 64
                  height: 72
                  bg_color: 0x3A506B
                  radius: 12
                  border_width: 0
                  on_press:
                    then:
                      - lvgl.widget.show: content_home
                      - lvgl.widget.hide: content_weather
                      - lvgl.widget.hide: content_lights
                      - lvgl.widget.hide: content_power
                      - lvgl.widget.hide: content_water
                      - script.execute: highlight_tab_home
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xFFFFFF
                        text: "\U000F02DC"
                        align: CENTER

              # ── Weather Tab Button ──
              - button:
                  id: btn_tab_weather
                  width: 64
                  height: 72
                  bg_color: 0x1A1A2E
                  radius: 12
                  border_width: 0
                  on_press:
                    then:
                      - lvgl.widget.hide: content_home
                      - lvgl.widget.show: content_weather
                      - lvgl.widget.hide: content_lights
                      - lvgl.widget.hide: content_power
                      - lvgl.widget.hide: content_water
                      - script.execute: highlight_tab_weather
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xB0B0B0
                        text: "\U000F0590"
                        align: CENTER

              # ── Lights Tab Button ──
              - button:
                  id: btn_tab_lights
                  width: 64
                  height: 72
                  bg_color: 0x1A1A2E
                  radius: 12
                  border_width: 0
                  on_press:
                    then:
                      - lvgl.widget.hide: content_home
                      - lvgl.widget.hide: content_weather
                      - lvgl.widget.show: content_lights
                      - lvgl.widget.hide: content_power
                      - lvgl.widget.hide: content_water
                      - script.execute: highlight_tab_lights
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xB0B0B0
                        text: "\U000F0335"
                        align: CENTER

              # ── Power Tab Button ──
              - button:
                  id: btn_tab_power
                  width: 64
                  height: 72
                  bg_color: 0x1A1A2E
                  radius: 12
                  border_width: 0
                  on_press:
                    then:
                      - lvgl.widget.hide: content_home
                      - lvgl.widget.hide: content_weather
                      - lvgl.widget.hide: content_lights
                      - lvgl.widget.show: content_power
                      - lvgl.widget.hide: content_water
                      - script.execute: highlight_tab_power
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xB0B0B0
                        text: "\U000F0079"
                        align: CENTER

              # ── Water Tab Button ──
              - button:
                  id: btn_tab_water
                  width: 64
                  height: 72
                  bg_color: 0x1A1A2E
                  radius: 12
                  border_width: 0
                  on_press:
                    then:
                      - lvgl.widget.hide: content_home
                      - lvgl.widget.hide: content_weather
                      - lvgl.widget.hide: content_lights
                      - lvgl.widget.hide: content_power
                      - lvgl.widget.show: content_water
                      - script.execute: highlight_tab_water
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xB0B0B0
                        text: "\U000F058C"
                        align: CENTER

        # ═══════════════════════════════════════════════════
        # HOME TAB CONTENT
        # ═══════════════════════════════════════════════════
        - obj:
            id: content_home
            width: 1840
            height: 480
            x: 80
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            pad_all: 0
            widgets:
              # ── Time & Date Section (left) ──
              - obj:
                  width: 480
                  height: 480
                  x: 0
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  pad_all: 20
                  widgets:
                    - label:
                        id: lbl_time
                        text: "12:00 AM"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 20
                        y: 20
                    - label:
                        id: lbl_date
                        text: "Mon, Jan 1"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 20
                        y: 60
                    - label:
                        id: lbl_location
                        text: "..."
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 20
                        y: 90
                    # ── Current Weather ──
                    - label:
                        id: lbl_weather_icon
                        text_font: mdi_weather_160
                        text_color: 0xFFD700
                        text: "\U000F0599"
                        x: 30
                        y: 140
                    - label:
                        id: lbl_weather_temp
                        text: "--°"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 210
                        y: 180
                    - label:
                        id: lbl_weather_condition
                        text: "--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 210
                        y: 220
                    # ── Sunrise / Sunset ──
                    - label:
                        text_font: mdi_40
                        text_color: 0xFFA500
                        text: "\U000F059C"
                        x: 20
                        y: 380
                    - label:
                        id: lbl_sunrise
                        text: "--:--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 70
                        y: 390
                    - label:
                        text_font: mdi_40
                        text_color: 0xFF6347
                        text: "\U000F059B"
                        x: 200
                        y: 380
                    - label:
                        id: lbl_sunset
                        text: "--:--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 250
                        y: 390

              # ── Climate & Status Section (center) ──
              - obj:
                  width: 560
                  height: 480
                  x: 480
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    # ── Interior Climate ──
                    - label:
                        text: "Interior Climate"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 20
                        y: 20
                    - label:
                        text_font: mdi_40
                        text_color: 0xFF6347
                        text: "\U000F050F"
                        x: 20
                        y: 55
                    - label:
                        id: lbl_interior_temp
                        text: "--°F"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 70
                        y: 60
                    - label:
                        text_font: mdi_40
                        text_color: 0x4FC3F7
                        text: "\U000F058E"
                        x: 200
                        y: 55
                    - label:
                        id: lbl_interior_humidity
                        text: "--%"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 250
                        y: 60
                    - label:
                        text_font: mdi_40
                        text_color: 0x81D4FA
                        text: "\U000F0290"
                        x: 380
                        y: 55
                    - label:
                        id: lbl_fridge_temp
                        text: "--°F"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 430
                        y: 60

                    # ── Water Level Bar ──
                    - label:
                        text: "Water"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 20
                        y: 140
                    - bar:
                        id: bar_water
                        width: 500
                        height: 30
                        x: 20
                        y: 170
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0x4FC3F7
                        min_value: 0
                        max_value: 100
                        value: 0
                    - label:
                        id: lbl_water_pct
                        text: "0%"
                        text_font: roboto_20
                        text_color: 0xFFFFFF
                        x: 230
                        y: 203

                    # ── Battery Bar ──
                    - label:
                        text: "Battery"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 20
                        y: 240
                    - bar:
                        id: bar_battery
                        width: 500
                        height: 30
                        x: 20
                        y: 270
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0x66BB6A
                        min_value: 0
                        max_value: 100
                        value: 0
                    - label:
                        id: lbl_battery_time
                        text: "--"
                        text_font: roboto_20
                        text_color: 0xFFFFFF
                        x: 200
                        y: 303

              # ── Awning Controls Section (right) ──
              - obj:
                  width: 760
                  height: 480
                  x: 1060
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    # ── Solar Panel Awning ──
                    - label:
                        text: "Solar Panel"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 40
                        y: 30
                    - button:
                        width: 100
                        height: 60
                        x: 40
                        y: 65
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.open_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0x66BB6A
                              text: "\U000F0143"
                              align: CENTER
                    - button:
                        width: 100
                        height: 60
                        x: 160
                        y: 65
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.stop_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFA726
                              text: "\U000F04DB"
                              align: CENTER
                    - button:
                        width: 100
                        height: 60
                        x: 280
                        y: 65
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.close_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xEF5350
                              text: "\U000F0140"
                              align: CENTER

                    # ── Main Awning ──
                    - label:
                        text: "Main Awning"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 40
                        y: 180
                    - button:
                        width: 100
                        height: 60
                        x: 40
                        y: 215
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.open_cover
                                data:
                                  entity_id: cover.awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0x66BB6A
                              text: "\U000F0143"
                              align: CENTER
                    - button:
                        width: 100
                        height: 60
                        x: 160
                        y: 215
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.stop_cover
                                data:
                                  entity_id: cover.awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFA726
                              text: "\U000F04DB"
                              align: CENTER
                    - button:
                        width: 100
                        height: 60
                        x: 280
                        y: 215
                        bg_color: 0x2D2D44
                        radius: 10
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.close_cover
                                data:
                                  entity_id: cover.awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xEF5350
                              text: "\U000F0140"
                              align: CENTER

        # ═══════════════════════════════════════════════════
        # WEATHER TAB CONTENT
        # ═══════════════════════════════════════════════════
        - obj:
            id: content_weather
            hidden: true
            width: 1840
            height: 480
            x: 80
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            pad_all: 0
            widgets:
              # ── Current Conditions (left 500px) ──
              - obj:
                  width: 500
                  height: 480
                  x: 0
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Current Weather"
                        text_font: roboto_20
                        text_color: 0x808080
                        x: 30
                        y: 15
                    - label:
                        id: lbl_weather_icon_lg
                        text_font: mdi_weather_160
                        text_color: 0xFFD700
                        text: "\U000F0599"
                        x: 40
                        y: 60
                    - label:
                        id: lbl_weather_temp_lg
                        text: "--°"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 230
                        y: 110
                    - label:
                        id: lbl_weather_cond_lg
                        text: "--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 230
                        y: 150
                    # Sunrise / Sunset
                    - label:
                        text_font: mdi_40
                        text_color: 0xFFA500
                        text: "\U000F059C"
                        x: 30
                        y: 280
                    - label:
                        id: lbl_sunrise_wx
                        text: "--:--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 80
                        y: 290
                    - label:
                        text_font: mdi_40
                        text_color: 0xFF6347
                        text: "\U000F059B"
                        x: 200
                        y: 280
                    - label:
                        id: lbl_sunset_wx
                        text: "--:--"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        x: 250
                        y: 290
                    # Interior climate
                    - label:
                        text_font: mdi_40
                        text_color: 0xFF6347
                        text: "\U000F050F"
                        x: 30
                        y: 360
                    - label:
                        id: lbl_interior_temp_wx
                        text: "--°F"
                        text_font: roboto_20
                        text_color: 0xFFFFFF
                        x: 80
                        y: 370
                    - label:
                        text_font: mdi_40
                        text_color: 0x4FC3F7
                        text: "\U000F058E"
                        x: 180
                        y: 360
                    - label:
                        id: lbl_interior_hum_wx
                        text: "--%"
                        text_font: roboto_20
                        text_color: 0xFFFFFF
                        x: 230
                        y: 370
                    - label:
                        text_font: mdi_40
                        text_color: 0x81D4FA
                        text: "\U000F0290"
                        x: 330
                        y: 360
                    - label:
                        id: lbl_fridge_temp_wx
                        text: "--°F"
                        text_font: roboto_20
                        text_color: 0xFFFFFF
                        x: 380
                        y: 370

              # ── Vertical Divider ──
              - obj:
                  width: 2
                  height: 440
                  x: 510
                  y: 20
                  bg_color: 0x3A3A5C
                  bg_opa: COVER
                  border_width: 0

              # ── 7-Day Forecast (right 1320px) ──
              # Requires HA template sensors - see comments in sensor section
              - obj:
                  width: 1320
                  height: 480
                  x: 520
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  pad_column: 4
                  pad_top: 15
                  pad_bottom: 15
                  pad_left: 10
                  pad_right: 10
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_main: SPACE_EVENLY
                    flex_align_cross: CENTER
                  widgets:
                    # Day 1
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day1_name
                              text: "Mon"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day1_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day1_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day1_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 2
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day2_name
                              text: "Tue"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day2_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day2_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day2_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 3
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day3_name
                              text: "Wed"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day3_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day3_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day3_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 4
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day4_name
                              text: "Thu"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day4_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day4_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day4_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 5
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day5_name
                              text: "Fri"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day5_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day5_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day5_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 6
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day6_name
                              text: "Sat"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day6_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day6_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day6_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

                    # Day 7
                    - obj:
                        width: 170
                        height: 440
                        bg_color: 0x2D2D44
                        bg_opa: COVER
                        radius: 16
                        border_width: 0
                        scrollbar_mode: "OFF"
                        widgets:
                          - label:
                              id: lbl_fc_day7_name
                              text: "Sun"
                              text_font: roboto_20
                              text_color: 0xB0B0B0
                              align: TOP_MID
                              y: 15
                          - label:
                              id: lbl_fc_day7_icon
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0599"
                              align: TOP_MID
                              y: 55
                          - label:
                              id: lbl_fc_day7_high
                              text: "--°"
                              text_font: roboto_32
                              text_color: 0xFFFFFF
                              align: TOP_MID
                              y: 120
                          - label:
                              id: lbl_fc_day7_low
                              text: "--°"
                              text_font: roboto_20
                              text_color: 0x808080
                              align: TOP_MID
                              y: 165

        # ═══════════════════════════════════════════════════
        # LIGHTS TAB CONTENT
        # ═══════════════════════════════════════════════════
        - obj:
            id: content_lights
            hidden: true
            width: 1840
            height: 480
            x: 80
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            pad_left: 20
            pad_right: 20
            pad_top: 10
            pad_bottom: 10
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: SPACE_EVENLY
              flex_align_cross: CENTER
            widgets:
              # ── Main Cans ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.main_cans
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_main_cans
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_main_cans
                    - label:
                        text: "Main Cans"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Bed Cans ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.bed_cans
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_bed_cans
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_bed_cans
                    - label:
                        text: "Bed Cans"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Door ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.door
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_door
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_door
                    - label:
                        text: "Door"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Dog Crate ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.dog_crate
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_dog_crate
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_dog_crate
                    - label:
                        text: "Dog Crate"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Bed Capsule ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.bed_capsule
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_bed_capsule
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_bed_capsule
                    - label:
                        text: "Bed Capsule"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Awning Out ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.awning_out
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_awning_out
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_awning_out
                    - label:
                        text: "Awning Out"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Awning In ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.awning_in
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_awning_in
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_awning_in
                    - label:
                        text: "Awning In"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

              # ── Exterior Floods ──
              - obj:
                  width: 200
                  height: 450
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - button:
                        width: 60
                        height: 60
                        align: TOP_MID
                        bg_color: 0x2D2D44
                        radius: 30
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.exterior_floods
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFD700
                              text: "\U000F0335"
                              align: CENTER
                    - slider:
                        id: sld_exterior
                        width: 30
                        height: 280
                        align: CENTER
                        y: 15
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0xFFD700
                        knob:
                          bg_color: 0xFFFFFF
                          radius: 14
                          width: 28
                          height: 28
                        min_value: 0
                        max_value: 255
                        value: 0
                        mode:
                          vertical: true
                        on_release:
                          then:
                            - script.execute: debounce_exterior
                    - label:
                        text: "Ext Floods"
                        text_font: roboto_20
                        text_color: 0xB0B0B0
                        align: BOTTOM_MID
                        y: -5

        # ═══════════════════════════════════════════════════
        # POWER TAB CONTENT
        # ═══════════════════════════════════════════════════
        - obj:
            id: content_power
            hidden: true
            width: 1840
            height: 480
            x: 80
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            pad_all: 0
            widgets:
              # ── Battery Status (left) ──
              - obj:
                  width: 800
                  height: 480
                  x: 0
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Battery Status"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 40
                        y: 30
                    - label:
                        text_font: mdi_40
                        text_color: 0x66BB6A
                        text: "\U000F0079"
                        x: 40
                        y: 90
                    - label:
                        id: lbl_battery_time_pwr
                        text: "-- remaining"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 100
                        y: 95
                    - bar:
                        id: bar_battery_pwr
                        width: 700
                        height: 40
                        x: 40
                        y: 160
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0x66BB6A
                        min_value: 0
                        max_value: 100
                        value: 0

              # ── Solar Panel Awning (right) ──
              - obj:
                  width: 1000
                  height: 480
                  x: 820
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Solar Panel Awning"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 40
                        y: 30
                    - label:
                        text_font: mdi_40
                        text_color: 0xFFA726
                        text: "\U000F11B3"
                        x: 40
                        y: 90
                    - button:
                        width: 200
                        height: 80
                        x: 40
                        y: 160
                        bg_color: 0x2E7D32
                        radius: 12
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.open_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFFFFF
                              text: "\U000F0143"
                              align: CENTER
                              x: -30
                          - label:
                              text: "Open"
                              text_font: roboto_20
                              text_color: 0xFFFFFF
                              align: CENTER
                              x: 20
                    - button:
                        width: 200
                        height: 80
                        x: 260
                        y: 160
                        bg_color: 0xF57F17
                        radius: 12
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.stop_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFFFFF
                              text: "\U000F04DB"
                              align: CENTER
                              x: -25
                          - label:
                              text: "Stop"
                              text_font: roboto_20
                              text_color: 0xFFFFFF
                              align: CENTER
                              x: 20
                    - button:
                        width: 200
                        height: 80
                        x: 480
                        y: 160
                        bg_color: 0xC62828
                        radius: 12
                        on_press:
                          then:
                            - homeassistant.service:
                                service: cover.close_cover
                                data:
                                  entity_id: cover.solar_panel_awning
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFFFFF
                              text: "\U000F0140"
                              align: CENTER
                              x: -30
                          - label:
                              text: "Close"
                              text_font: roboto_20
                              text_color: 0xFFFFFF
                              align: CENTER
                              x: 20

        # ═══════════════════════════════════════════════════
        # WATER TAB CONTENT
        # ═══════════════════════════════════════════════════
        - obj:
            id: content_water
            hidden: true
            width: 1840
            height: 480
            x: 80
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            pad_all: 0
            widgets:
              # ── Water Level (left) ──
              - obj:
                  width: 600
                  height: 480
                  x: 0
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Fresh Water"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 40
                        y: 30
                    - label:
                        text_font: mdi_40
                        text_color: 0x4FC3F7
                        text: "\U000F058C"
                        x: 40
                        y: 90
                    - label:
                        id: lbl_water_pct_wtr
                        text: "0%"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 100
                        y: 95
                    - bar:
                        id: bar_water_wtr
                        width: 500
                        height: 40
                        x: 40
                        y: 160
                        bg_color: 0x2D2D44
                        indicator:
                          bg_color: 0x4FC3F7
                        min_value: 0
                        max_value: 100
                        value: 0
                    - label:
                        id: lbl_water_gallons_wtr
                        text: "-- gal"
                        text_font: roboto_32
                        text_color: 0xB0B0B0
                        x: 40
                        y: 220

              # ── Hot Water Heater (center) ──
              - obj:
                  width: 500
                  height: 480
                  x: 620
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Hot Water Heater"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 40
                        y: 30
                    - button:
                        id: btn_hot_water
                        width: 400
                        height: 120
                        x: 40
                        y: 90
                        bg_color: 0x2D2D44
                        radius: 16
                        on_press:
                          then:
                            - homeassistant.service:
                                service: switch.toggle
                                data:
                                  entity_id: switch.water_tank_display_hot_water_heater
                        widgets:
                          - label:
                              id: lbl_heater_icon
                              text_font: mdi_40
                              text_color: 0x808080
                              text: "\U000F0F91"
                              align: LEFT_MID
                              x: 30
                          - label:
                              id: lbl_heater_status
                              text: "OFF"
                              text_font: roboto_32
                              text_color: 0x808080
                              align: CENTER
                              x: 30

              # ── Water Pump (right) ──
              - obj:
                  width: 500
                  height: 480
                  x: 1140
                  y: 0
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  widgets:
                    - label:
                        text: "Water Pump"
                        text_font: roboto_32
                        text_color: 0xFFFFFF
                        x: 40
                        y: 30
                    - button:
                        id: btn_water_pump
                        width: 400
                        height: 120
                        x: 40
                        y: 90
                        bg_color: 0x2D2D44
                        radius: 16
                        on_press:
                          then:
                            - homeassistant.service:
                                service: switch.toggle
                                data:
                                  entity_id: switch.water_tank_display_water_pump
                        widgets:
                          - label:
                              id: lbl_pump_icon
                              text_font: mdi_40
                              text_color: 0x808080
                              text: "\U000F0F93"
                              align: LEFT_MID
                              x: 30
                          - label:
                              id: lbl_pump_status
                              text: "OFF"
                              text_font: roboto_32
                              text_color: 0x808080
                              align: CENTER
                              x: 30
