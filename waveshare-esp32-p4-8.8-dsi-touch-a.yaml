# ESPHome config for Waveshare 8.8-DSI-TOUCH-A on ESP32-P4
# Uses MIPI-DSI display with LVGL and a centered "hello world" label

substitutions:
  device_name: touchpanel
  friendly_name: Waveshare 8.8" Touch Panel Controller
  log_level: DEBUG

# Local external component for DSI display init with BSP-correct order
# Required because built-in mipi_dsi sends DCS after panel_init (blank screen).
# OTA7290B bridge needs DCS SLPOUT/DISPON BEFORE DPI video starts.
external_components:
  - source:
      type: local
      path: components
    components: [waveshare_dsi]

web_server:
  port: 80

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    - priority: 600
      then:
        - lambda: |-
            // === Waveshare OTA7290B Bridge Init (BSP-matched order) ===
            // BSP: HW Reset -> MCU Init -> 1s delay -> DSI bus -> DCS -> DPI
            // We match this by doing HW reset + MCU init with a BLOCKING
            // 1s delay here, before the display component runs at priority ~250.

            // Step 1: Hardware reset via GPIO27 (BSP_LCD_DSI_RST)
            gpio_set_direction(GPIO_NUM_27, GPIO_MODE_OUTPUT);
            gpio_set_level(GPIO_NUM_27, 1);
            delay(10);
            gpio_set_level(GPIO_NUM_27, 0);
            delay(10);
            gpio_set_level(GPIO_NUM_27, 1);
            delay(50);

            // Step 2: MCU init (register 0x95) per Waveshare OTA7290B driver
            id(display_backlight_i2c).write_byte(0x95, 0x11);
            delay(10);
            id(display_backlight_i2c).write_byte(0x95, 0x17);

            // Step 3: Backlight on (direct I2C)
            id(display_backlight_i2c).write_byte(0x96, 0xFF);

            // Step 4: Wait for bridge to stabilize (BLOCKING)
            delay(200);
            ESP_LOGI("waveshare", "OTA7290B bridge init complete");
    - priority: 200
      then:
        - light.turn_on:
            id: display_backlight

# ESP32-C6 co-processor for WiFi via SDIO
# See: https://esphome.github.io/esp-hosted-firmware/
esp32_hosted:
  active_high: true
  variant: ESP32C6
  reset_pin: GPIO54
  cmd_pin: GPIO19
  clk_pin: GPIO18
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17

# Embedded co-processor firmware update (no WiFi/HTTP needed)
update:
  - platform: esp32_hosted
    name: "ESP32-C6 Firmware"
    type: embedded
    path: network_adapter_esp32c6.bin
    sha256: 2aa46dbcd18f5b2046f58b82cdc62bdf21af137930e67c4b3b114f6e3e0daf15
    update_interval: never

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: packages/display/sleep.yaml
        vars:
          touchscreen_id: dsi_touchscreen
          backlight_id: display_backlight

# Ethernet - DISABLED (Waveshare 8.8" DSI may not have IP101 PHY)
# ethernet:
#   type: IP101
#   mdc_pin: GPIO31
#   mdio_pin: GPIO52
#   power_pin: GPIO51
#   clk:
#     mode: CLK_EXT_IN
#     pin: GPIO50
#   phy_addr: 1

esp32:
  board: esp32-p4-evboard
  variant: esp32p4
  flash_size: 16MB
  framework:
    type: esp-idf

# Required for MIPI-DSI display
psram:
  mode: hex
  speed: 200MHZ

# LDO for MIPI-DSI PHY - required for display to initialize
esp_ldo:
  - voltage: 2.5V
    channel: 3

logger:
  level: DEBUG
  hardware_uart: UART0

# I2C for GT911 Touchscreen and panel/backlight MCU
# ESP32-P4 EVBoard default I2C used here
i2c:
  sda: GPIO7
  scl: GPIO8
  frequency: 400kHz
  scan: false

# I2C device for panel/backlight control (address 0x45)
i2c_device:
  - address: 0x45
    id: display_backlight_i2c

# Backlight brightness control as a light
output:
  - platform: template
    id: backlight_output
    type: float
    write_action:
      - lambda: |-
          // Write brightness to register 0x96 (0x00=off, 0xFF=full)
          // Per Waveshare wiki: ESP32-P4 uses register 0x96 at I2C address 0x45
          uint8_t brightness = (uint8_t)(state * 255);
          id(display_backlight_i2c).write_byte(0x96, brightness);

light:
  - platform: monochromatic
    name: "Display Backlight"
    id: display_backlight
    output: backlight_output
    default_transition_length: 250ms
    restore_mode: RESTORE_DEFAULT_ON

# MIPI-DSI Display - Waveshare 8.8" (480x1920 portrait)
# Using waveshare_dsi external component because built-in mipi_dsi sends DCS
# commands AFTER panel_init (starts DPI video), but OTA7290B bridge needs
# DCS SLPOUT/DISPON in LP mode BEFORE DPI video starts.
waveshare_dsi:
  id: dsi_display
  rotation: 270

# GT911 Touchscreen
touchscreen:
  - platform: gt911
    id: dsi_touchscreen
    update_interval: 200ms
    transform:
      swap_xy: true
      mirror_x: true
    on_touch:
      - lambda: |-
          for (auto &tp : touches) {
            ESP_LOGI("touch", "x=%d y=%d (display: 1920x480)", tp.x, tp.y);
          }

# ---- Home Assistant Sensors ----

# Pending brightness globals for slider debounce
globals:
  - id: pending_bright_main_cans
    type: int
    initial_value: '0'
  - id: pending_bright_bed_cans
    type: int
    initial_value: '0'
  - id: pending_bright_door
    type: int
    initial_value: '0'
  - id: pending_bright_dog_crate
    type: int
    initial_value: '0'
  - id: pending_bright_bed_capsule
    type: int
    initial_value: '0'
  - id: pending_bright_awning_out
    type: int
    initial_value: '0'
  - id: pending_bright_awning_in
    type: int
    initial_value: '0'
  - id: pending_bright_exterior
    type: int
    initial_value: '0'

# Debounce scripts: mode restart + 300ms delay = only fires after user stops dragging
script:
  - id: debounce_main_cans
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_main_can_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_main_cans);'

  - id: debounce_bed_cans
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_bed_can_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_bed_cans);'

  - id: debounce_door
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_door_light
          data_template:
            brightness: !lambda 'return id(pending_bright_door);'

  - id: debounce_dog_crate
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_dog_crate_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_dog_crate);'

  - id: debounce_bed_capsule
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_bed_capsule_lights
          data_template:
            brightness: !lambda 'return id(pending_bright_bed_capsule);'

  - id: debounce_awning_out
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_awning_outside_light_strip
          data_template:
            brightness: !lambda 'return id(pending_bright_awning_out);'

  - id: debounce_awning_in
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_awning_inside_light_strip
          data_template:
            brightness: !lambda 'return id(pending_bright_awning_in);'

  - id: debounce_exterior
    mode: restart
    then:
      - delay: 300ms
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_capsule_passenger_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_capsule_driver_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_passenger_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_driver_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: light.light_controller_exterior_roof_rear_flood_light
          data_template:
            brightness: !lambda 'return id(pending_bright_exterior);'

text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_weather_condition
            text: !lambda |-
              if (x.empty()) return "Unknown";
              static const std::map<std::string, std::string> cond = {
                {"clear-night", "Clear"}, {"cloudy", "Cloudy"}, {"exceptional", "Exceptional"},
                {"fog", "Foggy"}, {"hail", "Hail"}, {"lightning", "Lightning"},
                {"lightning-rainy", "Thunderstorm"}, {"partlycloudy", "Partly Cloudy"},
                {"pouring", "Pouring"}, {"rainy", "Rainy"}, {"snowy", "Snowy"},
                {"snowy-rainy", "Sleet"}, {"sunny", "Sunny"}, {"windy", "Windy"},
                {"windy-variant", "Windy"},
              };
              auto it = cond.find(x);
              if (it != cond.end()) return it->second.c_str();
              return x.c_str();
        - lvgl.label.update:
            id: lbl_weather_icon
            text: !lambda |-
              static const std::map<std::string, std::string> icons = {
                {"clear-night", "\U000F0594"}, {"cloudy", "\U000F0590"},
                {"exceptional", "\U000F0F2F"}, {"fog", "\U000F0591"},
                {"hail", "\U000F0592"}, {"lightning", "\U000F0593"},
                {"lightning-rainy", "\U000F067E"}, {"partlycloudy", "\U000F0595"},
                {"pouring", "\U000F0596"}, {"rainy", "\U000F0597"},
                {"snowy", "\U000F0598"}, {"snowy-rainy", "\U000F067F"},
                {"sunny", "\U000F0599"}, {"windy", "\U000F059D"},
                {"windy-variant", "\U000F059E"},
              };
              auto it = icons.find(x);
              if (it != icons.end()) return it->second.c_str();
              return "\U000F0599";

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home
    attribute: temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_weather_temp
            text: !lambda |-
              if (x.empty()) return "--°";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%s°", x.c_str());
              return buf;

  - platform: homeassistant
    id: ha_latitude
    entity_id: sensor.latitude
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_location
            text: !lambda |-
              static char buf[48];
              std::string lat = id(ha_latitude).state;
              std::string lon = id(ha_longitude).state;
              if (lat.empty() || lon.empty()) return "--";
              snprintf(buf, sizeof(buf), "%s, %s", lat.c_str(), lon.c_str());
              return buf;

  - platform: homeassistant
    id: ha_longitude
    entity_id: sensor.longitude
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_location
            text: !lambda |-
              static char buf[48];
              std::string lat = id(ha_latitude).state;
              std::string lon = id(ha_longitude).state;
              if (lat.empty() || lon.empty()) return "--";
              snprintf(buf, sizeof(buf), "%s, %s", lat.c_str(), lon.c_str());
              return buf;

  - platform: homeassistant
    id: sunrise_time
    entity_id: sensor.sunrise
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_sunrise
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'

  - platform: homeassistant
    id: sunset_time
    entity_id: sensor.sunset
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_sunset
            text: !lambda 'return x.empty() ? "--:--" : x.c_str();'

sensor:
  - platform: homeassistant
    id: water_level
    entity_id: sensor.water_tank_display_fresh_water_tank_level
    on_value:
      then:
        - lvgl.bar.update:
            id: bar_water
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: water_gallons
    entity_id: sensor.water_tank_display_tank_gallons_remaining
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_water_pct
            text: !lambda |-
              if (isnan(x)) return "-- gal";
              static char buf[16];
              snprintf(buf, sizeof(buf), "%.1f gal", x);
              return buf;

  # TODO: Replace with real HA sensor once hooked up
  - platform: template
    id: battery_time_remaining
    name: "Battery Time (Test)"
    update_interval: 10s
    lambda: 'return (float)(rand() % 49);'  # 0-48 hours
    internal: true
    on_value:
      then:
        - lvgl.bar.update:
            id: bar_battery
            value: !lambda 'return isnan(x) ? 0 : (int)fminf(x, 48);'
        - lvgl.label.update:
            id: lbl_battery_time
            text: !lambda |-
              if (isnan(x)) return "-- hrs";
              static char buf[16];
              if (x >= 24) snprintf(buf, sizeof(buf), "%.0f days", x / 24.0f);
              else snprintf(buf, sizeof(buf), "%.1f hrs", x);
              return buf;

  # Interior climate sensors
  - platform: homeassistant
    id: ha_interior_temp
    entity_id: sensor.interior_temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_interior_temp
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;

  - platform: homeassistant
    id: ha_interior_humidity
    entity_id: sensor.interior_humidity
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_interior_humidity
            text: !lambda |-
              if (isnan(x)) return "--%";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.0f%%", x);
              return buf;

  - platform: homeassistant
    id: ha_fridge_temp
    entity_id: sensor.fridge_temperature
    internal: true
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_fridge_temp
            text: !lambda |-
              if (isnan(x)) return "--°";
              static char buf[12];
              snprintf(buf, sizeof(buf), "%.1f°", x);
              return buf;

  # Light brightness sensors (HA brightness is 0-255)
  - platform: homeassistant
    id: ha_bright_main_cans
    entity_id: light.light_controller_main_can_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_main_cans
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_bed_cans
    entity_id: light.light_controller_bed_can_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_bed_cans
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_door
    entity_id: light.light_controller_door_light
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_door
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_dog_crate
    entity_id: light.light_controller_dog_crate_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_dog_crate
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_bed_capsule
    entity_id: light.light_controller_bed_capsule_lights
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_bed_capsule
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_awning_out
    entity_id: light.light_controller_awning_outside_light_strip
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_awning_out
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_awning_in
    entity_id: light.light_controller_awning_inside_light_strip
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_awning_in
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

  - platform: homeassistant
    id: ha_bright_exterior
    entity_id: light.light_controller_exterior_capsule_passenger_flood_light
    attribute: brightness
    internal: true
    on_value:
      then:
        - lvgl.slider.update:
            id: sld_exterior
            value: !lambda 'return isnan(x) ? 0 : (int)x;'

# ---- Fonts ----
font:
  # Large weather condition icon
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_weather_160
    size: 160
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      ]

  # Small icons for sunrise/sunset, water, battery, lightbulb
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_40
    size: 40
    bpp: 4
    glyphs: [
      "\U000F059C", # weather-sunset-up (sunrise)
      "\U000F059B", # weather-sunset-down (sunset)
      "\U000F058C", # water (drop)
      "\U000F0079", # battery (full)
      "\U000F008E", # battery-outline (empty)
      "\U000F0335", # lightbulb
      "\U000F0336", # lightbulb-on
      "\U000F12A3", # lightbulb-off
      "\U000F0143", # chevron-up (open)
      "\U000F04DB", # stop
      "\U000F0140", # chevron-down (close)
      "\U000F11B3", # awning-outline
      "\U000F0425", # power
      "\U000F050F", # thermometer
      "\U000F058E", # water-percent (humidity)
      "\U000F0290", # fridge
      ]

  # UI text font
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_20
    size: 20
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

  # Large value font
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_32
    size: 32
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

# Update date/time labels every 60 seconds
interval:
  - interval: 60s
    then:
      - lvgl.label.update:
          id: lbl_time
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) return "--:--";
            static char buf[12];
            int hr = time.hour % 12;
            if (hr == 0) hr = 12;
            snprintf(buf, sizeof(buf), "%d:%02d %s", hr, time.minute, time.hour < 12 ? "AM" : "PM");
            return buf;
      - lvgl.label.update:
          id: lbl_date
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) return "---";
            static char buf[24];
            static const char* days[] = {"Sun","Mon","Tue","Wed","Thu","Fri","Sat"};
            static const char* months[] = {"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"};
            snprintf(buf, sizeof(buf), "%s, %s %d", days[time.day_of_week-1], months[time.month-1], time.day_of_month);
            return buf;

# LVGL dashboard
lvgl:
  displays:
    - dsi_display
  touchscreens:
    - dsi_touchscreen
  color_depth: 16
  buffer_size: 100%
  byte_order: little_endian
  pages:
    - id: main_page
      bg_color: 0x1A1A2E
      widgets:
        # ── Weather Panel (left ~400px) ──
        - obj:
            width: 400
            height: 480
            x: 0
            y: 0
            bg_color: 0x16213E
            bg_opa: COVER
            border_width: 0
            pad_all: 20
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: CENTER
              pad_row: 8
            widgets:
              # Time
              - label:
                  id: lbl_time
                  text_font: roboto_32
                  text_color: 0xFFFFFF
                  text: "--:--"

              # Date
              - label:
                  id: lbl_date
                  text_font: roboto_20
                  text_color: 0xB0B0B0
                  text: "---"

              # Location
              - label:
                  id: lbl_location
                  text_font: roboto_20
                  text_color: 0x808080
                  text: "--"

              # Weather icon
              - label:
                  id: lbl_weather_icon
                  text_font: mdi_weather_160
                  text_color: 0xFFD700
                  text: "\U000F0599"

              # Temperature
              - label:
                  id: lbl_weather_temp
                  text_font: montserrat_48
                  text_color: 0xFFFFFF
                  text: "--°"

              # Condition text
              - label:
                  id: lbl_weather_condition
                  text_font: roboto_32
                  text_color: 0xB0B0B0
                  text: "Loading..."

              # Interior temp + humidity row
              - obj:
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_cross: CENTER
                    pad_column: 6
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0x4FC3F7
                        text: "\U000F050F"
                    - label:
                        id: lbl_interior_temp
                        text_font: roboto_20
                        text_color: 0xCCCCCC
                        text: "--°"
                    - label:
                        text_font: mdi_40
                        text_color: 0x4FC3F7
                        text: "\U000F058E"
                    - label:
                        id: lbl_interior_humidity
                        text_font: roboto_20
                        text_color: 0xCCCCCC
                        text: "--%"

              # Fridge temp row
              - obj:
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_cross: CENTER
                    pad_column: 6
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0x81D4FA
                        text: "\U000F0290"
                    - label:
                        id: lbl_fridge_temp
                        text_font: roboto_20
                        text_color: 0xCCCCCC
                        text: "--°"

              # Sunrise row
              - obj:
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_cross: CENTER
                    pad_column: 8
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xFFA500
                        text: "\U000F059C"
                    - label:
                        id: lbl_sunrise
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "--:--"

              # Sunset row
              - obj:
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW
                    flex_align_cross: CENTER
                    pad_column: 8
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xFF6347
                        text: "\U000F059B"
                    - label:
                        id: lbl_sunset
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "--:--"

        # ── Water & Battery Panel (center ~300px) ──
        - obj:
            width: 300
            height: 480
            x: 400
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            pad_all: 20
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: CENTER
              pad_row: 24
            widgets:
              # ── Water Level ──
              - obj:
                  width: 260
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    # Icon + label row
                    - obj:
                        width: 260
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_main: SPACE_BETWEEN
                          flex_align_cross: CENTER
                        widgets:
                          - obj:
                              width: SIZE_CONTENT
                              height: SIZE_CONTENT
                              bg_opa: TRANSP
                              border_width: 0
                              pad_all: 0
                              layout:
                                type: FLEX
                                flex_flow: ROW
                                flex_align_cross: CENTER
                                pad_column: 6
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0x4FC3F7
                                    text: "\U000F058C"
                                - label:
                                    text_font: roboto_20
                                    text_color: 0xCCCCCC
                                    text: "Water"
                          - label:
                              id: lbl_water_pct
                              text_font: roboto_20
                              text_color: 0xFFFFFF
                              text: "-- gal"
                    # Horizontal bar
                    - bar:
                        id: bar_water
                        width: 260
                        height: 20
                        min_value: 0
                        max_value: 100
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 10
                        indicator:
                          bg_color: 0x4FC3F7
                          radius: 10

              # ── Battery Time ──
              - obj:
                  width: 260
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    # Icon + label row
                    - obj:
                        width: 260
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_main: SPACE_BETWEEN
                          flex_align_cross: CENTER
                        widgets:
                          - obj:
                              width: SIZE_CONTENT
                              height: SIZE_CONTENT
                              bg_opa: TRANSP
                              border_width: 0
                              pad_all: 0
                              layout:
                                type: FLEX
                                flex_flow: ROW
                                flex_align_cross: CENTER
                                pad_column: 6
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0x66BB6A
                                    text: "\U000F0079"
                                - label:
                                    text_font: roboto_20
                                    text_color: 0xCCCCCC
                                    text: "Battery"
                          - label:
                              id: lbl_battery_time
                              text_font: roboto_20
                              text_color: 0xFFFFFF
                              text: "-- hrs"
                    # Horizontal bar (shows hours capped at 48h = 100%)
                    - bar:
                        id: bar_battery
                        width: 260
                        height: 20
                        min_value: 0
                        max_value: 48
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 10
                        indicator:
                          bg_color: 0x66BB6A
                          radius: 10

        # ── Awning Controls Panel (~200px) ──
        - obj:
            width: 200
            height: 480
            x: 700
            y: 0
            bg_color: 0x16213E
            bg_opa: COVER
            border_width: 0
            pad_all: 15
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: CENTER
              flex_align_cross: CENTER
              pad_row: 30
            widgets:
              # ── Solar Panel Awning ──
              - obj:
                  width: 170
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_cross: CENTER
                    pad_row: 10
                  widgets:
                    - label:
                        text_font: roboto_20
                        text_color: 0xCCCCCC
                        text: "Solar Panel"
                    - obj:
                        width: 170
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_main: SPACE_EVENLY
                          flex_align_cross: CENTER
                        widgets:
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0x388E3C
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.open_cover
                                      data:
                                        entity_id: cover.solar_panel_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F0143"
                                    align: CENTER
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0xF57C00
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.stop_cover
                                      data:
                                        entity_id: cover.solar_panel_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F04DB"
                                    align: CENTER
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0xD32F2F
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.close_cover
                                      data:
                                        entity_id: cover.solar_panel_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F0140"
                                    align: CENTER

              # ── Main Awning ──
              - obj:
                  width: 170
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_cross: CENTER
                    pad_row: 10
                  widgets:
                    - label:
                        text_font: mdi_40
                        text_color: 0xCCCCCC
                        text: "\U000F11B3"
                    - obj:
                        width: 170
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_main: SPACE_EVENLY
                          flex_align_cross: CENTER
                        widgets:
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0x388E3C
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.open_cover
                                      data:
                                        entity_id: cover.main_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F0143"
                                    align: CENTER
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0xF57C00
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.stop_cover
                                      data:
                                        entity_id: cover.main_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F04DB"
                                    align: CENTER
                          - button:
                              width: 50
                              height: 50
                              bg_color: 0xD32F2F
                              radius: 8
                              on_press:
                                then:
                                  - homeassistant.service:
                                      service: cover.close_cover
                                      data:
                                        entity_id: cover.main_awning
                              widgets:
                                - label:
                                    text_font: mdi_40
                                    text_color: 0xFFFFFF
                                    text: "\U000F0140"
                                    align: CENTER

        # ── Lights Panel (right ~1020px) ──
        - obj:
            width: 1020
            height: 480
            x: 900
            y: 0
            bg_color: 0x1A1A2E
            bg_opa: COVER
            border_width: 0
            pad_top: 15
            pad_bottom: 15
            pad_left: 10
            pad_right: 10
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: SPACE_EVENLY
              flex_align_cross: CENTER
            widgets:
              # -- Main Cans --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_main_cans
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_main_cans) = (int)x;'
                            - script.execute: debounce_main_cans
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Main"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_main_can_lights
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Bed Cans --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_bed_cans
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_bed_cans) = (int)x;'
                            - script.execute: debounce_bed_cans
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Bed"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_bed_can_lights
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Door --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_door
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_door) = (int)x;'
                            - script.execute: debounce_door
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Door"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_door_light
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Dog Crate --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_dog_crate
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_dog_crate) = (int)x;'
                            - script.execute: debounce_dog_crate
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Crate"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_dog_crate_lights
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Bed Capsule --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_bed_capsule
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_bed_capsule) = (int)x;'
                            - script.execute: debounce_bed_capsule
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Capsule"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_bed_capsule_lights
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Awning Outside --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_awning_out
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_awning_out) = (int)x;'
                            - script.execute: debounce_awning_out
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Awn Out"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_awning_outside_light_strip
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Awning Inside --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_awning_in
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_awning_in) = (int)x;'
                            - script.execute: debounce_awning_in
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Awn In"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_awning_inside_light_strip
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER

              # -- Exterior (all 5 floods) --
              - obj:
                  width: 120
                  height: 440
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                    flex_align_cross: CENTER
                    pad_row: 6
                  widgets:
                    - slider:
                        id: sld_exterior
                        width: 50
                        height: 290
                        min_value: 0
                        max_value: 255
                        value: 0
                        bg_color: 0x333333
                        border_width: 0
                        radius: 8
                        indicator:
                          bg_color: 0xFFAB40
                          radius: 8
                        knob:
                          bg_opa: TRANSP
                          width: 0
                          height: 0
                        on_value:
                          then:
                            - lambda: 'id(pending_bright_exterior) = (int)x;'
                            - script.execute: debounce_exterior
                    - label:
                        text_font: roboto_32
                        text_color: 0xCCCCCC
                        text: "Flood"
                    - button:
                        width: 50
                        height: 50
                        bg_color: 0x333333
                        radius: 25
                        on_press:
                          then:
                            - homeassistant.service:
                                service: light.toggle
                                data:
                                  entity_id: light.light_controller_exterior_capsule_passenger_flood_light
                        widgets:
                          - label:
                              text_font: mdi_40
                              text_color: 0xFFAB40
                              text: "\U000F0425"
                              align: CENTER
