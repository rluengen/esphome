substitutions:
  device_name: tabcontroller
  friendly_name: Controller
  project_name:  Mercedes Sprinter Control Modules
  project_version: "1.0.0"
  log_level: DEBUG

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: packages/icons/homeassistant_icons.yaml
      - path: packages/icons/network_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: devices/waveshare-ESP32-S3-Touch-LCD-5B.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}

# add a status bar across the top showing the time, location, latitude, longitude
# also include the interior and exterior temperature, current humidity levels, and forecast.

# in the main page of the lvgl graphics, put a switch for all lights, interior and exterior lights
# awning cover controls, and solar panel display. Also put a status for the water tank level.

# do we need to show the water detector error message if water leak is detected?

display:
  - id: !extend main_display
    auto_clear_enabled: false

# Update date label when time changes (every minute)
time:
  - id: !extend time_entity
    on_time:
      - seconds: 0
        then:
          - lvgl.label.update:
              id: lbl_status_date
              text: !lambda |-
                auto time = id(time_entity).now();
                if (time.is_valid()) {
                  static char buf[40];
                  snprintf(buf, sizeof(buf), "%s %s %d, %d", 
                    time.strftime("%A").c_str(),
                    time.strftime("%B").c_str(),
                    time.day_of_month,
                    time.year);
                  return buf;
                }
                return "-- --, ----";

font:
  - file: "fonts/segoeui.ttf"
    id: segoeui_16
    size: 16
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"
  
  - file: "fonts/segoeui.ttf"
    id: segoeui_20
    size: 20
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

binary_sensor:
  # API connection status
  - platform: status
    id: api_connected
    name: "API Connected"
    on_state:
      then:
        - lvgl.label.update:
            id: lbl_ha_status
            text: !lambda |-
              if (id(api_connected).state) {
                return "\U000F06A1";
              }
              return "\U000F0F21";

  # WiFi connection status
  - platform: template
    id: wifi_connected
    name: "WiFi Connected"
    lambda: |-
      return !isnan(id(wifi_signal_db).state) && id(wifi_signal_db).state < 0;

sensor:
  - platform: wifi_signal
    id: wifi_signal_db
    name: "WiFi Signal"
    update_interval: 60s
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_wifi_status
            text: !lambda |-
              if (!id(wifi_connected).state) {
                return "\U000F05AA";
              }
              int rssi = (int)id(wifi_signal_db).state;
              if (rssi >= -50) return "\U000F0928";
              else if (rssi >= -60) return "\U000F0925";
              else if (rssi >= -70) return "\U000F0922";
              else if (rssi >= -80) return "\U000F091F";
              return "\U000F092F";

  - platform: homeassistant
    id: location_latitude
    entity_id: sensor.location_latitude
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_status_location
            text: !lambda |-
              if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
                static char buf[64];
                snprintf(buf, sizeof(buf), "%s, %s", 
                  id(location_city).state.c_str(), 
                  id(location_state).state.c_str());
                return buf;
              }
              if (!isnan(id(location_latitude).state) && !isnan(id(location_longitude).state)) {
                static char buf[32];
                snprintf(buf, sizeof(buf), "%.4f, %.4f", 
                  id(location_latitude).state, 
                  id(location_longitude).state);
                return buf;
              }
              return "-- , --";

  - platform: homeassistant
    id: location_longitude
    entity_id: sensor.location_longitude

  - platform: homeassistant
    id: interior_temp
    entity_id: sensor.interior_temperature
    on_value:
      then:
        - lvgl.label.update:
            id: interior_temp_label
            text: !lambda |-
              return (to_string(x) + "�C").c_str();

  - platform: homeassistant
    id: exterior_temp
    entity_id: sensor.exterior_temperature
    on_value:
      then:
        - lvgl.label.update:
            id: exterior_temp_label
            text: !lambda |-
              return (to_string(x) + "�C").c_str();

  - platform: homeassistant
    id: interior_humidity
    entity_id: sensor.interior_humidity
    on_value:
      then:
        - lvgl.label.update:
            id: interior_humidity_label
            text: !lambda |-
              return (to_string(x) + "%").c_str();

  - platform: homeassistant
    id: water_level
    entity_id: sensor.fresh_water_percent
    on_value:
      then:
        - lvgl.bar.update:
            id: water_level_bar
            value: !lambda 'return x;'

text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.home
    attribute: condition
    on_value:
      then:
        - lvgl.label.update:
            id: weather_condition_label
            text: !lambda 'return x.c_str();'

  - platform: homeassistant
    id: location_name
    entity_id: zone.home
    attribute: friendly_name
    on_value:
      then:
        - lvgl.label.update:
            id: location_label
            text: !lambda 'return x.c_str();'

  - platform: homeassistant
    id: latitude
    entity_id: zone.home
    attribute: latitude
    on_value:
      then:
        - lvgl.label.update:
            id: latlon_label
            text: !lambda |-
              return ("Lat: " + x + " Lon: " + id(longitude).state).c_str();

  - platform: homeassistant
    id: longitude
    entity_id: zone.home
    attribute: longitude

  - platform: homeassistant
    id: location_city
    entity_id: sensor.location_city
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_status_location
            text: !lambda |-
              if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
                static char buf[64];
                snprintf(buf, sizeof(buf), "%s, %s", 
                  id(location_city).state.c_str(), 
                  id(location_state).state.c_str());
                return buf;
              }
              return "-- , --";

  - platform: homeassistant
    id: location_state
    entity_id: sensor.location_state
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_status_location
            text: !lambda |-
              if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
                static char buf[64];
                snprintf(buf, sizeof(buf), "%s, %s", 
                  id(location_city).state.c_str(), 
                  id(location_state).state.c_str());
                return buf;
              }
              return "-- , --";

switch:
  - platform: homeassistant
    id: awning_switch
    entity_id: switch.awning

light:
  - platform: homeassistant
    id: cabin_lights
    entity_id: light.cabin

lvgl:
  theme:
    preset: default
  text_font: segoeui_16

  pages:
    - id: main_page
      scrollbar_mode: "OFF"
      widgets:
        # Status Bar - at top of main page
        - obj:
            id: status_bar
            width: 100%
            height: 30
            align: TOP_MID
            x: 0
            y: 0
            border_width: 0
            radius: 0
            pad_all: 3
            widgets:
              # Left side: Location
              - label:
                  id: lbl_status_location
                  align: LEFT_MID
                  x: 5
                  text_font: segoeui_20
                  text: "-"

              # Center: Date
              - label:
                  id: lbl_status_date
                  align: CENTER
                  x: 0
                  y: 0
                  text_font: segoeui_20
                  text: "-- --, ----"

              # Right side container with flex layout
              - obj:
                  id: status_icons_container
                  align: RIGHT_MID
                  x: 0
                  y: 0
                  width: SIZE_CONTENT
                  height: 100%
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW_REVERSE
                    flex_align_main: START
                    flex_align_cross: CENTER
                    pad_column: 5
                  widgets:
                    # Home Assistant status (rightmost)
                    - label:
                        id: lbl_ha_status
                        text_font: homeassistant_icons
                        text: "\U000F0F21"

                    # WiFi status
                    - label:
                        id: lbl_wifi_status
                        text_font: wifi_icons
                        text: "\U000F05AA"

        # -----------------------------
        # INTERIOR / EXTERIOR DATA
        # -----------------------------
        - label:
            id: interior_temp_label
            text: "--°C"
            align: LEFT_MID
            x: 10
            y: -40

        - label:
        id: interior_humidity_label
        text: "--%"
        align: LEFT_MID
        x: 10
        y: -10

    - label:
        id: exterior_temp_label
        text: "--�C"
        align: LEFT_MID
        x: 10
        y: 40

    # -----------------------------
    # WEATHER
    # -----------------------------
    - label:
        id: weather_condition_label
        text: "Weather: --"
        align: CENTER
        y: -40

    # -----------------------------
    # LIGHT DIMMER
    # -----------------------------
    - slider:
        id: cabin_slider
        align: BOTTOM_LEFT
        x: 10
        y: -40
        width: 180
        min_value: 0
        max_value: 100
        on_value:
          then:
            - lambda: |-
                float b = id(cabin_slider).get_value() / 100.0f;
                id(cabin_lights).make_call().set_brightness(b).perform();

    - label:
        id: cabin_slider_label
        text: "Cabin Lights"
        align_to:
          id: cabin_slider
          align: OUT_TOP_MID
          y: -5

    # -----------------------------
    # AWNING BUTTON
    # -----------------------------
    - button:
        id: awning_button
        align: BOTTOM_RIGHT
        x: -10
        y: -40
        on_click:
          then:
            - lambda: |-
                id(awning_switch).toggle();

    - label:
        id: awning_button_label
        text: "Awning"
        parent: awning_button

    # -----------------------------
    # WATER LEVEL BAR
    # -----------------------------
    - bar:
        id: water_level_bar
        align: RIGHT_MID
        x: -10
        width: 20
        height: 120
        min_value: 0
        max_value: 100

    - label:
        id: water_label
        text: "Water"
        align_to:
          id: water_level_bar
          align: OUT_TOP_MID
          y: -5

globals:
  - id: screen_on
    type: bool
    restore_value: no
    initial_value: "true"

# output:
#   - platform: ledc
#     id: backlight_pwm
#     pin: 21

# light:
#   - platform: monochromatic
#     id: backlight
#     output: backlight_pwm
#     on_turn_on:
#       then:
#         - lambda: |-
#             id(screen_on) = true;
#     on_turn_off:
#       then:
#         - lambda: |-
#             id(screen_on) = false;
