# https://jnan.co/tools/esphomelvglsim/

# Dashboard to display home assistant status and weather information.

# https://wikitwist.com/how-to-use-the-seeedstudio-reterminal-e1001-with-home-assistant-via-esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome_advanced/

substitutions:
  device_name: terminal
  friendly_name: "Terminal Display"
  project_version: "1.0.0"
  log_level: DEBUG
  sleep_duration: 10min

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/icons/network_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: packages/icons/weather_icons.yaml
      - path: packages/icons/homeassistant_icons.yaml
      - path: devices/reterminal-e1001.yaml

# Time configuration - Home Assistant primary, SNTP fallback
time:
  - platform: homeassistant
    id: time_entity
    on_time_sync:
      then:
        - logger.log:
            level: INFO
            format: "[TIME] Synchronized with Home Assistant"

  - platform: sntp
    id: time_sntp
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org
    on_time_sync:
      then:
        - logger.log:
            level: INFO
            format: "[TIME] Synchronized with SNTP"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  comment: "Terminal Dashboard Display"
  on_boot:
    priority: 600
    then:
      - logger.log:
          level: INFO
          format: "[BOOT] ESPHome on_boot starting (priority 600)"
      - logger.log:
          level: INFO
          format: "[BOOT] Pausing LVGL"
      - lvgl.pause:
      - logger.log:
          level: INFO
          format: "[BOOT] Enabling battery measurement"
      - output.turn_on: bsp_battery_enable
      - delay: 150ms
      - logger.log:
          level: INFO
          format: "[BOOT] Updating battery_voltage sensor"
      - component.update: battery_voltage
      - logger.log:
          level: INFO
          format: "[BOOT] Updating battery_level sensor"
      - component.update: battery_level
      - delay: 50ms
      - lambda: |-
          ESP_LOGI("BOOT", "Battery voltage: %.2fV, level: %.0f%%", 
            id(battery_voltage).state, id(battery_level).state);
      - logger.log:
          level: INFO
          format: "[BOOT] Resuming LVGL"
      - lvgl.resume:
      - logger.log:
          level: INFO
          format: "[BOOT] Updating epaper display"
      - component.update: epaper_display
      - delay: 100ms  # Let display render complete
      - logger.log:
          level: INFO
          format: "[BOOT] Pausing LVGL after initial render"
      - lvgl.pause:
      - logger.log:
          level: INFO
          format: "[BOOT] Disabling battery measurement"
      - output.turn_off: bsp_battery_enable
      - logger.log:
          level: INFO
          format: "[BOOT] Boot sequence complete"

logger:
  level: ${log_level}
  baud_rate: 115200
  hardware_uart: UART0

binary_sensor:
  - id: !extend button_left
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Left button pressed - going to previous page"
        - lvgl.resume:
        - lvgl.page.previous:
            time: 0ms
        - delay: 50ms
        - component.update: epaper_display
        - delay: 100ms
        - lvgl.pause:

  - id: !extend button_right
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Right button pressed - going to next page"
        - lvgl.resume:
        - lvgl.page.next:
            time: 0ms
        - delay: 50ms
        - component.update: epaper_display
        - delay: 100ms
        - lvgl.pause:

  - id: !remove button_green

  # API connection status
  - platform: status
    id: api_connected
    name: "API Connected"

  # WiFi connection status (uses template to check if signal exists)
  - platform: template
    id: wifi_connected
    name: "WiFi Connected"
    lambda: |-
      return !isnan(id(wifi_signal_db).state) && id(wifi_signal_db).state < 0;

  # Battery charging status (check if USB/external power is connected)
  - platform: template
    id: battery_charging
    name: "Battery Charging"
    lambda: |-
      // Returns true if battery voltage is rising or above charging threshold
      // Adjust logic based on your hardware's charging detection
      return id(battery_voltage).state > 4.1;  // Typical charging voltage

font:
  - file: "fonts/segoeui.ttf"
    id: segoeui_16
    size: 16
    bpp: 4
  
  - file: "fonts/segoeui.ttf"
    id: segoeui_20
    size: 20
    bpp: 4
  
  - file: "fonts/segoeui.ttf"
    id: segoeui_24
    size: 24
    bpp: 4

interval:
  - interval: 10min
    then:
      - logger.log:
          level: INFO
          format: "[INTERVAL] 10-minute interval triggered"
      - logger.log:
          level: INFO
          format: "[INTERVAL] Enabling battery measurement"
      - output.turn_on: bsp_battery_enable
      - delay: 150ms
      - logger.log:
          level: INFO
          format: "[INTERVAL] Updating battery sensors"
      - component.update: battery_voltage
      - component.update: battery_level
      - delay: 50ms
      - lambda: |-
          ESP_LOGI("INTERVAL", "Sensor states - Fuel: %.1f%%, DEF: %.1f%%, Vehicle Battery: %.1f%%, Device Battery: %.0f%% (%.2fV)",
            id(fuel_level).state, id(def_level).state, id(vehicle_battery).state,
            id(battery_level).state, id(battery_voltage).state);
      - logger.log:
          level: INFO
          format: "[INTERVAL] Resuming LVGL for update"
      - lvgl.resume:
      - delay: 50ms  # Let LVGL process widget updates
      - logger.log:
          level: INFO
          format: "[INTERVAL] Updating epaper display"
      - component.update: epaper_display
      - delay: 100ms  # Let display render complete
      - logger.log:
          level: INFO
          format: "[INTERVAL] Pausing LVGL after update"
      - lvgl.pause:
      - logger.log:
          level: INFO
          format: "[INTERVAL] Disabling battery measurement"
      - output.turn_off: bsp_battery_enable
      - logger.log:
          level: INFO
          format: "[INTERVAL] Display update complete"

lvgl:
  border_width: 0
  outline_width: 0
  shadow_width: 0
  text_font: segoeui_16
  align: center
  resume_on_input: false  # Don't auto-resume on input - we control rendering manually

  on_idle:
    timeout: 10s
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_idle triggered (10s timeout)"
      - lambda: |-
          ESP_LOGI("LVGL", "Idle timeout reached - display inactive for 10s");
  
  on_ready:
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_ready - LVGL initialized"
      - lambda: |-
          ESP_LOGI("LVGL", "LVGL ready and initialized");

  on_pause:
    - logger.log:
        level: INFO
        format: "[LVGL] on_pause triggered"
    - lambda: |-
        ESP_LOGI("LVGL", "Battery charging: %s, voltage: %.2fV", 
          id(battery_charging).state ? "YES" : "NO", id(battery_voltage).state);
    - if:
        condition:
          binary_sensor.is_off: battery_charging
        then:
          - logger.log:
              level: INFO
              format: "[LVGL] Not charging - entering deep sleep for ${sleep_duration}"
          # - deep_sleep.enter:
          #     id: deep_sleep_id
          #     sleep_duration: ${sleep_duration}
        else:
          - logger.log:
              level: INFO
              format: "[LVGL] Charging detected - skipping deep sleep"

  on_resume:
    - logger.log:
        level: INFO
        format: "[LVGL] on_resume - display waking up"
  on_boot:
    - logger.log:
        level: INFO
        format: "[LVGL] on_boot - LVGL starting"

  pages:
    - id: main_page
      bg_color: 0x000000
      widgets:
        # Status Bar - at top of main page
        - obj:
            id: status_bar
            width: 100%
            height: 30
            align: TOP_MID
            bg_color: 0x000000
            x: 0
            y: 0
            border_width: 0
            radius: 0
            pad_all: 3
            widgets:
              # Left side: Location (lat/long)
              - label:
                  id: lbl_status_location
                  align: LEFT_MID
                  x: 5
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: !lambda |-
                    if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
                      static char buf[64];
                      snprintf(buf, sizeof(buf), "%s, %s", 
                        id(location_city).state.c_str(), 
                        id(location_state).state.c_str());
                      return buf;
                    }
                  
                    if (!isnan(id(location_latitude).state) && !isnan(id(location_longitude).state)) {
                      static char buf[32];
                      snprintf(buf, sizeof(buf), "%.4f, %.4f", 
                        id(location_latitude).state, 
                        id(location_longitude).state);
                      return buf;
                    }
                    return "-- , --";

              # Center: Date
              - label:
                  id: lbl_status_date
                  align: CENTER
                  x: 0
                  y: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: !lambda |-
                    auto time = id(time_entity).now();
                    if (!time.is_valid()) {
                      time = id(time_sntp).now();
                    }
                    if (time.is_valid()) {
                      static char buf[40];
                      snprintf(buf, sizeof(buf), "%s %s %d, %d", 
                        time.strftime("%A").c_str(),
                        time.strftime("%B").c_str(),
                        time.day_of_month,
                        time.year);
                      return buf;
                    }
                    return "-- --, ----";

              # Right side container with flex layout
              - obj:
                  id: status_icons_container
                  align: RIGHT_MID
                  x: 0
                  y: 0
                  width: SIZE_CONTENT
                  height: 100%
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW_REVERSE
                    flex_align_main: START
                    flex_align_cross: CENTER
                    pad_column: 5
                  widgets:
                    # Home Assistant status (rightmost)
                    - label:
                        id: lbl_ha_status
                        text_font: homeassistant_icons
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (id(api_connected).state) {
                            return "\U000F07D0";  // Home Assistant connected icon
                          }
                          return "\U000F07D2";  // Home Assistant disconnected icon

                    # WiFi status
                    - label:
                        id: lbl_wifi_status
                        text_font: wifi_icons
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (!id(wifi_connected).state) {
                            return "\U000F05AA";  // wifi-off
                          }
                          int rssi = (int)id(wifi_signal_db).state;
                          if (rssi >= -50) return "\U000F0928";       // wifi-strength-4 (excellent)
                          else if (rssi >= -60) return "\U000F0925";  // wifi-strength-3 (good)
                          else if (rssi >= -70) return "\U000F0922";  // wifi-strength-2 (fair)
                          else if (rssi >= -80) return "\U000F091F";  // wifi-strength-1 (weak)
                          return "\U000F092F";  // wifi-strength-outline (very weak)

                    # Battery icon
                    - label:
                        id: lbl_battery_status
                        text_font: battery_icons
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (isnan(id(battery_level).state)) return "\U000F0091";  // unknown icon
                          int x = (int)id(battery_level).state;
                          if (x >= 95) return "\U000F0079";
                          else if (x >= 85) return "\U000F0082";
                          else if (x >= 75) return "\U000F0081";
                          else if (x >= 65) return "\U000F0080";
                          else if (x >= 55) return "\U000F007F";
                          else if (x >= 45) return "\U000F007E";
                          else if (x >= 35) return "\U000F007D";
                          else if (x >= 25) return "\U000F007C";
                          else if (x >= 15) return "\U000F007B";
                          else if (x >= 5)  return "\U000F007A";
                          else return "\U000F008E";

                    # Battery percentage text (leftmost)
                    - label:
                        id: lbl_battery_percent
                        text_font: segoeui_16
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (isnan(id(battery_level).state)) return "--%";
                          static char buf[8];
                          snprintf(buf, sizeof(buf), "%d%%", (int)id(battery_level).state);
                          return buf;

        # Weather Section (below status bar)
        - obj:
            id: weather_container
            width: 320
            height: 200
            align: TOP_MID
            x: 0
            y: 35
            pad_all: 10
            widgets:
              - label:
                  id: lbl_weather_icon
                  align: TOP_MID
                  x: 0
                  y: 10
                  text_font: weather_icons
                  text: "\U000F0599"  # Default sunny icon
              
              - label:
                  id: lbl_weather_temp
                  align: TOP_MID
                  x: 0
                  y: 120
                  text_font: segoeui_24
                  text: !lambda |-
                    if (!id(weather_temp).state.empty()) {
                      return id(weather_temp).state.c_str();
                    }
                    return "N/A";
              
              - label:
                  id: lbl_weather_condition
                  align: BOTTOM_MID
                  x: 0
                  y: -5
                  text: !lambda |-
                    if (!id(weather_condition).state.empty()) {
                      return id(weather_condition).state.c_str();
                    }
                    return "Unknown";

        # Fuel Level Arc
        - arc:
            id: arc_fuel
            x: 30
            y: 390
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 75
            widgets:
              - label:
                  align: CENTER
                  text: !lambda |-
                    if (isnan(id(fuel_level).state)) return "--%";
                    static char buf[16];
                    snprintf(buf, sizeof(buf), "%.0f%%", id(fuel_level).state);
                    return buf;
              - label:
                  align: BOTTOM_MID
                  y: 25
                  text: "Fuel"

        # DEF Level Arc
        - arc:
            id: arc_def
            x: 210
            y: 390
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 50
            arc_width: 18
            arc_color: 0x000000
            arc_rounded: true
            indicator:
              arc_color: 0xFFFFFF
              arc_width: 18
            widgets:
              - label:
                  align: CENTER
                  text: !lambda |-
                    if (isnan(id(def_level).state)) return "--%";
                    static char buf[16];
                    snprintf(buf, sizeof(buf), "%.0f%%", id(def_level).state);
                    return buf;
              - label:
                  align: BOTTOM_MID
                  y: 25
                  text: "DEF"

        # Battery Level Arc
        - arc:
            id: arc_battery
            x: 390
            y: 390
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 90
            arc_width: 18
            arc_color: 0x000000
            arc_rounded: false
            indicator:
              arc_color: 0xFFFFFF
              arc_width: 18
            widgets:
              - label:
                  align: CENTER
                  text: !lambda |-
                    if (isnan(id(vehicle_battery).state)) return "--%";
                    static char buf[16];
                    snprintf(buf, sizeof(buf), "%.0f%%", id(vehicle_battery).state);
                    return buf;
              - label:
                  align: BOTTOM_MID
                  y: 25
                  text: "Battery"

# Deep sleep configuration - https://esphome.io/components/deep_sleep/
deep_sleep:
  id: deep_sleep_id
  sleep_duration: ${sleep_duration}
  wakeup_pin:
    number: GPIO3
    ignore_strapping_warning: true

sensor:
  - platform: wifi_signal
    id: wifi_signal_db
    name: "WiFi Signal"
    update_interval: 60s

  - platform: template
    name: "Wakeup Cause"
    accuracy_decimals: 0
    lambda: return esp_sleep_get_wakeup_cause();

  - platform: homeassistant
    id: location_latitude
    entity_id: sensor.location_latitude
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_latitude updated: %.6f", x);

  - platform: homeassistant
    id: location_longitude
    entity_id: sensor.location_longitude
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_longitude updated: %.6f", x);

  - platform: homeassistant
    id: fuel_level
    entity_id: sensor.fuel_level
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fuel_level updated: %.1f%%", x);

  - platform: homeassistant
    id: def_level
    entity_id: sensor.def_level
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "def_level updated: %.1f%%", x);

  - platform: homeassistant
    id: vehicle_battery
    entity_id: sensor.vehicle_battery
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "vehicle_battery updated: %.1f%%", x);

display:
  - id: !extend epaper_display
    auto_clear_enabled: false
    update_interval: never

# Home Assistant sensors for dashboard
text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home
    attribute: condition
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_condition updated: %s", x.c_str());

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home
    attribute: temperature
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_temp updated: %s", x.c_str());

  - platform: homeassistant
    id: location_city
    entity_id: sensor.location_city
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_city updated: %s", x.c_str());

  - platform: homeassistant
    id: location_state
    entity_id: sensor.location_state
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_state updated: %s", x.c_str());
