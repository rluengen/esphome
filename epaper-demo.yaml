# https://jnan.co/tools/esphomelvglsim/

# Dashboard to display home assistant status and weather information.

# https://wikitwist.com/how-to-use-the-seeedstudio-reterminal-e1001-with-home-assistant-via-esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome_advanced/

substitutions:
  device_name: terminal
  friendly_name: "Terminal Display"
  project_version: "1.0.0"
  log_level: DEBUG
  sleep_duration: 1min

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/icons/network_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: packages/icons/weather_icons.yaml
      - path: packages/icons/homeassistant_icons.yaml
      - path: devices/reterminal-e1001.yaml

# Time configuration - Home Assistant primary, SNTP fallback
time:
  - platform: homeassistant
    id: time_entity
    on_time_sync:
      then:
        - logger.log:
            level: INFO
            format: "[TIME] Synchronized with Home Assistant"

  - platform: sntp
    id: time_sntp
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org
    on_time_sync:
      then:
        - logger.log:
            level: INFO
            format: "[TIME] Synchronized with SNTP"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  comment: "Terminal Dashboard Display"
  on_boot:
    priority: -100  # Run after all components are initialized (including SPI)
    then:
      - logger.log:
          level: INFO
          format: "[BOOT] ESPHome on_boot starting (priority -100)"
      - lambda: |-
          int cause = esp_sleep_get_wakeup_cause();
          const char* cause_str;
          switch (cause) {
            case 0: cause_str = "Not from deep sleep"; break;
            case 1: cause_str = "EXT0 (RTC_IO)"; break;
            case 2: cause_str = "EXT1 (RTC_CNTL)"; break;
            case 3: cause_str = "Timer"; break;
            case 4: cause_str = "Touchpad"; break;
            case 5: cause_str = "ULP"; break;
            case 6: cause_str = "GPIO"; break;
            case 7: cause_str = "UART"; break;
            default: cause_str = "Unknown"; break;
          }
          ESP_LOGI("BOOT", "Wakeup cause: %d (%s)", cause, cause_str);
          // Store wakeup cause for use in automations
          id(wakeup_from_sleep) = (cause != 0);
      # - logger.log:
      #     level: INFO
      #     format: "[BOOT] Pausing LVGL"
      # - lvgl.pause:
      - script.execute: update_display
      - logger.log:
          level: INFO
          format: "[BOOT] Boot sequence complete"

logger:
  level: ${log_level}
  baud_rate: 115200
  hardware_uart: UART0

# Globals for state tracking
globals:
  - id: wakeup_from_sleep
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: boot_complete
    type: bool
    restore_value: no
    initial_value: 'false'

# Script to update display - called from boot and interval
script:
  - id: update_display
    mode: single  # Prevent multiple concurrent executions
    then:
      # Wait for API connection so HA sensors are available
      - logger.log:
          level: INFO
          format: "[DISPLAY] Waiting for API connection..."
      - wait_until:
          condition:
            binary_sensor.is_on: api_connected
          timeout: 30s
      - lambda: |-
          if (id(api_connected).state) {
            ESP_LOGI("DISPLAY", "API connected - waiting for sensor data...");
          } else {
            ESP_LOGW("DISPLAY", "API connection timeout - proceeding anyway");
          }
      # Give HA sensors time to populate after API connects
      - delay: 2s
      # Wait for time to be valid (up to 30 seconds)
      - logger.log:
          level: INFO
          format: "[DISPLAY] Waiting for time sync..."
      - wait_until:
          condition:
            lambda: 'return id(time_entity).now().is_valid() || id(time_sntp).now().is_valid();'
          timeout: 30s
      - lambda: |-
          if (id(time_entity).now().is_valid()) {
            ESP_LOGI("DISPLAY", "Time valid from Home Assistant");
          } else if (id(time_sntp).now().is_valid()) {
            ESP_LOGI("DISPLAY", "Time valid from SNTP");
          } else {
            ESP_LOGW("DISPLAY", "Time sync timeout - proceeding anyway");
          }
      - logger.log:
          level: INFO
          format: "[DISPLAY] Enabling battery measurement"
      - output.turn_on: bsp_battery_enable
      - delay: 200ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating battery sensors"
      - component.update: battery_voltage
      - delay: 200ms
      # Wait for battery voltage to be valid
      - wait_until:
          condition:
            lambda: 'return !isnan(id(battery_voltage).state);'
          timeout: 5s
      - lambda: |-
          ESP_LOGI("DISPLAY", "Battery voltage: %.3fV", id(battery_voltage).state);
      - component.update: battery_level
      - delay: 200ms
      - component.update: battery_level
      - delay: 100ms
      - lambda: |-
          ESP_LOGI("DISPLAY", "Sensors - Fuel: %.1f%%, DEF: %.1f%%, Vehicle Battery: %.1f%%, Device Battery: %.0f%% (%.2fV)",
            id(fuel_level).state, id(def_level).state, id(vehicle_battery).state,
            id(battery_level).state, id(battery_voltage).state);
      - logger.log:
          level: INFO
          format: "[DISPLAY] Resuming LVGL"
      - lvgl.resume:
      - delay: 50ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating all widgets"
      # Status bar widgets
      - lvgl.label.update:
          id: lbl_status_location
          text: !lambda |-
            if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
              static char buf[64];
              snprintf(buf, sizeof(buf), "%s, %s", 
                id(location_city).state.c_str(), 
                id(location_state).state.c_str());
              return buf;
            }
            if (!isnan(id(location_latitude).state) && !isnan(id(location_longitude).state)) {
              static char buf[32];
              snprintf(buf, sizeof(buf), "%.4f, %.4f", 
                id(location_latitude).state, 
                id(location_longitude).state);
              return buf;
            }
            return "-- , --";
      - lvgl.label.update:
          id: lbl_status_date
          text: !lambda |-
            auto time = id(time_entity).now();
            if (!time.is_valid()) {
              ESP_LOGI("DISPLAY", "[TIME] time_entity is invalid, falling back to sntp");
              time = id(time_sntp).now();
            }

            if (time.is_valid()) {
              static char buf[40];
              snprintf(buf, sizeof(buf), "%s %s %d, %d", 
                time.strftime("%A").c_str(),
                time.strftime("%B").c_str(),
                time.day_of_month,
                time.year);
              return buf;
            }
            
            ESP_LOGI("DISPLAY", "[TIME] time is invalid");
            return "-- --, ----";
      - lvgl.label.update:
          id: lbl_ha_status
          text: !lambda |-
            if (id(api_connected).state) {
              ESP_LOGI("DISPLAY", "[API] API is connected");
              return "\U000F06A1";
            }
            ESP_LOGI("DISPLAY", "[API] API is not connected");
            return "\U000F0F21";
      - lvgl.label.update:
          id: lbl_wifi_status
          text: !lambda |-
            if (!id(wifi_connected).state) {
              return "\U000F05AA";
            }
            int rssi = (int)id(wifi_signal_db).state;
            if (rssi >= -50) return "\U000F0928";
            else if (rssi >= -60) return "\U000F0925";
            else if (rssi >= -70) return "\U000F0922";
            else if (rssi >= -80) return "\U000F091F";
            return "\U000F092F";
      - lvgl.label.update:
          id: lbl_battery_percent
          text: !lambda |-
            if (isnan(id(battery_level).state)) 
            {
              ESP_LOGI("BATTERY", "Battery percent is invalid");
              return "--%";
            }
            static char buf[8];
            snprintf(buf, sizeof(buf), "%d%%", (int)id(battery_level).state);
            ESP_LOGI("BATTERY", "Setting battery percent label to: '%s'", buf);
            return buf;
      - lvgl.label.update:
          id: lbl_battery_status
          text: !lambda |-
            if (isnan(id(battery_level).state)) {
              ESP_LOGI("BATTERY", "Battery percent is invalid");
              return "\U000F0091";
            }

            ESP_LOGI("BATTERY", "Battery percent: %.1f%%", id(battery_level).state);

            int x = (int)id(battery_level).state;
            if (x >= 95) return "\U000F0079";
            else if (x >= 85) return "\U000F0082";
            else if (x >= 75) return "\U000F0081";
            else if (x >= 65) return "\U000F0080";
            else if (x >= 55) return "\U000F007F";
            else if (x >= 45) return "\U000F007E";
            else if (x >= 35) return "\U000F007D";
            else if (x >= 25) return "\U000F007C";
            else if (x >= 15) return "\U000F007B";
            else if (x >= 5)  return "\U000F007A";
            else return "\U000F008E";
      # Weather widgets
      - lvgl.label.update:
          id: lbl_weather_temp
          text: !lambda |-
            if (!id(weather_temp).state.empty()) {
              return id(weather_temp).state.c_str();
            }
            return "N/A";
      - lvgl.label.update:
          id: lbl_weather_condition
          text: !lambda |-
            if (!id(weather_condition).state.empty()) {
              return id(weather_condition).state.c_str();
            }
            return "Unknown";
      # Sunrise/Sunset widgets
      - lvgl.label.update:
          id: lbl_sunrise_time
          text: !lambda |-
            if (!id(sunrise_time).state.empty()) {
              return id(sunrise_time).state.c_str();
            }
            return "--:--";
      - lvgl.label.update:
          id: lbl_sunset_time
          text: !lambda |-
            if (!id(sunset_time).state.empty()) {
              return id(sunset_time).state.c_str();
            }
            return "--:--";
      # Interior climate widgets
      - lvgl.label.update:
          id: lbl_interior_temp
          text: !lambda |-
            if (isnan(id(interior_temp).state)) return "--°";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.1f°", id(interior_temp).state);
            return buf;
      - lvgl.label.update:
          id: lbl_interior_humidity
          text: !lambda |-
            if (isnan(id(interior_humidity).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(interior_humidity).state);
            return buf;
      - lvgl.label.update:
          id: lbl_fridge_temp
          text: !lambda |-
            if (isnan(id(fridge_temp).state)) return "--°";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.1f°", id(fridge_temp).state);
            return buf;
      # Air quality widgets
      - lvgl.label.update:
          id: lbl_co2_value
          text: !lambda |-
            if (isnan(id(air_co2).state)) return "--ppm";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0fppm", id(air_co2).state);
            return buf;
      - lvgl.label.update:
          id: lbl_pm25_value
          text: !lambda |-
            if (isnan(id(air_pm25).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_pm25).state);
            return buf;
      - lvgl.label.update:
          id: lbl_voc_value
          text: !lambda |-
            if (isnan(id(air_voc).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_voc).state);
            return buf;
      - lvgl.label.update:
          id: lbl_nox_value
          text: !lambda |-
            if (isnan(id(air_nox).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_nox).state);
            return buf;
      # Arc widgets
      - lvgl.label.update:
          id: lbl_fuel_value
          text: !lambda |-
            if (isnan(id(fuel_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(fuel_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_fuel
          value: !lambda 'return isnan(id(fuel_level).state) ? 0 : (int)id(fuel_level).state;'
      - lvgl.label.update:
          id: lbl_def_value
          text: !lambda |-
            if (isnan(id(def_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(def_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_def
          value: !lambda 'return isnan(id(def_level).state) ? 0 : (int)id(def_level).state;'
      - lvgl.label.update:
          id: lbl_vehicle_battery_value
          text: !lambda |-
            if (isnan(id(vehicle_battery).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(vehicle_battery).state);
            return buf;
      - lvgl.arc.update:
          id: arc_battery
          value: !lambda 'return isnan(id(vehicle_battery).state) ? 0 : (int)id(vehicle_battery).state;'
      - lvgl.label.update:
          id: lbl_water_value
          text: !lambda |-
            if (isnan(id(water_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(water_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_water
          value: !lambda 'return isnan(id(water_level).state) ? 0 : (int)id(water_level).state;'
      - logger.log:
          level: INFO
          format: "[DISPLAY] All widgets updated, waiting for LVGL to process..."
      - delay: 100ms  # Give LVGL time to process all updates
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating epaper display"
      - component.update: epaper_display
      - delay: 100ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Disabling battery measurement"
      - output.turn_off: bsp_battery_enable
      - lambda: 'id(boot_complete) = true;'
      - logger.log:
          level: INFO
          format: "[DISPLAY] Update complete"
      - logger.log:
          level: INFO
          format: "[DISPLAY] Pausing LVGL"
      - lvgl.pause:

  - id: page_previous
    mode: single
    then:
      - logger.log:
          level: INFO
          format: "[PAGE] Going to previous page"
      - lvgl.resume:
      - lvgl.page.previous:
          time: 0ms
      - delay: 50ms
      - component.update: epaper_display
      - delay: 100ms
      - lvgl.pause:

  - id: page_next
    mode: single
    then:
      - logger.log:
          level: INFO
          format: "[PAGE] Going to next page"
      - lvgl.resume:
      - lvgl.page.next:
          time: 0ms
      - delay: 50ms
      - component.update: epaper_display
      - delay: 100ms
      - lvgl.pause:

binary_sensor:
  - id: !extend button_left
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Left button pressed - going to previous page"
        - script.execute: page_previous

  - id: !extend button_right
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Right button pressed - going to next page"
        - script.execute: page_next

  - id: !extend button_green
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Green button pressed"

  # API connection status
  - platform: status
    id: api_connected
    name: "API Connected"

  # WiFi connection status (uses template to check if signal exists)
  - platform: template
    id: wifi_connected
    name: "WiFi Connected"
    lambda: |-
      return !isnan(id(wifi_signal_db).state) && id(wifi_signal_db).state < 0;

  # Battery charging status (USB/external power connected)
  # Per Seeed wiki: voltage > 4.5V indicates USB power is connected
  - platform: template
    id: battery_charging
    name: "Battery Charging"
    lambda: |-
      // Returns true if USB/external power is connected
      // When on battery alone, voltage maxes out around 4.15-4.2V
      // When USB is connected, voltage reading exceeds 4.5V
      return !isnan(id(battery_voltage).state) && id(battery_voltage).state > 4.5;

font:
  - file: "fonts/segoeui.ttf"
    id: segoeui_16
    size: 16
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°₂"
  
  - file: "fonts/segoeui.ttf"
    id: segoeui_20
    size: 20
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"
  
  - file: "fonts/segoeui.ttf"
    id: segoeui_24
    size: 24
    bpp: 4
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

  # Small weather icons for sunrise/sunset
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: sun_icons
    size: 24
    bpp: 4
    glyphs: [
      "\U000F059C", # weather-sunset-up (sunrise)
      "\U000F059B", # weather-sunset-down (sunset)
      ]

interval:
  - interval: ${sleep_duration}
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete);'
          then:
            - logger.log:
                level: INFO
                format: "[INTERVAL] Refresh triggered"
            - script.execute: update_display
          else:
            - logger.log:
                level: INFO
                format: "[INTERVAL] Skipped - boot not complete"

lvgl:
  buffer_size: 10%  # Further reduced buffer for e-paper to prevent memory exhaustion
  border_width: 0
  outline_width: 0
  shadow_width: 0
  text_font: segoeui_16
  align: center
  resume_on_input: false  # Don't auto-resume on input - we control rendering manually

  # Style definitions for reusable styling (inverted for e-paper)
  # Note: 7.50inv2 is 2-color only (black/white), no grayscale
  style_definitions:
    - id: style_arc
      arc_width: 18
      arc_color: 0x000000  # Black in LVGL → white on e-paper (unfilled track)
      arc_rounded: true
    - id: style_arc_indicator
      arc_width: 18
      arc_color: 0xFFFFFF  # White in LVGL → black on e-paper (filled portion)

  on_idle:
    timeout: 10s
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_idle triggered (10s timeout)"
      - lambda: |-
          ESP_LOGI("LVGL", "Idle timeout reached - display inactive for 10s");
  
  on_ready:
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_ready - LVGL initialized"
      - lambda: |-
          ESP_LOGI("LVGL", "LVGL ready and initialized");

  on_pause:
    - logger.log:
        level: INFO
        format: "[LVGL] on_pause triggered"
    - lambda: |-
        ESP_LOGI("LVGL", "Battery charging: %s, voltage: %.2fV", 
          id(battery_charging).state ? "YES" : "NO", id(battery_voltage).state);
    - if:
        condition:
          binary_sensor.is_off: battery_charging
        then:
          - logger.log:
              level: INFO
              format: "[LVGL] Not charging - entering deep sleep for ${sleep_duration}"
          - deep_sleep.enter:
              id: deep_sleep_id
              sleep_duration: ${sleep_duration}
        else:
          - logger.log:
              level: INFO
              format: "[LVGL] Charging detected - skipping deep sleep"

  on_resume:
    - logger.log:
        level: INFO
        format: "[LVGL] on_resume - display waking up"
  on_boot:
    - logger.log:
        level: INFO
        format: "[LVGL] on_boot - LVGL starting"

  pages:
    - id: main_page
      bg_color: 0x000000
      scrollbar_mode: "OFF"
      widgets:
        # Status Bar - at top of main page
        - obj:
            id: status_bar
            width: 100%
            height: 30
            align: TOP_MID
            bg_color: 0x000000
            x: 0
            y: 0
            border_width: 0
            radius: 0
            pad_all: 3
            widgets:
              # Left side: Location (lat/long)
              - label:
                  id: lbl_status_location
                  align: LEFT_MID
                  x: 5
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: ""

              # Center: Date
              - label:
                  id: lbl_status_date
                  align: CENTER
                  x: 0
                  y: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "-- --, ----"

              # Right side container with flex layout
              - obj:
                  id: status_icons_container
                  align: RIGHT_MID
                  x: 0
                  y: 0
                  width: SIZE_CONTENT
                  height: 100%
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW_REVERSE
                    flex_align_main: START
                    flex_align_cross: CENTER
                    pad_column: 5
                  widgets:
                    # Home Assistant status (rightmost)
                    - label:
                        id: lbl_ha_status
                        text_font: homeassistant_icons
                        text_color: 0xFFFFFF
                        text: "\U000F0F21"

                    # WiFi status
                    - label:
                        id: lbl_wifi_status
                        text_font: wifi_icons
                        text_color: 0xFFFFFF
                        text: "\U000F05AA"

                    # Battery icon
                    - label:
                        id: lbl_battery_status
                        text_font: battery_icons
                        text_color: 0xFFFFFF
                        text: "\U000F0091"

                    # Battery percentage text (leftmost)
                    - label:
                        id: lbl_battery_percent
                        text_font: segoeui_16
                        text_color: 0xFFFFFF
                        text: "--%"  # Static initial, updated by script

        # Weather Section (below status bar)
        - obj:
            id: weather_container
            width: 320
            height: 200
            align: TOP_MID
            x: 0
            y: 35
            pad_all: 10
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_weather_icon
                  align: TOP_MID
                  x: 0
                  y: 10
                  text_font: weather_icons
                  text_color: 0xFFFFFF
                  text: "\U000F0599"  # Default sunny icon
              
              - label:
                  id: lbl_weather_temp
                  align: TOP_MID
                  x: 0
                  y: 120
                  text_font: segoeui_24
                  text_color: 0xFFFFFF
                  text: "--°"
              
              - label:
                  id: lbl_weather_condition
                  align: BOTTOM_MID
                  x: 0
                  y: -5
                  text_color: 0xFFFFFF
                  text: "Unknown"

        # Sunrise/Sunset Section
        - obj:
            id: sun_container
            width: 300
            height: 30
            align: TOP_MID
            x: 0
            y: 205
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_sunrise_icon
                  align: LEFT_MID
                  x: 0
                  text_font: sun_icons
                  text_color: 0xFFFFFF
                  text: "\U000F059C"  # mdi:weather-sunset-up
              - label:
                  id: lbl_sunrise_time
                  align: LEFT_MID
                  x: 30
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--:--"
              - label:
                  id: lbl_sunset_icon
                  align: RIGHT_MID
                  x: -70
                  text_font: sun_icons
                  text_color: 0xFFFFFF
                  text: "\U000F059B"  # mdi:weather-sunset-down
              - label:
                  id: lbl_sunset_time
                  align: RIGHT_MID
                  x: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--:--"

        # Interior Climate Section
        - obj:
            id: interior_container
            width: 600
            height: 50
            align: TOP_MID
            x: 0
            y: 240
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_interior_label
                  align: LEFT_MID
                  x: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "Interior:"
              - label:
                  id: lbl_interior_temp
                  align: LEFT_MID
                  x: 80
                  text_font: segoeui_20
                  text_color: 0xFFFFFF
                  text: "--°"
              - label:
                  id: lbl_interior_humidity
                  align: LEFT_MID
                  x: 150
                  text_font: segoeui_20
                  text_color: 0xFFFFFF
                  text: "--%"
              - label:
                  id: lbl_fridge_label
                  align: RIGHT_MID
                  x: -120
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "Fridge:"
              - label:
                  id: lbl_fridge_temp
                  align: RIGHT_MID
                  x: 0
                  text_font: segoeui_20
                  text_color: 0xFFFFFF
                  text: "--°"

        # Air Quality Section
        - obj:
            id: air_quality_container
            width: 700
            height: 30
            align: TOP_MID
            x: 0
            y: 270
            bg_opa: TRANSP
            border_width: 0
            widgets:
              - label:
                  id: lbl_co2_label
                  align: LEFT_MID
                  x: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "CO₂:"
              - label:
                  id: lbl_co2_value
                  align: LEFT_MID
                  x: 45
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--ppm"
              - label:
                  id: lbl_pm25_label
                  align: LEFT_MID
                  x: 140
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "PM2.5:"
              - label:
                  id: lbl_pm25_value
                  align: LEFT_MID
                  x: 200
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--"
              - label:
                  id: lbl_voc_label
                  align: RIGHT_MID
                  x: -200
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "VOC:"
              - label:
                  id: lbl_voc_value
                  align: RIGHT_MID
                  x: -150
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--"
              - label:
                  id: lbl_nox_label
                  align: RIGHT_MID
                  x: -80
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "NOx:"
              - label:
                  id: lbl_nox_value
                  align: RIGHT_MID
                  x: 0
                  text_font: segoeui_16
                  text_color: 0xFFFFFF
                  text: "--"
  
        # Fuel Level Arc
        - arc:
            id: arc_fuel
            x: 20
            y: 300
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 75
            styles: style_arc
            indicator:
              styles: style_arc_indicator
            widgets:
              - label:
                  id: lbl_fuel_value
                  align: CENTER
                  text_font: segoeui_24
                  text_color: 0xFFFFFF
                  text: "-- %"
              - label:
                  id: lbl_fuel_label
                  align: BOTTOM_MID
                  y: -5
                  text_color: 0xFFFFFF
                  text: "Fuel"

        # DEF Level Arc
        - arc:
            id: arc_def
            x: 180
            y: 300
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 75
            styles: style_arc
            indicator:
              styles: style_arc_indicator
            widgets:
              - label:
                  id: lbl_def_value
                  align: CENTER
                  text_font: segoeui_24
                  text_color: 0xFFFFFF
                  text: !lambda |-
                    if (isnan(id(def_level).state)) return "--%";
                    static char buf[16];
                    snprintf(buf, sizeof(buf), "%.0f%%", id(def_level).state);
                    return buf;
              - label:
                  id: lbl_def_label
                  align: BOTTOM_MID
                  y: -5
                  text_color: 0xFFFFFF
                  text: "DEF"

        # Battery Level Arc
        - arc:
            id: arc_battery
            x: 340
            y: 300
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 75
            styles: style_arc
            indicator:
              styles: style_arc_indicator
            widgets:
              - label:
                  id: lbl_vehicle_battery_value
                  align: CENTER
                  text_font: segoeui_24
                  text_color: 0xFFFFFF
                  text: !lambda |-
                    if (isnan(id(vehicle_battery).state)) return "--%";
                    static char buf[16];
                    snprintf(buf, sizeof(buf), "%.0f%%", id(vehicle_battery).state);
                    return buf;
              - label:
                  id: lbl_vehicle_battery_label
                  align: BOTTOM_MID
                  y: -5
                  text_color: 0xFFFFFF
                  text: "Battery"

        # Water Level Arc
        - arc:
            id: arc_water
            x: 500
            y: 300
            width: 150
            height: 150
            start_angle: 135
            end_angle: 45
            rotation: 0
            min_value: 0
            max_value: 100
            value: 0
            styles: style_arc
            indicator:
              styles: style_arc_indicator
            widgets:
              - label:
                  id: lbl_water_value
                  align: CENTER
                  text_font: segoeui_24
                  text_color: 0xFFFFFF
                  text: "--%"
              - label:
                  id: lbl_water_label
                  align: BOTTOM_MID
                  y: -5
                  text_color: 0xFFFFFF
                  text: "Water"

# Deep sleep configuration - https://esphome.io/components/deep_sleep/
# Note: GPIO3 wakeup disabled due to false triggers - using timer only
deep_sleep:
  id: deep_sleep_id
  sleep_duration: ${sleep_duration}

sensor:
  # Override battery sensors to use manual updates only
  - id: !extend battery_voltage
    update_interval: never

  - id: !extend battery_level
    update_interval: never

  - platform: wifi_signal
    id: wifi_signal_db
    name: "WiFi Signal"
    update_interval: 60s

  - platform: template
    name: "Wakeup Cause"
    accuracy_decimals: 0
    lambda: return esp_sleep_get_wakeup_cause();

  - platform: homeassistant
    id: location_latitude
    entity_id: sensor.location_latitude
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_latitude updated: %.6f", x);

  - platform: homeassistant
    id: location_longitude
    entity_id: sensor.location_longitude
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_longitude updated: %.6f", x);

  - platform: homeassistant
    id: fuel_level
    entity_id: sensor.fuel_level
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fuel_level updated: %.1f%%", x);

  - platform: homeassistant
    id: def_level
    entity_id: sensor.def_level
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "def_level updated: %.1f%%", x);

  - platform: homeassistant
    id: vehicle_battery
    entity_id: sensor.vehicle_battery
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "vehicle_battery updated: %.1f%%", x);

  - platform: homeassistant
    id: interior_temp
    entity_id: sensor.interior_temperature  # Change to your actual entity_id
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "interior_temp updated: %.1f", x);

  - platform: homeassistant
    id: interior_humidity
    entity_id: sensor.interior_humidity  # Change to your actual entity_id
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "interior_humidity updated: %.1f%%", x);

  - platform: homeassistant
    id: air_co2
    entity_id: sensor.air_quality_co2  # TODO: Change to your actual CO2 entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_co2 updated: %.0f ppm", x);

  - platform: homeassistant
    id: air_pm25
    entity_id: sensor.air_quality_pm25  # TODO: Change to your actual PM2.5 entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_pm25 updated: %.0f", x);

  - platform: homeassistant
    id: air_voc
    entity_id: sensor.air_quality_voc  # TODO: Change to your actual VOC entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_voc updated: %.0f", x);

  - platform: homeassistant
    id: air_nox
    entity_id: sensor.air_quality_nox  # TODO: Change to your actual NOx entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_nox updated: %.0f", x);

  - platform: homeassistant
    id: fridge_temp
    entity_id: sensor.fridge_temperature  # TODO: Change to your actual fridge temp entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fridge_temp updated: %.1f", x);

  - platform: homeassistant
    id: water_level
    entity_id: sensor.water_level  # TODO: Change to your actual water level entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "water_level updated: %.1f%%", x);

display:
  - id: !extend epaper_display
    auto_clear_enabled: false
    update_interval: never

# Home Assistant sensors for dashboard
text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home
    attribute: condition
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_condition updated: %s", x.c_str());

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home
    attribute: temperature
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_temp updated: %s", x.c_str());

  - platform: homeassistant
    id: location_city
    entity_id: sensor.location_city
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_city updated: %s", x.c_str());

  - platform: homeassistant
    id: location_state
    entity_id: sensor.location_state
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_state updated: %s", x.c_str());

  - platform: homeassistant
    id: sunrise_time
    entity_id: sensor.sun_next_rising  # TODO: Change to your actual sunrise entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "sunrise_time updated: %s", x.c_str());

  - platform: homeassistant
    id: sunset_time
    entity_id: sensor.sun_next_setting  # TODO: Change to your actual sunset entity
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "sunset_time updated: %s", x.c_str());
