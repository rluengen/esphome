# https://jnan.co/tools/esphomelvglsim/

# Dashboard to display home assistant status and weather information.

# https://wikitwist.com/how-to-use-the-seeedstudio-reterminal-e1001-with-home-assistant-via-esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome_advanced/

substitutions:
  device_name: terminal
  friendly_name: "Terminal Display"
  project_version: "1.0.0"
  log_level: INFO

  run_duration: 30s
  sleep_duration: 60s

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: packages/icons/network_icons.yaml
#      - path: packages/icons/weather_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: packages/icons/homeassistant_icons.yaml
      - path: devices/reterminal-e1001.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 150ms
      - component.update: battery_voltage
      - component.update: battery_level
      - lvgl.resume:  # Resume LVGL in case it was paused during deep sleep

      # Disable deep sleep when powered, allow it when on battery
      - if:
          condition:
            binary_sensor.is_on: is_powered
          then:
            - deep_sleep.prevent: deep_sleep_1
          else:
            - deep_sleep.allow: deep_sleep_1

sensor:
  - id: !extend battery_voltage
    on_value:
      then:
        - lambda: |-
            const bool powered = !isnan(id(battery_voltage).state) && id(battery_voltage).state > 4.5; // threshold
            id(is_powered).publish_state(powered);

  - id: !extend battery_level
    on_value:
      - lvgl.label.update:
          id: lbl_battery_status
          text: !lambda |-
            static char buf[10];
            std::string icon;
            if (x == 100.0) {
                icon = "\U000F0079"; // mdi-battery (full)
            } else if (x > 90) {
                icon = "\U000F0082"; // mdi-battery-90
            } else if (x > 80) {
                icon = "\U000F0081"; // mdi-battery-80
            } else if (x > 70) {
                icon = "\U000F0080"; // mdi-battery-70
            } else if (x > 60) {
                icon = "\U000F007F"; // mdi-battery-60
            } else if (x > 50) {
                icon = "\U000F007E"; // mdi-battery-50
            } else if (x > 40) {
                icon = "\U000F007D"; // mdi-battery-40
            } else if (x > 30) {
                icon = "\U000F007C"; // mdi-battery-30
            } else if (x > 20) {
                icon = "\U000F007B"; // mdi-battery-20
            } else if (x > 10) {
                icon = "\U000F007A"; // mdi-battery-10
            } else if (x > 0) {
                icon = "\U000F008E"; // mdi-battery-outline
            } else {
                icon = "\U000F0091"; // mdi-battery-unknown
            }
            snprintf(buf, sizeof(buf), "%s", icon.c_str());
            return buf;

binary_sensor:
  # Powered (USB/charger) vs battery
  - platform: template
    id: is_powered
    internal: true
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: is_powered
            then:
              - deep_sleep.prevent: deep_sleep_1
              - lvgl.widget.show: lbl_battery_power_cord
            else:
              - deep_sleep.allow: deep_sleep_1
              - lvgl.widget.hide: lbl_battery_power_cord

  - id: !extend button_left
    on_press:
      then:
        - lvgl.page.previous:
            time: 0ms

  - id: !extend button_right
    on_press:
      then:
        - lvgl.page.next:
            time: 0ms

  - id: !extend button_green
    on_press:
      then:
        - light.turn_on: onboard_led
        - delay: 500ms
        - light.turn_off: onboard_led

# Deep sleep configuration - https://esphome.io/components/deep_sleep/
deep_sleep:
  id: deep_sleep_1
  run_duration: ${run_duration}
  sleep_duration: ${sleep_duration}

  # Use the green button (GPIO3) to wake from sleep - no separate wakeup_pin needed
  # since the button is already defined in the device package

api:
  on_client_connected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - logger.log: "Home Assistant connected"
          - script.execute: set_ha_connected
  on_client_disconnected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - logger.log: "Home Assistant disconnected"
          - script.execute: set_ha_disconnected

# WiFi status monitoring  
wifi:
  on_connect:
    - script.execute: set_wifi_connected
  on_disconnect:
    - script.execute: set_wifi_disconnected

# Display configuration
display:
  - id: !extend epaper_display
    auto_clear_enabled: false
    update_interval: never
    dimensions: !remove

# Regular display updates when not in deep sleep
interval:
  - interval: 5min  # Update every 5 minutes when powered
    then:
      - if:
          condition:
            binary_sensor.is_on: is_powered  # Only update when powered (not on battery)
          then:
            - logger.log: "Regular display update (powered mode)"
            - script.execute: redraw_display

script:
  # Global status variables - these will be updated by WiFi/API callbacks
  - id: update_wifi_status
    then:
      - lvgl.label.update:
          id: lbl_wifi_status
          text: "üì∂" # Will be updated by WiFi callbacks

  - id: update_ha_status  
    then:
      - lvgl.label.update:
          id: lbl_ha_status
          text: "üè†" # Will be updated by API callbacks
          
  - id: set_wifi_connected
    then:
      - lvgl.label.update:
          id: lbl_wifi_status
          text: !lambda |-
            std::string icon;
            if (!isnan(id(wifi_rssi).state))
            {
              float r = id(wifi_rssi).state;
              if      (r > -55) icon = "\U000F0928"; // wifi-strength-4
              else if (r > -65) icon = "\U000F0925"; // wifi-strength-3
              else if (r > -72) icon = "\U000F0922"; // wifi-strength-2
              else if (r > -80) icon = "\U000F091F"; // wifi-strength-1
              else              icon = "\U000F091F"; // wifi-strength-0
            }
 
            snprintf(buf, sizeof(buf), "%s", icon.c_str());
            return buf;

  - id: set_wifi_disconnected
    then:
      - lvgl.label.update:
          id: lbl_wifi_status
          text: "üìµ" # No WiFi
          
  - id: set_ha_connected
    then:
      - lvgl.label.update:
          id: lbl_ha_status
          text: "üè†" # HA connected
          
  - id: set_ha_disconnected
    then:
      - lvgl.label.update:
          id: lbl_ha_status
          text: "üîå" # HA disconnected

  - id: update_battery_icon
    then:
      - lvgl.label.update:
          id: lbl_battery_status
          text: !lambda |-
            static char buf[10];
            std::string icon;
            if (x == 100.0) {
              icon = "\U000F0079"; // mdi-battery (full)
            } else if (x > 90) {
              icon = "\U000F0082"; // mdi-battery-90
            } else if (x > 80) {
              icon = "\U000F0081"; // mdi-battery-80
            } else if (x > 70) {
              icon = "\U000F0080"; // mdi-battery-70
            } else if (x > 60) {
              icon = "\U000F007F"; // mdi-battery-60
            } else if (x > 50) {
              icon = "\U000F007E"; // mdi-battery-50
            } else if (x > 40) {
              icon = "\U000F007D"; // mdi-battery-40
            } else if (x > 30) {
              icon = "\U000F007C"; // mdi-battery-30
            } else if (x > 20) {
              icon = "\U000F007B"; // mdi-battery-20
            } else if (x > 10) {
              icon = "\U000F007A"; // mdi-battery-10
            } else if (x > 0) {
              icon = "\U000F008E"; // mdi-battery-outline
            } else {
              icon = "\U000F0091"; // mdi-battery-unknown
            }
            snprintf(buf, sizeof(buf), "%s", icon.c_str());
            return buf;

  - id: redraw_display
    then:
      - lvgl.resume:  # Ensure LVGL is active
      - script.execute: update_wifi_status
      - script.execute: update_ha_status  
      - script.execute: update_battery_icon
#      - lvgl.label.update: temperature_label
#      - lvgl.label.update: humidity_label
      - component.update: epaper_display

# https://esphome.io/components/lvgl/
lvgl:
# https://esphome.io/cookbook/lvgl/#turn-off-screen-when-idle
  on_idle:
    timeout: 60s
    then:
      - logger.log: "LVGL is idle"
      - lvgl.pause:
      
  on_ready:
    then:
      - logger.log: "LVGL ready - updating display"
      - component.update: epaper_display

  on_pause:
    then:
      - if:
          condition:
            lambda: 'return !id(is_powered).state;'  # only sleep on battery
          then:
            - logger.log: "Entering deep sleep due to idle on battery"
            - deep_sleep.enter:
                id: deep_sleep_1
                sleep_duration: 60s

  on_resume:
    then:
      - script.execute: redraw_display

  on_boot:
    then:
      - logger.log: "LVGL booted"
      - script.execute: redraw_display

  widgets:
    # Header container spanning the top of the display
    - obj:
        id: header_container
        width: 100%
        height: 40
        align: TOP_MID
        x: 0
        y: 0
        bg_color: 0x000000
        border_width: 0
        pad_all: 5
        widgets:
          # WiFi status (right side, leftmost)
          - label:
              id: lbl_wifi_status
              align: TOP_RIGHT
              x: -120
              y: 5
              text: "\U000F092F"
              text_font: wifi_icons
              text_color: 0xFFFFFF
              
          # Home Assistant status (right side, second from left)
          - label:
              id: lbl_ha_status
              align: TOP_RIGHT
              x: -90
              y: 5
              text: "üè†"
              text_font: battery_icons
              text_color: 0xFFFFFF
              
          # Battery power cord (right side, second from right)
          - label:
              id: lbl_battery_power_cord
              align: TOP_RIGHT
              x: -40
              y: 5
              text: "‚ö°"
              text_font: battery_icons
              text_color: 0xFFFFFF
              hidden: true  # Initially hidden
              
          # Battery status (rightmost)
          - label:
              id: lbl_battery_status
              align: TOP_RIGHT
              x: -10
              y: 5
              text: "\U000F0091"
              text_font: battery_icons
              text_color: 0xFFFFFF      