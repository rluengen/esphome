# Dashboard to display home assistant status and weather information.

# https://wikitwist.com/how-to-use-the-seeedstudio-reterminal-e1001-with-home-assistant-via-esphome/

substitutions:
  device_name: terminal
  friendly_name: "Terminal Display"
  project_version: "1.0.0"

  run_duration: 30s
  sleep_duration: 60s

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/reterminal-e1001.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 150ms
      - component.update: battery_voltage
      - component.update: battery_level
  
      # Disable deep sleep when powered, allow it when on battery
      - if:
          condition:
            binary_sensor.is_on: is_powered
          then:
            - deep_sleep.prevent: deep_sleep_1
          else:
            - deep_sleep.allow: deep_sleep_1

sensor:
  - id: !extend battery_voltage
    on_value:
      then:
        - lambda: |-
            const bool powered = !isnan(id(vbus_sense).state) && id(vbus_sense).state > 4.5; // threshold
            id(is_powered).publish_state(powered);

  - id: !extend battery_level
    on_value:
      - lvgl.label.update:
          id: lbl_battery_status
          text: !lambda |-
            static char buf[10];
            std::string icon;
            if (x == 100.0) {
                icon = "\U000F0079"; // mdi-battery (full)
            } else if (x > 90) {
                icon = "\U000F0082"; // mdi-battery-90
            } else if (x > 80) {
                icon = "\U000F0081"; // mdi-battery-80
            } else if (x > 70) {
                icon = "\U000F0080"; // mdi-battery-70
            } else if (x > 60) {
                icon = "\U000F007F"; // mdi-battery-60
            } else if (x > 50) {
                icon = "\U000F007E"; // mdi-battery-50
            } else if (x > 40) {
                icon = "\U000F007D"; // mdi-battery-40
            } else if (x > 30) {
                icon = "\U000F007C"; // mdi-battery-30
            } else if (x > 20) {
                icon = "\U000F007B"; // mdi-battery-20
            } else if (x > 10) {
                icon = "\U000F007A"; // mdi-battery-10
            } else if (x > 0) {
                icon = "\U000F008E"; // mdi-battery-outline
            } else {
                icon = "\U000F0091"; // mdi-battery-unknown
            }
            snprintf(buf, sizeof(buf), "%s", icon.c_str());
            return buf;


binary_sensor:
  # Powered (USB/charger) vs battery
  - platform: template
    id: is_powered
    internal: true
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: is_powered
            then:
              - deep_sleep.prevent: deep_sleep_1
              - lvgl.widget.show: battery_power_cord
            else:
              - deep_sleep.allow: deep_sleep_1
              - lvgl.widget.hide: battery_power_cord

  - id: !extend button_left
    on_press:
      then:
      # turn to the previous page?
        - light.toggle: onboard_led

  - id: !extend button_right
    on_press:
      then:
      # turn to the next page?

        - light.turn_on: onboard_led
        - delay: 200ms
        - light.turn_off: onboard_led
        - delay: 200ms
        - light.turn_on: onboard_led
        - delay: 200ms
        - light.turn_off: onboard_led

  - id: !extend button_green
    on_press:
      then:
        - light.turn_on: onboard_led
        - delay: 500ms
        - light.turn_off: onboard_led

# Deep sleep configuration - https://esphome.io/components/deep_sleep/
deep_sleep:
  id: deep_sleep_1
  run_duration: ${run_duration}
  sleep_duration: ${sleep_duration}

  # Optional: Use a button to wake from sleep
  wakeup_pin: GPIO3         # Green button
  wakeup_pin_mode: INVERT_WAKEUP

font:
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: battery_icons_20
    size: 20
    bpp: 4
    glyphs: [
      "\U000F007A", # mdi-battery-10
      "\U000F007B", # mdi-battery-20
      "\U000F007C", # mdi-battery-30
      "\U000F007D", # mdi-battery-40
      "\U000F007E", # mdi-battery-50
      "\U000F007F", # mdi-battery-60
      "\U000F0080", # mdi-battery-70
      "\U000F0081", # mdi-battery-80
      "\U000F0082", # mdi-battery-90
      "\U000F0079", # mdi-battery (full)
      "\U000F008E", # mdi-battery-outline
      "\U000F0091", # mdi-battery-unknown
      ]

# https://esphome.io/cookbook/lvgl/#weather-forecast-panel
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: weather_icons
    size: 100
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      "\U000F14E4", # sunny-off
      ]

api:
  on_client_connected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.widget.show: lbl_hastatus
  on_client_disconnected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - lvgl.widget.hide: lbl_hastatus

number:
  - platform: template
    name: LVGL Screen timeout
    optimistic: true
    id: display_timeout
    unit_of_measurement: "s"
    initial_value: 45
    restore_value: true
    min_value: 10
    max_value: 180
    step: 5
    mode: box

display:
  - id: !extend epaper_display
    auto_clear_enabled: false
    update_interval: never

# https://esphome.io/components/lvgl/
lvgl:
# https://esphome.io/cookbook/lvgl/#turn-off-screen-when-idle
  on_idl:
    timeout: !lambda "return (id(display_timeout).state * 1000);"
    then:
      - logger.log: "LVGL is idle"
  # todo: deep sleep now, wake up time should be to the next minute? or 10 minutes?
      - light.turn_off: display_backlight
      - lvgl.pause:

  widgets:
    - label:
        id: lbl_battery_status
        align: TOP_RIGHT
        y: 40
        x: -10
        text_font: battery_icons_20
        text: "\U000F0091" # start with mdi-battery-unknown

    - label:
        id: lbl_battery_power_cord      