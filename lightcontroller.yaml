# The Van Light Controller leverages the QuinLED An-Penta-Deca hardware platform to provide
# interior and exterior lighting in the van. It features 15 individually controllable LED channels,
# controlling various lights such as roof lights, capsule lights, and rear lights.

substitutions:
  device_name: led-van-controller
  friendly_name: Light Controller
  project_name: van-light-controller
  project_version: "1.0.0"
  log_level: DEBUG
  default_transition: 500ms

# added for debugging
web_server:
  port: 80

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/quinled-an-penta-deca.yaml
      - path: i2c/pcf8574.yaml
      - path: packages/wizmote.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}
  on_boot:
    priority: 600
    then:
      - lambda: |-
          int reason = esp_reset_reason();
          const char* reason_str;
          switch(reason) {
            case 1: reason_str = "POWERON (normal boot)"; break;
            case 2: reason_str = "EXTERNAL RESET"; break;
            case 3: reason_str = "SOFTWARE RESET"; break;
            case 4: reason_str = "PANIC/EXCEPTION - CRASH!"; break;
            case 5: reason_str = "INTERRUPT WATCHDOG - CRASH!"; break;
            case 6: reason_str = "TASK WATCHDOG - CRASH!"; break;
            case 7: reason_str = "WATCHDOG - CRASH!"; break;
            case 8: reason_str = "DEEPSLEEP RESET"; break;
            case 9: reason_str = "BROWNOUT - POWER ISSUE!"; break;
            case 10: reason_str = "SDIO RESET"; break;
            default: reason_str = "UNKNOWN"; break;
          }
          ESP_LOGW("boot", "ESP32 boot reason: %s (code %d)", reason_str, reason);

globals:
  - id: current_color_temp
    type: float
    restore_value: no
    initial_value: '4000.0'
    
  - id: current_brightness
    type: float
    restore_value: no
    initial_value: '1.0'
  
  - id: button_1_loop_count
    type: int
    restore_value: no
    initial_value: '0'

  - id: button_2_loop_count
    type: int
    restore_value: no
    initial_value: '0'
  
  - id: button_3_loop_count
    type: int
    restore_value: no
    initial_value: '0'

  - id: button_4_loop_count
    type: int
    restore_value: no
    initial_value: '0'
  
  - id: pcf8574_button_5_loop_count
    type: int
    restore_value: no
    initial_value: '0'
  
  - id: pcf8574_button_5_initial_brightness
    type: float
    restore_value: no
    initial_value: '0.0'

sensor:
  - platform: homeassistant
    name: "Sun Elevation"
    id: sun_elevation
    entity_id: sun.sun
    attribute: elevation
    unit_of_measurement: "°"
    accuracy_decimals: 2
    internal: true
    on_value:
      then:
        - if:
            condition:
              lambda: 'return !isnan(x);'
            then:
              - script.execute: adjust_light_color_temperature
            else:
              - logger.log: "[Light Controller] Sun elevation is NaN - skipping color temp adjustment"

# Channel       Description
# ------        ----
# 1             Cabin Can Lights (x4)
# 2             Bed Can Lights (x4)
# 3             Sliding Door Light Strip
# 4             Dog Crate Light Strip (warm)
# 5             Dog Crate Light Strip (cold)
# 6             Garage Light Strip
# 7             Capsule Light Strip (Warm)
# 8             Capsule Light Strip (Cool)
# 9             Awning Outside Light Strip
# 10            Awning Inside Light Strip
# 11            Exterior Capsule Driver Flood Light
# 12            Exterior Capsule Passenger Flood Light
# 13            Roof Passenger Flood Lights
# 14            Roof Driver Flood Lights
# 15            Roof Rear Flood Lights
light:
  - platform: monochromatic
    id: main_can_lights
    name: "Main Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: ${default_transition}
    output: led_channel_1

  - platform: monochromatic
    id: bed_can_lights
    name: "Bed Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: ${default_transition}
    output: led_channel_2

  - platform: monochromatic
    id: door_light
    name: "Door Light"
    icon: "mdi:door_light"
    default_transition_length: ${default_transition}
    output: led_channel_3

  - platform: cwww
    cold_white: led_channel_4
    warm_white: led_channel_5
    id: cwww_led_dog_crate_lights
    name: "Dog Crate Lights"
    icon: "mdi:led-strip"
    default_transition_length: ${default_transition}
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: garage_led_lights
    name: "Garage LED Light"
    default_transition_length: ${default_transition}
    output: led_channel_6

  - platform: cwww
    cold_white: led_channel_7
    warm_white: led_channel_8
    id: cwww_led_capsule_lights
    name: "Bed Capsule Lights"
    icon: "mdi:led-strip"
    default_transition_length: ${default_transition}
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: light_awning_outside_light
    name: "Awning Outside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: ${default_transition}
    output: led_channel_9

  - platform: monochromatic
    id: light_awning_inside_light
    name: "Awning Inside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: ${default_transition}
    output: led_channel_10

  - platform: monochromatic
    id: light_exterior_passenger_capsule
    name: "Exterior Capsule Passenger Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: ${default_transition}
    output: led_channel_11

  - platform: monochromatic
    id: light_exterior_driver_capsule
    name: "Exterior Capsule Driver Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: ${default_transition}
    output: led_channel_12

  - platform: monochromatic
    id: light_exterior_roof_passenger
    name: "Exterior Roof Passenger Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: ${default_transition}
    output: led_channel_13

  - platform: monochromatic
    id: light_exterior_roof_driver
    name: "Exterior Roof Driver Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: ${default_transition}
    output: led_channel_14

  - platform: monochromatic
    id: light_exterior_roof_rear
    name: "Exterior Roof Rear Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: ${default_transition}
    output: led_channel_15

script:
  - id: adjust_light_color_temperature
    mode: restart
    then:
      - logger.log:
          format: "Script: adjust_light_color_temperature called"
          level: INFO
      - lambda: |-
          // Calculate color temperature based on sun elevation
          float elevation = id(sun_elevation).state;
          
          if (isnan(elevation)) {
            ESP_LOGW("color_temp", "Sun elevation is NaN - skipping color temp adjustment");
            return;
          }

          // Map elevation to color temperature (2700K warm to 6500K cool)
          if (elevation > 0) {
            // Daytime: 0° to 90° elevation
            id(current_color_temp) = 4000 + (elevation / 90.0) * 2500;
            id(current_brightness) = 0.8 + (elevation / 90.0) * 0.2;
          } else if (elevation > -6) {
            // Civil twilight: 0° to -6° (golden hour)
            id(current_color_temp) = 3000 + ((elevation + 6) / 6.0) * 1000;
            id(current_brightness) = 0.6 + ((elevation + 6) / 6.0) * 0.2;
          } else if (elevation > -12) {
            // Nautical twilight: -6° to -12°
            id(current_color_temp) = 2700 + ((elevation + 12) / 6.0) * 300;
            id(current_brightness) = 0.4 + ((elevation + 12) / 6.0) * 0.2;
          } else {
            // Night: < -12° elevation
            id(current_brightness) = 0.3;
            id(current_color_temp) = 2700;
          }

          // Apply color temperature if auto color temp is enabled
          if (id(auto_color_temp_enabled).state) {
            if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
              auto call = id(cwww_led_dog_crate_lights).turn_on();
              call.set_color_temperature(id(current_color_temp));
              if (id(auto_brightness_enabled).state) call.set_brightness(id(current_brightness));
              call.perform();
            }
            
            if (id(cwww_led_capsule_lights).current_values.is_on()) {
              auto call = id(cwww_led_capsule_lights).turn_on();
              call.set_color_temperature(id(current_color_temp));
              if (id(auto_brightness_enabled).state) call.set_brightness(id(current_brightness));
              call.perform();
            }
          } else if (id(auto_brightness_enabled).state) {
            // Only auto brightness, no color temp
            if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
              auto call = id(cwww_led_dog_crate_lights).turn_on();
              call.set_brightness(id(current_brightness));
              call.perform();
            }
            if (id(cwww_led_capsule_lights).current_values.is_on()) {
              auto call = id(cwww_led_capsule_lights).turn_on();
              call.set_brightness(id(current_brightness));
              call.perform();
            }
          }

          ESP_LOGD("color_temp", "Elevation: %.1f°, Color Temp: %.0fK, Brightness: %.0f%%", 
                 elevation, id(current_color_temp), id(current_brightness) * 100);
         
  - id: turn_off_exterior_flood_lights
    then:
      - logger.log:
          format: "Script: turn_off_exterior_flood_lights called"
          level: INFO
      - light.turn_off: light_exterior_roof_rear
      - light.turn_off: light_exterior_roof_driver
      - light.turn_off: light_exterior_roof_passenger
      - light.turn_off: light_exterior_passenger_capsule
      - light.turn_off: light_exterior_driver_capsule
  
  - id: turn_on_exterior_flood_lights
    then:
      - logger.log:
          format: "Script: turn_on_exterior_flood_lights called"
          level: INFO
      - if:
          condition:
            lambda: 'return id(sun_elevation).state < id(exterior_light_sun_threshold).state;'
          then:
            - light.turn_on: 
                id: light_exterior_roof_rear
                brightness: 100%
            - light.turn_on:
                id: light_exterior_roof_driver
                brightness: 100%
            - light.turn_on:
                id: light_exterior_roof_passenger
                brightness: 100%
            - light.turn_on:
                id: light_exterior_passenger_capsule
                brightness: 100%
            - light.turn_on:
                id: light_exterior_driver_capsule
                brightness: 100%
          else:
            - logger.log: "Exterior lights not turned on - it's daytime"

  - id: toggle_exterior_flood_lights
    then:
      - logger.log:
          format: "Script: toggle_exterior_flood_lights called"
          level: INFO
      - if:
          condition:
            and:
              - light.is_off: light_exterior_roof_rear
              - light.is_off: light_exterior_roof_driver
              - light.is_off: light_exterior_roof_passenger
              - light.is_off: light_exterior_passenger_capsule
              - light.is_off: light_exterior_driver_capsule
          then:
            - script.execute: turn_on_exterior_flood_lights
          else:
            - script.execute: turn_off_exterior_flood_lights
  
  # Extensible entry point for turning on lights - may include exterior lights in the future
  - id: turn_on_lights
    then:
      - logger.log:
          format: "Script: turn_on_lights called"
          level: INFO
      - script.execute: turn_on_interior_lights

  - id: turn_off_lights
    then:
      - logger.log:
          format: "Script: turn_off_lights called"
          level: INFO
      - script.execute: turn_off_exterior_flood_lights
      - script.execute: turn_off_interior_lights
      - light.turn_off: garage_led_lights
      - light.turn_off: light_awning_outside_light
      - light.turn_off: light_awning_inside_light

  - id: turn_on_interior_lights
    then:
      - logger.log:
          format: "Script: turn_on_interior_lights called"
          level: INFO
      - light.turn_on:
          id: main_can_lights
          brightness: 100%
      - light.turn_on: 
          id: bed_can_lights
          brightness: 100%
      # door_light intentionally omitted - not turned on with all interior lights
      - lambda: |-
          if (id(auto_color_temp_enabled).state) {
            auto call = id(cwww_led_dog_crate_lights).turn_on();
            call.set_color_temperature(id(current_color_temp));
            if (id(auto_brightness_enabled).state) call.set_brightness(id(current_brightness));
            call.perform();
          } else if (id(auto_brightness_enabled).state) {
            auto call = id(cwww_led_dog_crate_lights).turn_on();
            call.set_brightness(id(current_brightness));
            call.perform();
          } else {
            id(cwww_led_dog_crate_lights).turn_on().perform();
          }
      - lambda: |-
          if (id(auto_color_temp_enabled).state) {
            auto call = id(cwww_led_capsule_lights).turn_on();
            call.set_color_temperature(id(current_color_temp));
            if (id(auto_brightness_enabled).state) call.set_brightness(id(current_brightness));
            call.perform();
          } else if (id(auto_brightness_enabled).state) {
            auto call = id(cwww_led_capsule_lights).turn_on();
            call.set_brightness(id(current_brightness));
            call.perform();
          } else {
            id(cwww_led_capsule_lights).turn_on().perform();
          }

  - id: turn_off_interior_lights
    then:
      - logger.log:
          format: "Script: turn_off_interior_lights called"
          level: INFO
      - light.turn_off: main_can_lights
      - light.turn_off: bed_can_lights
      - light.turn_off: door_light
      - light.turn_off: cwww_led_dog_crate_lights
      - light.turn_off: cwww_led_capsule_lights

  - id: toggle_interior_lights
    then:
      - logger.log:
          format: "Script: toggle_interior_lights called"
          level: INFO
      - if:
          condition:
            and:
              - light.is_off: main_can_lights
              - light.is_off: bed_can_lights
              - light.is_off: door_light
              - light.is_off: cwww_led_dog_crate_lights
              - light.is_off: cwww_led_capsule_lights
          then:
            - logger.log:
                format: "Toggling on interior lights (main and bed can lights)"
                level: INFO
            - light.turn_on:
                id: main_can_lights
                brightness: 100%
            - light.turn_on:
                id: bed_can_lights
                brightness: 100%
          else:
            - script.execute: turn_off_interior_lights

binary_sensor:
# Button 1    Up Interior Light Button        tap - Turn on interior lights
#                                             double tap - Turn on all interior lights
#                                             press and hold - increase brightness of interior lights
  - id: !extend button_1
    internal: true
    name: "Button 1 - Cabin Interior Lights Up"
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(button_1_loop_count) = 0;'
      - if:
          condition:
            and:
              - light.is_off: main_can_lights
              - light.is_off: bed_can_lights
          then:
            - logger.log:
               format: "Button 1 pressed - main/bed lights are off, turning on to 20%"
               level: INFO
            - light.turn_on:
                id: main_can_lights
                brightness: 20%
            - light.turn_on:
                id: bed_can_lights
                brightness: 20%
      - while:
          condition:
            binary_sensor.is_on: button_1
          then:
            - lambda: 'id(button_1_loop_count)++;'
            # First, bring main_can_lights and bed_can_lights to 100%
            - if:
                condition:
                  lambda: |-
                    return id(main_can_lights).current_values.get_brightness() < 0.99 ||
                           id(bed_can_lights).current_values.get_brightness() < 0.99;
                then:
                  - logger.log:
                      format: "Button 1 held - increasing main/bed lights brightness 5%"
                      level: INFO
                  - light.dim_relative:
                      id: main_can_lights
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: bed_can_lights
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                else:
                  - if:
                      condition:
                        and:
                          - light.is_off: cwww_led_dog_crate_lights
                          - light.is_off: door_light
                          - light.is_off: cwww_led_capsule_lights
                      then:
                        - logger.log:
                            format: "Button 1 pressed - dog crate/door/capsule lights are off, turning on to 20%"
                            level: INFO
                        - light.turn_on:
                            id: cwww_led_dog_crate_lights
                            brightness: 20%
                        - light.turn_on:
                            id: door_light
                            brightness: 20%
                        - light.turn_on:
                            id: cwww_led_capsule_lights
                            brightness: 20%
                  # Main/bed lights at 100%, now work on dog crate/door/capsule lights
                  - logger.log:
                      format: "Button 1 held - main/bed at 100%, increasing dog crate/door/capsule lights brightness 5%"
                      level: INFO
                  - light.dim_relative:
                      id: cwww_led_dog_crate_lights
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: door_light
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: cwww_led_capsule_lights
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
            - delay: 200ms
    on_release:
      - logger.log:
          format: "Button 1 released"
          level: INFO
      - lambda: |-
          // Short press = 0-1 loop iterations (< ~400ms) -> jump main/bed to 100% (only dog/door/capsule if already on)
          // Long press = 2+ loop iterations (> ~400ms) -> stop at current brightness
          ESP_LOGI("button", "Button 1 loop count: %d", id(button_1_loop_count));
          if (id(button_1_loop_count) <= 1) {
            ESP_LOGI("button", "Button 1 short press - setting main/bed lights to 100%");
            // Always set main_can_lights and bed_can_lights to 100%
            auto call1 = id(main_can_lights).turn_on();
            call1.set_brightness(1.0);
            call1.perform();
            auto call2 = id(bed_can_lights).turn_on();
            call2.set_brightness(1.0);
            call2.perform();
            
            // Only set dog crate/door/capsule lights to 100% if they're already on
            if (id(cwww_led_dog_crate_lights).current_values.is_on() || 
                id(door_light).current_values.is_on() || 
                id(cwww_led_capsule_lights).current_values.is_on()) {
              ESP_LOGI("button", "Button 1 short press - dog crate/door/capsule lights already on, setting to 100%");
              auto call3 = id(cwww_led_dog_crate_lights).turn_on();
              call3.set_brightness(1.0);
              call3.perform();
              auto call4 = id(door_light).turn_on();
              call4.set_brightness(1.0);
              call4.perform();
              auto call5 = id(cwww_led_capsule_lights).turn_on();
              call5.set_brightness(1.0);
              call5.perform();
            }
          } else {
            ESP_LOGI("button", "Button 1 long press - stopping interior lights at current brightness");
          }
          id(button_1_loop_count) = 0;

# Button 2    Down Cabin Light Button         tap - Turn off cabin lights
#                                             press and hold - decrease brightness of cabin lights
  - id: !extend button_2
    name: "Button 2 - Cabin Interior Lights Down Button"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(button_2_loop_count) = 0;'
      - if:
          condition:
            or:
              - light.is_on: main_can_lights
              - light.is_on: bed_can_lights
              - light.is_on: door_light
              - light.is_on: cwww_led_dog_crate_lights
              - light.is_on: cwww_led_capsule_lights
          then:
            - logger.log:
                format: "Button 2 pressed - starting to dim interior lights immediately"
                level: INFO
            - while:
                condition:
                  and:
                    - binary_sensor.is_on: button_2
                    - lambda: |-
                        return id(main_can_lights).current_values.get_brightness() > 0.1 ||
                               id(bed_can_lights).current_values.get_brightness() > 0.1 ||
                               id(door_light).current_values.get_brightness() > 0.1 ||
                               id(cwww_led_dog_crate_lights).current_values.get_brightness() > 0.1 ||
                               id(cwww_led_capsule_lights).current_values.get_brightness() > 0.1;
                then:
                  - lambda: 'id(button_2_loop_count)++;'
                  # First, dim main_can_lights and bed_can_lights to 10% threshold
                  - if:
                      condition:
                        lambda: |-
                          return id(main_can_lights).current_values.get_brightness() > 0.11 ||
                                 id(bed_can_lights).current_values.get_brightness() > 0.11;
                      then:
                        - logger.log:
                            format: "Button 2 held - dimming main/bed lights 5%"
                            level: INFO
                        - light.dim_relative:
                            id: main_can_lights
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: bed_can_lights
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                      else:
                        # Main/bed lights at threshold, now work on dog crate/door/capsule lights
                        - logger.log:
                            format: "Button 2 held - main/bed at threshold, dimming dog crate/door/capsule lights 5%"
                            level: INFO
                        - light.dim_relative:
                            id: cwww_led_dog_crate_lights
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: door_light
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: cwww_led_capsule_lights
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                  - delay: 200ms
            # Only turn off if we exited loop because of threshold, not because button was released
            - if:
                condition:
                  binary_sensor.is_on: button_2
                then:
                  - logger.log:
                      format: "Button 2 dimming reached threshold - turning off all interior lights"
                      level: INFO
                  - light.turn_off: main_can_lights
                  - light.turn_off: bed_can_lights
                  - light.turn_off: cwww_led_dog_crate_lights
                  - light.turn_off: door_light
                  - light.turn_off: cwww_led_capsule_lights
    on_release:
      - logger.log:
          format: "Button 2 released"
          level: INFO
      - lambda: |-
          // Short press = 0-1 loop iterations (< ~400ms)
          // Long press = 2+ loop iterations (> ~400ms)
          ESP_LOGI("button", "Button 2 loop count: %d", id(button_2_loop_count));
          if (id(button_2_loop_count) <= 1) {
            ESP_LOGI("button", "Button 2 short press - turning all interior lights off");
            id(main_can_lights).turn_off().perform();
            id(bed_can_lights).turn_off().perform();
            id(cwww_led_dog_crate_lights).turn_off().perform();
            id(door_light).turn_off().perform();
            id(cwww_led_capsule_lights).turn_off().perform();
          } else {
            ESP_LOGI("button", "Button 2 long press - stopping at current brightness");
          }
          id(button_2_loop_count) = 0;

  - id: !extend button_3
    internal: true
    name: "Button 3 - Exterior Lights Up Button"
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(button_3_loop_count) = 0;'
      - if:
          condition:
            and:
              - light.is_off: light_exterior_driver_capsule
              - light.is_off: light_exterior_passenger_capsule
          then:
            - logger.log:
                format: "Button 3 pressed - capsule lights are off, turning on to 20%"
                level: INFO
            - light.turn_on:
                id: light_exterior_driver_capsule
                brightness: 20%
            - light.turn_on:
                id: light_exterior_passenger_capsule
                brightness: 20%
      - while:
          condition:
            binary_sensor.is_on: button_3
          then:
            - lambda: 'id(button_3_loop_count)++;'
            # First, bring capsule lights to 100%
            - if:
                condition:
                  lambda: |-
                    return id(light_exterior_driver_capsule).current_values.get_brightness() < 0.99 ||
                           id(light_exterior_passenger_capsule).current_values.get_brightness() < 0.99;
                then:
                  - logger.log:
                      format: "Button 3 held - increasing capsule lights brightness 5%"
                      level: INFO
                  - light.dim_relative:
                      id: light_exterior_driver_capsule
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: light_exterior_passenger_capsule
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                else:
                  - if:
                      condition:
                        and:
                          - light.is_off: light_exterior_roof_rear
                          - light.is_off: light_exterior_roof_driver
                          - light.is_off: light_exterior_roof_passenger
                      then:
                        - logger.log:
                            format: "Button 3 pressed - roof lights are off, turning on to 20%"
                            level: INFO
                        - light.turn_on:
                            id: light_exterior_roof_rear
                            brightness: 20%
                        - light.turn_on:
                            id: light_exterior_roof_driver
                            brightness: 20%
                        - light.turn_on:
                            id: light_exterior_roof_passenger
                            brightness: 20%
                  # Capsule lights at 100%, now work on roof lights
                  - logger.log:
                      format: "Button 3 held - capsule lights at 100%, increasing roof lights brightness 5%"
                      level: INFO
                  - light.dim_relative:
                      id: light_exterior_roof_rear
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: light_exterior_roof_driver
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
                  - light.dim_relative:
                      id: light_exterior_roof_passenger
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
            - delay: 200ms
    on_release:
      - logger.log:
          format: "Button 3 released"
          level: INFO
      - lambda: |-
          // Short press = 0-1 loop iterations (< ~400ms) -> jump capsule to 100% (only if roof lights already on)
          // Long press = 2+ loop iterations (> ~400ms) -> stop at current brightness
          ESP_LOGI("button", "Button 3 loop count: %d", id(button_3_loop_count));
          if (id(button_3_loop_count) <= 1) {
            ESP_LOGI("button", "Button 3 short press - setting capsule lights to 100%");
            // Always set capsule lights to 100%
            auto call1 = id(light_exterior_driver_capsule).turn_on();
            call1.set_brightness(1.0);
            call1.perform();
            auto call2 = id(light_exterior_passenger_capsule).turn_on();
            call2.set_brightness(1.0);
            call2.perform();
            
            // Only set roof lights to 100% if they're already on
            if (id(light_exterior_roof_rear).current_values.is_on() || 
                id(light_exterior_roof_driver).current_values.is_on() || 
                id(light_exterior_roof_passenger).current_values.is_on()) {
              ESP_LOGI("button", "Button 3 short press - roof lights already on, setting to 100%");
              auto call3 = id(light_exterior_roof_rear).turn_on();
              call3.set_brightness(1.0);
              call3.perform();
              auto call4 = id(light_exterior_roof_driver).turn_on();
              call4.set_brightness(1.0);
              call4.perform();
              auto call5 = id(light_exterior_roof_passenger).turn_on();
              call5.set_brightness(1.0);
              call5.perform();
            }
          } else {
            ESP_LOGI("button", "Button 3 long press - stopping exterior lights at current brightness");
          }
          id(button_3_loop_count) = 0;

  - id: !extend button_4
    internal: true
    name: "Button 4 - Exterior Lights Down Button"
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(button_4_loop_count) = 0;'
      - if:
          condition:
            or:
              - light.is_on: light_exterior_roof_rear
              - light.is_on: light_exterior_roof_driver
              - light.is_on: light_exterior_roof_passenger
              - light.is_on: light_exterior_driver_capsule
              - light.is_on: light_exterior_passenger_capsule
          then:
            - logger.log:
                format: "Button 4 pressed - starting to dim exterior lights immediately"
                level: INFO
            - while:
                condition:
                  and:
                    - binary_sensor.is_on: button_4
                    - lambda: |-
                        return id(light_exterior_roof_rear).current_values.get_brightness() > 0.1 ||
                               id(light_exterior_roof_driver).current_values.get_brightness() > 0.1 ||
                               id(light_exterior_roof_passenger).current_values.get_brightness() > 0.1 ||
                               id(light_exterior_driver_capsule).current_values.get_brightness() > 0.1 ||
                               id(light_exterior_passenger_capsule).current_values.get_brightness() > 0.1;
                then:
                  - lambda: 'id(button_4_loop_count)++;'
                  # First, dim roof lights to 10% threshold
                  - if:
                      condition:
                        lambda: |-
                          return id(light_exterior_roof_rear).current_values.get_brightness() > 0.11 ||
                                 id(light_exterior_roof_driver).current_values.get_brightness() > 0.11 ||
                                 id(light_exterior_roof_passenger).current_values.get_brightness() > 0.11;
                      then:
                        - logger.log:
                            format: "Button 4 held - dimming roof lights 5%"
                            level: INFO
                        - light.dim_relative:
                            id: light_exterior_roof_rear
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: light_exterior_roof_driver
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: light_exterior_roof_passenger
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                      else:
                        # Roof lights at threshold, now work on capsule lights
                        - logger.log:
                            format: "Button 4 held - roof lights at threshold, dimming capsule lights 5%"
                            level: INFO
                        - light.dim_relative:
                            id: light_exterior_driver_capsule
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                        - light.dim_relative:
                            id: light_exterior_passenger_capsule
                            relative_brightness: !lambda 'return -id(brightness_step).state;'
                            transition_length: 100ms
                  - delay: 200ms
            # Only turn off if we exited loop because of threshold, not because button was released
            - if:
                condition:
                  binary_sensor.is_on: button_4
                then:
                  - logger.log:
                      format: "Button 4 dimming reached threshold - turning off all exterior lights"
                      level: INFO
                  - light.turn_off: light_exterior_roof_rear
                  - light.turn_off: light_exterior_roof_driver
                  - light.turn_off: light_exterior_roof_passenger
                  - light.turn_off: light_exterior_driver_capsule
                  - light.turn_off: light_exterior_passenger_capsule
    on_release:
      - logger.log:
          format: "Button 4 released"
          level: INFO
      - lambda: |-
          // Short press = 0-1 loop iterations (< ~400ms)
          // Long press = 2+ loop iterations (> ~400ms)
          ESP_LOGI("button", "Button 4 loop count: %d", id(button_4_loop_count));
          if (id(button_4_loop_count) <= 1) {
            ESP_LOGI("button", "Button 4 short press - turning exterior lights off");
            id(light_exterior_roof_rear).turn_off().perform();
            id(light_exterior_roof_driver).turn_off().perform();
            id(light_exterior_roof_passenger).turn_off().perform();
            id(light_exterior_driver_capsule).turn_off().perform();
            id(light_exterior_passenger_capsule).turn_off().perform();
          } else {
            ESP_LOGI("button", "Button 4 long press - stopping exterior lights at current brightness");
          }
          id(button_4_loop_count) = 0;

# PFC8574 Buttons
# Button    Pin         Name                            Action
# ------    ------      -----                           ------
# 0         Button 1    Upper Roof Driver Lights        Turn on the upper and lower roof driver lights as long as the button is on
# 1         Button 2    Lower Driver Capsule Lights     Turn on the lower roof driver capsule lights
# 2         Button 3    Rear Roof Lights                tap - Toggle upper rear roof lights
#                                                       double tap - Turn on all exterior lights
#                                                       press and hold - Turn off all exterior lights
# 3         Button 4    Upper Roof Passenger Lights     Turn on the upper and lower roof passenger lights as long as the button is on
# 4         Button 5    Lower Passenger Capsule Lights  Turn on the lower roof passenger capsule lights
  - id: !extend pcf8574_button_0
    name: "Upper Exterior Driver Light Switch"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log:
          format: "PCF8574 Button 0 pressed - Upper+Lower Exterior Driver"
          level: INFO
      - light.turn_on:
          id: light_exterior_roof_driver
          brightness: 100%
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - logger.log:
          format: "PCF8574 Button 0 released - Turn off exterior driver lights"
          level: INFO
      - light.turn_off:
          id: light_exterior_roof_driver
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_1
    name: "Lower Exterior Driver Light Switch"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log:
          format: "PCF8574 Button 1 pressed - Lower Exterior Driver"
          level: INFO
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - logger.log:
          format: "PCF8574 Button 1 released - Turn off exterior passenger capsule light"
          level: INFO
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_2
    name: "Rear Exterior Light Switch"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_multi_click:
      # Single click
      - timing:
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - logger.log:
              format: "PCF8574 Button 2 single click - Toggle exterior floods"
              level: INFO
          - script.execute: toggle_exterior_flood_lights

      # Double click
      - timing:
          - ON for at most 500ms
          - OFF for at most 500ms
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - logger.log:
              format: "PCF8574 Button 2 double click - Turn on all exterior"
              level: INFO
          - script.execute: turn_on_exterior_flood_lights
  
      # Long press
      - timing:
          - ON for at least 1000ms
        then:
          - logger.log:
              format: "PCF8574 Button 2 long press - Turn off all exterior"
              level: INFO
          - script.execute: turn_off_exterior_flood_lights

  - id: !extend pcf8574_button_3
    name: "Upper Exterior Passenger Light Switch"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log:
          format: "PCF8574 Button 3 pressed - Exterior Passenger Lights On 100%"
          level: INFO
      - light.turn_on:
          id: light_exterior_roof_passenger
          brightness: 100%
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - logger.log:
          format: "PCF8574 Button 3 released - Exterior Passenger Lights Off"
          level: INFO
      - light.turn_off:
          id: light_exterior_roof_passenger
      - light.turn_off:
          id: light_exterior_passenger_capsule

  - id: !extend pcf8574_button_4
    name: "Lower Exterior Passenger Light Switch"
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - logger.log:
          format: "PCF8574 Button 4 pressed - Lower Exterior Passenger Capsule On 100%"
          level: INFO
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - logger.log:
          format: "PCF8574 Button 4 released - Lower Exterior Passenger Capsule Off"
          level: INFO
      - light.turn_off:
          id: light_exterior_passenger_capsule

  - id: !extend pcf8574_button_5
    name: "Garage LED Light Button"
    internal: true
    on_press:
      - lambda: 'id(pcf8574_button_5_loop_count) = 0;'
      - lambda: |-
          // Store initial brightness to determine dimming vs brightening
          if (id(garage_led_lights).current_values.is_on()) {
            id(pcf8574_button_5_initial_brightness) = id(garage_led_lights).current_values.get_brightness();
            ESP_LOGI("button", "PCF8574 Button 5 pressed - garage light on at %.0f%%", 
                     id(pcf8574_button_5_initial_brightness) * 100);
          } else {
            id(pcf8574_button_5_initial_brightness) = 0.0;
            ESP_LOGI("button", "PCF8574 Button 5 pressed - garage light off");
          }
      - while:
          condition:
            binary_sensor.is_on: pcf8574_button_5
          then:
            - lambda: 'id(pcf8574_button_5_loop_count)++;'
            - if:
                condition:
                  lambda: 'return id(pcf8574_button_5_initial_brightness) >= 0.99;'
                then:
                  # Started at 100%, dim down
                  - logger.log:
                      format: "PCF8574 Button 5 held - dimming garage light 5%"
                      level: INFO
                  - light.dim_relative:
                      id: garage_led_lights
                      relative_brightness: !lambda 'return -id(brightness_step).state;'
                      transition_length: 100ms
                else:
                  # Started below 100% or was off, brighten up
                  - if:
                      condition:
                        light.is_off: garage_led_lights
                      then:
                        # Turn on to starting brightness if off
                        - logger.log:
                            format: "PCF8574 Button 5 held - turning on garage light"
                            level: INFO
                        - light.turn_on:
                            id: garage_led_lights
                            brightness: 20%
                  - logger.log:
                      format: "PCF8574 Button 5 held - increasing garage light brightness 5%"
                      level: INFO
                  - light.dim_relative:
                      id: garage_led_lights
                      relative_brightness: !lambda 'return id(brightness_step).state;'
                      transition_length: 100ms
            - delay: 200ms
    on_release:
      - logger.log:
          format: "PCF8574 Button 5 released"
          level: INFO
      - lambda: |-
          // Short press = 0-1 loop iterations (< ~400ms) -> toggle
          // Long press = 2+ loop iterations (> ~400ms) -> stop at current brightness
          ESP_LOGI("button", "PCF8574 Button 5 loop count: %d", id(pcf8574_button_5_loop_count));
          if (id(pcf8574_button_5_loop_count) <= 1) {
            ESP_LOGI("button", "PCF8574 Button 5 short press - toggling garage light");
            if (id(garage_led_lights).current_values.is_on()) {
              id(garage_led_lights).turn_off().perform();
            } else {
              id(garage_led_lights).turn_on().perform();
            }
          } else {
            ESP_LOGI("button", "PCF8574 Button 5 long press - stopping at current brightness");
          }
          id(pcf8574_button_5_loop_count) = 0;
          id(pcf8574_button_5_initial_brightness) = 0.0;

  - id: !extend pcf8574_button_6
    internal: true

  - id: !extend pcf8574_button_7
    internal: true

# Wizmote Remote Control Buttons
  - id: !extend wizmote_on
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote ON button pressed"
          level: INFO
      - script.execute: turn_on_lights
  
  - id: !extend wizmote_off
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote OFF button pressed"
          level: INFO
      - script.execute: turn_off_lights

  - id: !extend wizmote_sleep
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote SLEEP button pressed"
          level: INFO
      - script.execute: turn_off_exterior_flood_lights
      - light.turn_off: main_can_lights
      - light.turn_off: door_light
      - light.turn_off: cwww_led_dog_crate_lights
      # capsule lights intentionally left on - they can remain on in sleep mode
      - delay: !lambda 'return id(sleep_delay_seconds).state * 1000;'
      - light.turn_off: bed_can_lights

  - id: !extend wizmote_1
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote 1 button pressed"
          level: INFO
      - script.execute: toggle_interior_lights

  - id: !extend wizmote_2
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote 2 button pressed"
          level: INFO
      - script.execute: toggle_exterior_flood_lights

  - id: !extend wizmote_3
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote 3 button pressed"
          level: INFO
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%

  - id: !extend wizmote_4
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote 4 button pressed"
          level: INFO
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%

  - id: !extend wizmote_up
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote UP button pressed"
          level: INFO
      - lambda: |-
          float step = id(brightness_step).state;
          esphome::light::LightState* lights[] = {
            id(main_can_lights), id(bed_can_lights), id(door_light),
            id(cwww_led_dog_crate_lights), id(garage_led_lights),
            id(cwww_led_capsule_lights), id(light_awning_outside_light),
            id(light_awning_inside_light), id(light_exterior_passenger_capsule),
            id(light_exterior_driver_capsule), id(light_exterior_roof_passenger),
            id(light_exterior_roof_driver), id(light_exterior_roof_rear)
          };
          for (auto *light : lights) {
            if (light->current_values.is_on()) {
              auto call = light->make_call();
              call.set_brightness(std::min(1.0f, light->current_values.get_brightness() + step));
              call.perform();
            }
          }
          ESP_LOGD("wizmote", "Increased brightness for all active lights");

  - id: !extend wizmote_down
    internal: true
    on_press:
      - logger.log:
          format: "Wizmote DOWN button pressed"
          level: INFO
      - lambda: |-
          float step = id(brightness_step).state;
          esphome::light::LightState* lights[] = {
            id(main_can_lights), id(bed_can_lights), id(door_light),
            id(cwww_led_dog_crate_lights), id(garage_led_lights),
            id(cwww_led_capsule_lights), id(light_awning_outside_light),
            id(light_awning_inside_light), id(light_exterior_passenger_capsule),
            id(light_exterior_driver_capsule), id(light_exterior_roof_passenger),
            id(light_exterior_roof_driver), id(light_exterior_roof_rear)
          };
          for (auto *light : lights) {
            if (light->current_values.is_on()) {
              auto call = light->make_call();
              call.set_brightness(std::max(0.01f, light->current_values.get_brightness() - step));
              call.perform();
            }
          }
          ESP_LOGD("wizmote", "Decreased brightness for all active lights");

switch:
  - platform: template
    name: "Auto Color Temperature"
    id: auto_color_temp_enabled
    optimistic: true
    restore_mode: RESTORE
    entity_category: config
    icon: "mdi:theme-light-dark"
    on_turn_on:
      - logger.log: "Auto color temperature enabled"
      - script.execute: adjust_light_color_temperature
    on_turn_off:
      - logger.log: "Auto color temperature disabled"

  - platform: template
    name: "Auto Brightness"
    id: auto_brightness_enabled
    optimistic: true
    restore_mode: RESTORE
    entity_category: config
    icon: "mdi:brightness-auto"
    on_turn_on:
      - logger.log: "Auto brightness enabled"
      - script.execute: adjust_light_color_temperature
    on_turn_off:
      - logger.log: "Auto brightness disabled"
      - lambda: |-
          // Reset brightness to default (100%) for lights that are currently on
          if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
            auto call = id(cwww_led_dog_crate_lights).turn_on();
            call.set_brightness(1.0);
            call.perform();
          }
          if (id(cwww_led_capsule_lights).current_values.is_on()) {
            auto call = id(cwww_led_capsule_lights).turn_on();
            call.set_brightness(1.0);
            call.perform();
          }
          ESP_LOGD("brightness", "Reset brightness to 100%% for all active lights");

number:
  - platform: template
    name: "Brightness Step"
    id: brightness_step
    optimistic: true
    min_value: 0.01
    max_value: 0.5
    step: 0.01
    initial_value: 0.1
    restore_value: true
    entity_category: config
    icon: "mdi:brightness-percent"
    unit_of_measurement: "%"
    mode: slider

  - platform: template
    name: "Exterior Light Sun Threshold"
    id: exterior_light_sun_threshold
    optimistic: true
    min_value: -12
    max_value: 30
    step: 1
    initial_value: 10
    restore_value: true
    entity_category: config
    icon: "mdi:weather-sunset-up"
    unit_of_measurement: "°"
    mode: slider

  - platform: template
    name: "Sleep Delay"
    id: sleep_delay_seconds
    optimistic: true
    min_value: 0
    max_value: 120
    step: 5
    initial_value: 30
    restore_value: true
    entity_category: config
    icon: "mdi:timer-sand"
    unit_of_measurement: "s"
    mode: slider

interval:
  - interval: 5min
    then:
      - if:
          condition:
            or:
              - switch.is_on: auto_color_temp_enabled
              - switch.is_on: auto_brightness_enabled
          then:
            - script.execute: adjust_light_color_temperature
