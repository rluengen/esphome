# The awning motor is controlled by two relays to set the motor direction.
# relay1     relay2    motor     state
# off        off       -  -      stopped
# on         off       +  -      opening
# off        on        -  +      closing
# on         on        +  +      stopped

# Relay common values should be attached to the motor power.
# Ground is attached to the normally closed pin of both relays.
# Positive voltage is attached to the normally open pin of both relays.

substitutions:
  cover_name: "Default Cover"
  cover_id: default_cover_id
  current_sensor_id: 
  current_sensor_parent_id: 
  relay_1_id: relay_1
  relay_2_id: relay_2
  current_update_interval_ms: "100"  # How often to update current sensor during operation (milliseconds)
  open_duration_value: 100s
  close_duration_value: 100s

cover:
  - platform: current_based
    name: ${cover_name}
    id: ${cover_id}
    device_class: awning

    open_action:
      - logger.log: "Opening cover ${cover_name}, turn off ${relay_2_id}, turn on ${relay_1_id}"
      - switch.turn_off: ${relay_2_id}
      - switch.turn_on: ${relay_1_id}
      - while:
          condition:
            lambda: |-
              auto state = id(${cover_id}).current_operation;
              return state == COVER_OPERATION_OPENING || state == COVER_OPERATION_CLOSING;
          then:
            - component.update: ${current_sensor_parent_id}
            - delay: ${current_update_interval_ms}ms

    # Note: open_duration, close_duration, and max_duration are not templatable.
    # Using the maximum configurable value (300s). The current-based sensing
    # will stop the motor when it reaches the end position.
    open_duration: ${open_duration_value}

    open_moving_current_threshold: 0.5
    open_obstacle_current_threshold: 3.5
    open_sensor: ${current_sensor_id}

    close_action:
      - logger.log: "Closing cover ${cover_name}, turn off ${relay_2_id}, turn on ${relay_1_id}"
      - switch.turn_off: ${relay_1_id}
      - switch.turn_on: ${relay_2_id}
      - while:
          condition:
            lambda: |-
              auto state = id(${cover_id}).current_operation;
              return state == COVER_OPERATION_OPENING || state == COVER_OPERATION_CLOSING;
          then:
            - component.update: ${current_sensor_parent_id}
            - delay: ${current_update_interval_ms}ms

    close_duration: ${close_duration_value}

    stop_action:
      - logger.log: "Stop cover ${cover_name}, turn off ${relay_2_id}, ${relay_1_id}"
      - switch.turn_off: ${relay_1_id}
      - switch.turn_off: ${relay_2_id}

    close_sensor: ${current_sensor_id}
    close_moving_current_threshold: 0.5
    close_obstacle_current_threshold: 3.5

    malfunction_detection: false
    malfunction_action:
      - logger.log: "Cover ${cover_name} malfunction detected"

    max_duration: 300s
