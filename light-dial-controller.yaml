# Template for a dial controller using ESP32 with a rotary encoder and display.

# tapping the screen when off will wake the device
# tapping the screen will toggle the current device on/off.
# rotating the dial will adjust a value (e.g., brightness).
# pressing and holding the touch screen for 2 seconds will turn the device off.
# double-tap the screen will turn the light on?
# automatically turn off the display after a period of inactivity.

substitutions:
  device_name: light-dial-controller
  friendly_name: Light Dial Controller
  project_name: light-dial-controller
  project_version: "1.0.0"
  log_level: DEBUG

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/waveshare-ESP32-S3-Knob-Touch-LCD-1.8.yaml
        vars:
          rotary_encoder_id: rotary_encoder_id
      - path: packages/icons/network_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: packages/icons/homeassistant_icons.yaml
      - path: packages/display_timeout.yaml
        vars:
          touchscreen_id: my_touchscreen
          backlight_id: display_backlight_id

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: true
  project:
    name: smartvan.${project_name}
    version: ${project_version}

font:
  - file: "fonts/segoeui.ttf"
    id: segoeui_16
    size: 16
    glyphs: "!%()+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz"

  - file: "fonts/segoeui.ttf"
    id: segoeui_24
    size: 24
    glyphs: "!%()+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz"

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_large
    size: 40
    bpp: 4
    glyphs: []  # Will be populated dynamically by ESPHome

lvgl:
  on_boot:
    then:
      - script.execute: restore_roller_position
      - lvgl.resume:

  disp_bg_color: 0x000000

  top_layer:
    widgets:
      - label:
          id: wifi_icon
          align: TOP_LEFT
          x: 5
          y: 5
          text: "\U000F05A9"  # mdi:wifi
          text_font: battery_icons
          text_color: 0xFFFFFF

      - label:
          id: ha_status_icon
          align: TOP_RIGHT
          x: -25
          y: 5
          text: "\U000F07D0"
          text_font: homeassistant_icons
          text_color: 0xFFFFFF

      # Stationary brightness arc overlay (non-interactive, transparent background)
      - arc:
          id: brightness_arc
          align: CENTER
          x: 0
          y: 0
          clickable: false
          bg_opa: TRANSP
          arc_color: 0x444444
          arc_width: 12
          min_value: 0
          max_value: 100
          value: 0
          adjustable: false
          radius: 90
          indicator:
            arc_color: 0xFFC107
            arc_width: 14

  pages:
    - id: main_page
      widgets:
        # Swipeable TileView (no headers; swipe horizontally between tiles)
        - tileview:
            id: light_tiles
            tiles:
              - id: tile_all_lights
                row: 0
                column: 0
                dir: HOR
                widgets:
                  - label:
                      id: tile_all_lights_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_all_lights_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "All Lights"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_all_lights_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_bed_interior
                row: 0
                column: 1
                dir: HOR
                widgets:
                  - label:
                      id: tile_bed_interior_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_bed_interior_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Bed Interior"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_bed_interior_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_main_can
                row: 0
                column: 2
                dir: HOR
                widgets:
                  - label:
                      id: tile_main_can_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_main_can_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Main Can"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_main_can_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_bed_can
                row: 0
                column: 3
                dir: HOR
                widgets:
                  - label:
                      id: tile_bed_can_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_bed_can_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Bed Can"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_bed_can_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_led_capsule
                row: 0
                column: 4
                dir: HOR
                widgets:
                  - label:
                      id: tile_led_capsule_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_led_capsule_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "LED Capsule"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_led_capsule_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_exterior
                row: 0
                column: 5
                dir: HOR
                widgets:
                  - label:
                      id: tile_exterior_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_exterior_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Exterior"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_exterior_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_door
                row: 0
                column: 6
                dir: HOR
                widgets:
                  - label:
                      id: tile_door_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_door_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Door"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_door_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

              - id: tile_dog_crate
                row: 0
                column: 7
                dir: HOR
                widgets:
                  - label:
                      id: tile_dog_crate_icon
                      align: CENTER
                      x: 0
                      y: -35
                      text: "\U000F0335"
                      text_font: mdi_icons_large
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_dog_crate_name
                      align: CENTER
                      x: 0
                      y: 10
                      text: "Dog Crate"
                      text_font: segoeui_16
                      text_color: 0xFFFFFF
                  - label:
                      id: tile_dog_crate_pct
                      align: CENTER
                      x: 0
                      y: 40
                      text: "%"
                      text_font: segoeui_16
                      text_color: 0xFFDD44

            on_value:
              then:
                - lambda: |-
                    // Map visible tile to selected index and entity
                    int idx = 0;
                    if (tile == id(tile_all_lights)) idx = 0;
                    else if (tile == id(tile_bed_interior)) idx = 1;
                    else if (tile == id(tile_main_can)) idx = 2;
                    else if (tile == id(tile_bed_can)) idx = 3;
                    else if (tile == id(tile_led_capsule)) idx = 4;
                    else if (tile == id(tile_exterior)) idx = 5;
                    else if (tile == id(tile_door)) idx = 6;
                    else if (tile == id(tile_dog_crate)) idx = 7;
                    id(selected_light_index) = idx;
                    
                    const char* entities[] = {
                      "light.all_lights", "light.bed_interior_lights",
                      "light.main_can_lights", "light.bed_can_lights",
                      "light.cwww_led_capsule_lights", "light.exterior_lights",
                      "light.door_light", "light.cwww_led_dog_crate_lights"
                    };
                    id(selected_entity) = std::string(entities[idx]);
                    id(dial_selected_light).publish_state(entities[idx]);
                    ESP_LOGI("tileview", "Selected idx=%d entity=%s", idx, entities[idx]);
                - script.execute: update_light_display

select:
  - platform: template
    name: "Dial Selected Light"
    id: dial_selected_light
    initial_option: light.all_lights
    restore_value: false
    options:
      - light.all_lights
      - light.bed_interior_lights
      - light.main_can_lights
      - light.bed_can_lights
      - light.cwww_led_capsule_lights
      - light.exterior_lights
      - light.door_light
      - light.cwww_led_dog_crate_lights

    set_action: # The action that should be performed when the remote (like Home Assistant’s frontend) requests to set the Select option
      - logger.log:
          format: "Selected light option (remote): %s"
          args: ["x.c_str()"]

    on_value:
      then:
        - logger.log:
            format: "Selected light option: %s"
            args: ["x.c_str()"]

globals:
  - id: current_brightness
    type: int
    initial_value: "0"

  - id: selected_light_index
    type: int
    initial_value: "0"
    restore_value: yes

  - id: selected_entity
    type: std::string
    initial_value: '"light.all_lights"'
    restore_value: yes

script:
  - id: restore_roller_position
    then:
      - lvgl.tileview.select:
          id: light_tiles
          row: 0
          column: !lambda 'return id(selected_light_index);'
          animated: false
      - script.execute: update_light_display

  - id: update_light_display
    then:
      - lambda: |-
          // Compute brightness based on currently selected tab index
          int idx = id(selected_light_index);
          auto pct_from_attr = [](float attr) -> int {
            if (isnan(attr)) return 0;
            int v = (int)roundf((attr / 255.0f) * 100.0f);
            if (v < 0) v = 0; if (v > 100) v = 100; return v;
          };
          int brightness = 0;
          switch (idx) {
            case 0: brightness = pct_from_attr(id(light_all_lights_brightness).state); break;
            case 1: brightness = pct_from_attr(id(light_bed_interior_lights_brightness).state); break;
            case 2: brightness = pct_from_attr(id(light_main_can_lights_brightness).state); break;
            case 3: brightness = pct_from_attr(id(light_bed_can_lights_brightness).state); break;
            case 4: brightness = pct_from_attr(id(light_cwww_led_capsule_lights_brightness).state); break;
            case 5: brightness = pct_from_attr(id(light_exterior_lights_brightness).state); break;
            case 6: brightness = pct_from_attr(id(light_door_light_brightness).state); break;
            case 7: brightness = pct_from_attr(id(light_cwww_led_dog_crate_lights_brightness).state); break;
            default: brightness = 0; break;
          }
          id(current_brightness) = brightness;
          ESP_LOGI("ui", "update_light_display idx=%d -> %d%%", id(selected_light_index), id(current_brightness));
      - lvgl.arc.update:
          id: brightness_arc
          value: !lambda 'return id(current_brightness);'
      - lambda: |-
          // Update visible tab percent label text
          char buf[8]; snprintf(buf, sizeof(buf), "%d%%", id(current_brightness));
          switch (id(selected_light_index)) {
            case 0: lv_label_set_text(id(tile_all_lights_pct), buf); break;
            case 1: lv_label_set_text(id(tile_bed_interior_pct), buf); break;
            case 2: lv_label_set_text(id(tile_main_can_pct), buf); break;
            case 3: lv_label_set_text(id(tile_bed_can_pct), buf); break;
            case 4: lv_label_set_text(id(tile_led_capsule_pct), buf); break;
            case 5: lv_label_set_text(id(tile_exterior_pct), buf); break;
            case 6: lv_label_set_text(id(tile_door_pct), buf); break;
            case 7: lv_label_set_text(id(tile_dog_crate_pct), buf); break;
            default: break;
          }

  - id: increase_light_brightness
    mode: restart
    then:
      - lambda: |-
          int step = 2;
          id(current_brightness) = std::min(100, id(current_brightness) + step);
      - script.execute: update_light_display
      - script.execute: publish_brightness_throttled

  - id: decrease_light_brightness
    mode: restart
    then:
      - lambda: |-
          int step = 2;
          id(current_brightness) = std::max(0, id(current_brightness) - step);
      - script.execute: update_light_display
      - script.execute: publish_brightness_throttled

  - id: publish_brightness_throttled
    mode: restart
    then:
      - delay: 300ms
      - if:
          condition:
            lambda: 'return id(current_brightness) == 0;'
          then:
            - lambda: |-
                ESP_LOGI("ha", "Calling light.turn_off on %s", id(selected_entity).c_str());
            - homeassistant.service:
                service: light.turn_off
                data:
                  entity_id: !lambda 'return id(selected_entity);'
          else:
            - lambda: |-
                ESP_LOGI("ha", "Calling light.turn_on on %s brightness=%d%%", id(selected_entity).c_str(), id(current_brightness));
            - homeassistant.service:
                service: light.turn_on
                data:
                  entity_id: !lambda 'return id(selected_entity);'
                  brightness: !lambda |
                    // convert 0..100 -> 1..255 and clamp
                    int val = id(current_brightness);
                    int b = (int)(val * 255.0f / 100.0f + 0.5f);
                    if (b < 1) b = 1;   // avoid sending 0
                    if (b > 255) b = 255;
                    return b;

  - id: toggle_selected_light
    then:
      - lambda: |-
          ESP_LOGI("touch", "Toggle light: %s", id(selected_entity).c_str());
      - homeassistant.service:
          service: light.toggle
          data:
            entity_id: !lambda 'return id(selected_entity);'

  - id: turn_on_selected_light
    then:
      - lambda: |-
          ESP_LOGI("touch", "Turn ON light: %s", id(selected_entity).c_str());
      - homeassistant.service:
          service: light.turn_on
          data:
            entity_id: !lambda 'return id(selected_entity);'

  - id: turn_off_selected_light
    then:
      - lambda: |-
          ESP_LOGI("touch", "Turn OFF light: %s", id(selected_entity).c_str());
      - homeassistant.service:
          service: light.turn_off
          data:
            entity_id: !lambda 'return id(selected_entity);'

binary_sensor:
  - id: !extend touch_input
    on_multi_click:
      # Single tap: toggle the selected light (ignored if this is a wake touch)
      - timing:
          - ON for at most 500ms
          - OFF for at least 350ms
        then:
          - if:
              condition:
                lambda: 'return id(wake_touch);'
              then:
                - lambda: 'id(wake_touch) = false;'
                - logger.log: "Wake touch consumed - no action"
              else:
                - script.execute: toggle_selected_light

      # Double tap: turn the light on (ignored if this is a wake touch)
      - timing:
          - ON for at most 500ms
          - OFF for at most 300ms
          - ON for at most 500ms
          - OFF for at least 350ms
        then:
          - if:
              condition:
                lambda: 'return id(wake_touch);'
              then:
                - lambda: 'id(wake_touch) = false;'
                - logger.log: "Wake double-tap consumed - no action"
              else:
                - script.execute: turn_on_selected_light

      # Long press (2 seconds): turn the light off
      - timing:
          - ON for at least 2s
        then:
          - if:
              condition:
                lambda: 'return id(wake_touch);'
              then:
                - lambda: 'id(wake_touch) = false;'
                - logger.log: "Wake long-press consumed - no action"
              else:
                - script.execute: turn_off_selected_light

sensor:
  - id: !extend rotary_encoder_id
    name: "Rotary Encoder"
    on_clockwise:
      then:
        - script.execute: screen_timeout_timer
        - script.execute: increase_light_brightness

    on_anticlockwise:
      then:
        - script.execute: screen_timeout_timer
        - script.execute: decrease_light_brightness

  # Home Assistant brightness attribute sensors for each selectable light.
  # Each sensor only triggers a display update when it matches the currently selected light.
  - platform: homeassistant
    id: light_all_lights_brightness
    entity_id: light.all_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 0;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_bed_interior_lights_brightness
    entity_id: light.bed_interior_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 1;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_main_can_lights_brightness
    entity_id: light.main_can_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 2;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_bed_can_lights_brightness
    entity_id: light.bed_can_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 3;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_cwww_led_capsule_lights_brightness
    entity_id: light.cwww_led_capsule_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 4;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_exterior_lights_brightness
    entity_id: light.exterior_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 5;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_door_light_brightness
    entity_id: light.door_light
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 6;'
          then:
            - script.execute: update_light_display

  - platform: homeassistant
    id: light_cwww_led_dog_crate_lights_brightness
    entity_id: light.cwww_led_dog_crate_lights
    attribute: brightness
    internal: true
    on_value:
      - if:
          condition:
            lambda: 'return id(selected_light_index) == 7;'
          then:
            - script.execute: update_light_display
