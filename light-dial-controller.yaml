# Template for a dial controller using ESP32 with a rotary encoder and display.

# tapping the screen when off will wake the device
# tapping the screen will toggle the current device on/off.
# rotating the dial will adjust a value (e.g., brightness).
# pressing and holding the screen for 2 seconds will turn the device off.
# double-tap the screen will turn the light on?
# automatically turn off the display after a period of inactivity.

substitutions:
  device_name: light_dial_controller
  friendly_name: Light Dial Controller
  project_name:  Mercedes Sprinter Control Modules
  project_version: "1.0.0"
  log_level: DEBUG

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/waveshare-ESP32-S3-Knob-Touch-LCD-1.8.yaml
        vars:
          rotary_encoder_id: rotary_encoder_id
      - path: packages/icons/network_icons.yaml
      - path: packages/icons/battery_icons.yaml
      - path: packages/icons/homeassistant_icons.yaml

#      - path: packages/home_assistant_light.yaml
#        vars:
#          light_id: rear_can_lights
#          entity_id: light.rear_can_lights

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}
  on_boot:
    priority: -100  # Run after everything is initialized
    then:
      - delay: 1s
      - script.execute: restore_roller_position

font:
  - file: "fonts/segoeui.ttf"
    id: segoeui_16
    size: 16
    glyphs: "!%()+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz"

  - file: "fonts/segoeui.ttf"
    id: segoeui_24
    size: 24
    glyphs: "!%()+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz"

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_large
    size: 40
    bpp: 4
    glyphs: []  # Will be populated dynamically by ESPHome

number:
  - platform: template
    name: Screen Timeout
    optimistic: true
    entity_category: config
    id: display_timeout
    unit_of_measurement: "s"
    initial_value: 60
    restore_value: true
    min_value: 10
    max_value: 720
    step: 5
    mode: box

lvgl:
# https://esphome.io/cookbook/lvgl/#turn-off-screen-when-idle
  on_idle:
    timeout: !lambda "return (id(display_timeout).state * 1000);"
    then:
      - logger.log: "LVGL is idle"
      - light.turn_off: display_backlight_id
      - lvgl.pause:

  on_boot:
    then:
      - script.execute: restore_roller_position

  disp_bg_color: 0x000000

  top_layer:
    widgets:
      - label:
          id: battery_icon
          align: TOP_LEFT
          x: 5
          y: 30
          text: "\U000F05A8"  # mdi:battery
          text_font: battery_icons
          text_color: 0xFFFFFF

      - label:
          id: wifi_icon
          align: TOP_LEFT
          x: 5
          y: 5
          text: "\U000F05A9"  # mdi:wifi
          text_font: battery_icons
          text_color: 0xFFFFFF

      - label:
          id: wifi_signal_label
          align: TOP_LEFT
          x: 25
          y: 5
          text: "-"
          text_font: segoeui_16
          text_color: 0x00FF00
      
      - label:
          id: ha_status_icon
          align: TOP_RIGHT
          x: -25
          y: 5
          text: "\U000F07D0"
          text_font: homeassistant_icons
          text_color: 0xFFFFFF

  pages:
    - id: main_page
      widgets:
        # Circular arc showing brightness level (0-100%)
        - arc:
            id: brightness_arc
            align: CENTER
            x: 0
            y: 0
            arc_color: 0x444444
            arc_width: 12
            min_value: 0
            max_value: 100
            value: 0
            adjustable: false
            bg_color: 0x222222
            bg_opa: COVER
            radius: 90
            indicator:
              arc_color: 0xFFDD44
              arc_width: 14

        # Light icon (centered, above name)
        - label:
            id: light_icon_label
            align: CENTER
            x: 0
            y: -35
            text: "\U000F0335"  # mdi:lightbulb as default
            text_font: mdi_icons_large
            text_color: 0xFFFFFF

        # Light name (centered)
        - label:
            id: light_name_label
            align: CENTER
            x: 0
            y: 10
            text: "Living Room"
            text_font: segoeui_16
            text_color: 0xFFFFFF

        # Brightness percentage (centered, below name)
        - label:
            id: brightness_pct_label
            align: CENTER
            x: 0
            y: 40
            text: "%"
            text_font: segoeui_16
            text_color: 0xFFDD44

        # Light selector roller (left side)
        - roller:
            id: light_roller
            align: LEFT_MID
            x: 10
            y: 0
            width: 140
            height: 100
            options:
              - "All Lights"
              - "Bed Interior"
              - "Main Can"
              - "Bed Can"
              - "LED Capsule"
              - "Exterior"
              - "Door"
              - "Dog Crate"
            selected_index: 0
            visible_row_count: 3
            on_value:
              - lambda: |-
                  // Map roller index to light entity
                  const char* lights[] = {
                    "light.all_lights",
                    "light.bed_interior_lights",
                    "light.main_can_lights",
                    "light.bed_can_lights",
                    "light.cwww_led_capsule_lights",
                    "light.exterior_lights",
                    "light.door_light",
                    "light.cwww_led_dog_crate_lights"
                  };
                  int index = id(light_roller).get_selected_index();
                  if (index >= 0 && index < 8) {
                    id(dial_selected_light).set_selected_index(index);
                  }
              - script.execute: update_light_display

        # Toggle button (right side)
        - obj:
            align: RIGHT_MID
            x: -10
            y: 0
            width: 60
            height: 60
            bg_opa: COVER
            bg_color: 0x333333
            border_width: 2
            border_color: 0xFFDD44
            radius: 30
            on_click:
              - homeassistant.service:
                  service: light.toggle
                  data:
                    entity_id: !lambda |-
                      auto index = id(dial_selected_light).active_index();
                      if (index.has_value()) {
                        return id(dial_selected_light).at(index.value()).value();
                      }
                      return std::string("light.bed_interior_lights");
            widgets:
              - label:
                  align: CENTER
                  text: "ON"
                  text_font: segoeui_16
                  text_color: 0xFFDD44

select:
  - platform: template
    name: "Dial Selected Light"
    id: dial_selected_light
    initial_option: light.all_lights
    restore_value: false
    options:
      - light.all_lights
      - light.bed_interior_lights
      - light.main_can_lights
      - light.bed_can_lights
      - light.cwww_led_capsule_lights
      - light.exterior_lights
      - light.door_light
      - light.cwww_led_dog_crate_lights

    set_action: # The action that should be performed when the remote (like Home Assistant’s frontend) requests to set the Select option
      - logger.log:
          format: "Selected light option (remote): %s (index %d)"
          args: ["x.c_str()", "i"]

    on_value:
      then:
        - logger.log:
            format: "Selected light option: %s (index %d)"
            args: ["x.c_str()", "i"]

globals:
  - id: current_brightness
    type: int
    initial_value: "0"

  - id: selected_light_index
    type: int
    initial_value: "0"
    restore_value: yes

  - id: selected_entity
    type: std::string
    initial_value: "light.living_room"
    restore_value: yes

script:
  - id: restore_roller_position
    then:
      - lambda: |-
          // Sync roller with saved selection
          auto index = id(dial_selected_light).active_index();
          if (index.has_value()) {
            id(light_roller).set_selected_index(index.value());
          }
      - script.execute: update_light_display

  - id: update_light_display
    then:
      - lambda: |-
          // before we update the lvgl widget, we need to ensure that current_brightness
          // we need to read the brightness of the currently selected light.
          auto index = id(dial_selected_light).active_index();
          if (index.has_value()) {

            auto selected_option = id(dial_selected_light).at(index.value());

            int brightness = 0;
            if (strcmp(selected_option.c_str(), "light.all_lights") == 0) {
                brightness = (int)roundf((id(light_all_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.bed_interior_lights") == 0) {
                brightness = (int)roundf((id(light_bed_interior_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.main_can_lights") == 0) {
                brightness = (int)roundf((id(light_main_can_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.bed_can_lights") == 0) {
                brightness = (int)roundf((id(light_bed_can_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.cwww_led_capsule_lights") == 0) {
                brightness = (int)roundf((id(light_cwww_led_capsule_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.exterior_lights") == 0) {
                brightness = (int)roundf((id(light_exterior_lights_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.door_light") == 0) {
                brightness = (int)roundf((id(light_door_light_brightness).state / 255.0f) * 100.0f);
            } else if (strcmp(selected_option.c_str(), "light.cwww_led_dog_crate_lights") == 0) {
                brightness = (int)roundf((id(light_cwww_led_dog_crate_lights_brightness).state / 255.0f) * 100.0f);
            } else {
                brightness = 0;
            }

            id(current_brightness) = brightness;
            
            // Update the icon sensor to track the currently selected light
            id(selected_light_icon).set_entity_id(selected_option.c_str());
          }

          // Update LVGL widgets
          id(brightness_arc).set_value(id(current_brightness));
          char buf[8];
          snprintf(buf, sizeof(buf), "%d%%", id(current_brightness));
          id(brightness_pct_label).set_text(buf);

  - id: increase_light_brightness
    then:
      - lambda: |-
          int step = 2;
          id(current_brightness) = std::min(100, id(current_brightness) + step);
          id(publish_brightness_throttled).execute();

  - id: decrease_light_brightness
    then:
      - lambda: |-
          int step = 2;
          id(current_brightness) = std::max(0, id(current_brightness) - step);
          id(publish_brightness_throttled).execute();

  - id: publish_brightness_throttled
    mode: restart
    then:
      - delay: 300ms
      - if:
          condition:
            lambda: 'return id(current_brightness) == 0;'
          then:
            - homeassistant.service:
                service: light.turn_off
                data:
                  entity_id: !lambda 'return id(selected_entity);'
          else:
            - homeassistant.service:
                service: light.turn_on
                data:
                  entity_id: !lambda 'return id(selected_entity);'
                  brightness: !lambda |-
                    // convert 0..100 -> 0..255 and clamp
                    int val = id(current_brightness);
                    int b = (int)(val * 255.0 / 100.0 + 0.5);
                    if (b < 1) b = 1;   // avoid sending 0
                    if (b > 255) b = 255;
                    return b;

sensor:
  - id: !extend rotary_encoder_id
    name: "Rotary Encoder"
    on_clockwise:
      then:
        - script.execute: increase_light_brightness

    on_anticlockwise:
      then:
        - script.execute: decrease_light_brightness

  # Home Assistant brightness attribute sensors for each selectable light.
  - platform: homeassistant
    id: light_all_lights_brightness
    entity_id: light.all_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_bed_interior_lights_brightness
    entity_id: light.bed_interior_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_main_can_lights_brightness
    entity_id: light.main_can_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_bed_can_lights_brightness
    entity_id: light.bed_can_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_cwww_led_capsule_lights_brightness
    entity_id: light.cwww_led_capsule_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_exterior_lights_brightness
    entity_id: light.exterior_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_door_light_brightness
    entity_id: light.door_light
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

  - platform: homeassistant
    id: light_cwww_led_dog_crate_lights_brightness
    entity_id: light.cwww_led_dog_crate_lights
    attribute: brightness
    internal: true
    on_value:
      - script.execute: update_light_display

text_sensor:
  - platform: homeassistant
    id: selected_light_icon
    entity_id: light.all_lights  # Will be updated dynamically
    attribute: icon
    internal: true
    on_value:
      - lambda: |-
          // Convert mdi:icon-name to Unicode character
          std::string icon_name = x;
          
          // Remove "mdi:" prefix if present
          if (icon_name.find("mdi:") == 0) {
            icon_name = icon_name.substr(4);
          }
          
          // Map MDI icon names to Unicode codepoints
          // Reference: https://pictogrammers.com/library/mdi/
          std::map<std::string, const char*> icon_map = {
            {"lightbulb", "\U000F0335"},
            {"lightbulb-outline", "\U000F0336"},
            {"lightbulb-on", "\U000F06E8"},
            {"lightbulb-on-outline", "\U000F06E9"},
            {"floor-lamp", "\U000F08DD"},
            {"ceiling-light", "\U000F0769"},
            {"lamp", "\U000F06B5"},
            {"lava-lamp", "\U000F07D5"},
            {"led-strip", "\U000F07D6"},
            {"led-strip-variant", "\U000F1051"},
            {"spotlight", "\U000F0CF3"},
            {"spotlight-beam", "\U000F0CF4"},
            {"vanity-light", "\U000F11E1"},
            {"wall-sconce", "\U000F091C"},
            {"wall-sconce-flat", "\U000F091D"},
            {"wall-sconce-round", "\U000F0748"},
            {"outdoor-lamp", "\U000F1054"},
          };
          
          auto it = icon_map.find(icon_name);
          if (it != icon_map.end()) {
            id(light_icon_label).set_text(it->second);
          } else {
            // Default to lightbulb if icon not found
            id(light_icon_label).set_text("\U000F0335");
          }
          
          ESP_LOGI("icon", "Light icon changed to: %s", x.c_str());
