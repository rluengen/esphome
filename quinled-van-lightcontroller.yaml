# The QuinLED Van Light Controller leverages the QuinLED An-Penta-Deca hardware platform to provide
# interior and exterior lighting in the van. It features 15 individually controllable LED channels,
# controlling various lights such as roof lights, capsule lights, and rear lights.

substitutions:
  device_name: lightcontroller
  friendly_name: Light Controller
  project_name: Van Light Controller
  project_version: "1.0.0"
  log_level: DEBUG

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
          log_level: DEBUG
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/quinled-an-penta-deca.yaml
      - path: i2c/pcf8574.yaml
      - path: packages/wizmote.yaml

esphome:
  name: led-van-controller
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}

globals:
  - id: current_color_temp
    type: float
    restore_value: no
    initial_value: '4000.0'
    
  - id: current_brightness
    type: float
    restore_value: no
    initial_value: '1.0'

sensor:
  - platform: homeassistant
    name: "Sun Elevation"
    id: sun_elevation
    entity_id: sun.sun
    attribute: elevation
    unit_of_measurement: "°"
    accuracy_decimals: 2
    internal: true
    on_value:
      then:
        - script.execute: adjust_light_color_temperature

# Channel       Description
# ------        ----
# 1             Cabin Can Lights (x4)
# 2             Bed Can Lights (x4)
# 3             Sliding Door Light Strip
# 4             Dog Crate Light Strip (warm)
# 5             Dog Crate Light Strip (cold)
# 6             Garage Light Strip
# 7             Capsule Light Strip (Warm)
# 8             Capsule Light Strip (Cool)
# 9             Awning Outside Light Strip
# 10            Awning Inside Light Strip
# 11            Exterior Capsule Driver Flood Light
# 12            Exterior Capsule Passenger Flood Light
# 13            Roof Passenger Flood Lights
# 14            Roof Driver Flood Lights
# 15            Roof Rear Flood Lights
light:
  - platform: monochromatic
    id: main_can_lights
    name: "Main Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: 500ms
    output: led_channel_1

  - platform: monochromatic
    id: bed_can_lights
    name: "Bed Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: 500ms
    output: led_channel_2

  - platform: monochromatic
    id: door_light
    name: "Door Light"
    icon: "mdi:door_light"
    default_transition_length: 500ms
    output: led_channel_3

  - platform: cwww
    cold_white: led_channel_4
    warm_white: led_channel_5
    id: cwww_led_dog_crate_lights
    name: "Dog Crate Lights"
    icon: "mdi:led-strip"
    default_transition_length: 500ms
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: garage_led_lights
    name: "Garage LED Light"
    default_transition_length: 500ms
    output: led_channel_6

  - platform: cwww
    cold_white: led_channel_7
    warm_white: led_channel_8
    id: cwww_led_capsule_lights
    name: "Bed Capsule Lights"
    icon: "mdi:led-strip"
    default_transition_length: 500ms
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: light_awning_outside_light
    name: "Awning Outside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_9

  - platform: monochromatic
    id: light_awning_inside_light
    name: "Awning Inside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_10

  - platform: monochromatic
    id: light_exterior_passenger_capsule
    name: "Exterior Capsule Passenger Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: 500ms
    output: led_channel_11

  - platform: monochromatic
    id: light_exterior_driver_capsule
    name: "Exterior Capsule Driver Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: 500ms
    output: led_channel_12

  - platform: monochromatic
    id: light_exterior_roof_passenger
    name: "Exterior Roof Passenger Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_13

  - platform: monochromatic
    id: light_exterior_roof_driver
    name: "Exterior Roof Driver Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_14

  - platform: monochromatic
    id: light_exterior_roof_rear
    name: "Exterior Roof Rear Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_15

script:
  - id: update_color_temp_and_brightness
    mode: single
    then:
      - lambda: |-
          // Calculate color temperature based on sun elevation
          // Elevation ranges roughly from -90° (midnight) to +90° (noon)
          float elevation = id(sun_elevation).state;
          
          // Map elevation to color temperature (2700K warm to 6500K cool)
          // During day (positive elevation): cooler/brighter
          // During night (negative elevation): warmer/dimmer

          if (elevation > 0) {
            // Daytime: 0° to 90° elevation
            // Color temp: 4000K to 6500K (cooler during day)
            id(current_color_temp) = 4000 + (elevation / 90.0) * 2500;
            id(current_brightness) = 0.8 + (elevation / 90.0) * 0.2; // 80% to 100%
          } else if (elevation > -6) {
            // Civil twilight: 0° to -6° (golden hour)
            // Color temp: 3000K to 4000K (warm golden light)
            id(current_color_temp) = 3000 + ((elevation + 6) / 6.0) * 1000;
            id(current_brightness) = 0.6 + ((elevation + 6) / 6.0) * 0.2;  // 60% to 80%
          } else if (elevation > -12) {
            // Nautical twilight: -6° to -12°
            // Color temp: 2700K to 3000K (warmer)
            id(current_color_temp) = 2700 + ((elevation + 12) / 6.0) * 300;
            id(current_brightness) = 0.4 + ((elevation + 12) / 6.0) * 0.2;  // 40% to 60%
          } else {
            // Night: < -12° elevation
            // Color temp: 2700K (warmest)
            id(current_brightness) = 0.3;  // 30% for nighttime
            id(current_color_temp) = 2700;
          }

  - id: adjust_light_color_temperature
    mode: restart
    then:
      - script.execute: update_color_temp_and_brightness
      - lambda: |-
          // Only adjust lights that are currently on and auto mode is enabled
          if (id(auto_color_temp_enabled).state) {
            if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
              auto call = id(cwww_led_dog_crate_lights).turn_on();
              call.set_color_temperature(id(current_color_temp));
              call.set_brightness(id(current_brightness));
              call.perform();
            }
            
            if (id(cwww_led_capsule_lights).current_values.is_on()) {
              auto call = id(cwww_led_capsule_lights).turn_on();
              call.set_color_temperature(id(current_color_temp));
              call.set_brightness(id(current_brightness));
              call.perform();
            }

            ESP_LOGD("color_temp", "Elevation: %.1f°, Color Temp: %.0fK, Brightness: %.0f%%", 
                   id(sun_elevation).state, id(current_color_temp), id(current_brightness) * 100);
          }
         
  - id: turn_off_exterior_flood_lights
    then:
      - light.turn_off: light_exterior_roof_rear
      - light.turn_off: light_exterior_roof_driver
      - light.turn_off: light_exterior_roof_passenger
      - light.turn_off: light_exterior_passenger_capsule
      - light.turn_off: light_exterior_driver_capsule
  
  - id: turn_on_exterior_flood_lights
    then:
      - if:
          condition:
            lambda: 'return id(sun_elevation).state < 10;'
          then:
            - light.turn_on: light_exterior_roof_rear
            - light.turn_on: light_exterior_roof_driver
            - light.turn_on: light_exterior_roof_passenger
            - light.turn_on: light_exterior_passenger_capsule
            - light.turn_on: light_exterior_driver_capsule
          else:
            - logger.log: "Exterior lights not turned on - it's daytime"

  - id: toggle_exterior_flood_lights
    then:
      - if:
          condition:
            and:
              - light.is_off: light_exterior_roof_rear
              - light.is_off: light_exterior_roof_driver
              - light.is_off: light_exterior_roof_passenger
              - light.is_off: light_exterior_passenger_capsule
              - light.is_off: light_exterior_driver_capsule
          then:
            - script.execute: turn_on_exterior_flood_lights
          else:
            - script.execute: turn_off_exterior_flood_lights
  
  - id: turn_on_lights
    then:
      - script.execute: turn_on_interior_lights

  - id: turn_off_lights
    then:
      - script.execute: turn_off_exterior_flood_lights
      - script.execute: turn_off_interior_lights
      - light.turn_off: garage_led_lights
      - light.turn_off: light_awning_outside_light
      - light.turn_off: light_awning_inside_light

  - id: turn_on_interior_lights
    then:
      - light.turn_on:
          id: main_can_lights
          brightness: 100%
      - light.turn_on: 
          id: bed_can_lights
          brightness: 100%
      - lambda: |-
          if (id(auto_color_temp_enabled).state) {
            auto call = id(cwww_led_dog_crate_lights).turn_on();
            call.set_color_temperature(id(current_color_temp));
            call.set_brightness(id(current_brightness));
            call.perform();
          } else {
            id(cwww_led_dog_crate_lights).turn_on().perform();
          }
      - lambda: |-
          if (id(auto_color_temp_enabled).state) {
            auto call = id(cwww_led_capsule_lights).turn_on();
            call.set_color_temperature(id(current_color_temp));
            call.set_brightness(id(current_brightness));
            call.perform();
          } else {
            id(cwww_led_capsule_lights).turn_on().perform();
          }

  - id: turn_off_interior_lights
    then:
      - light.turn_off: main_can_lights
      - light.turn_off: bed_can_lights
      - light.turn_off: door_light
      - light.turn_off: cwww_led_dog_crate_lights
      - light.turn_off: cwww_led_capsule_lights

  - id: toggle_interior_lights
    then:
      - if:
          condition:
            and:
              - light.is_off: main_can_lights
              - light.is_off: bed_can_lights
              - light.is_off: door_light
              - light.is_off: cwww_led_dog_crate_lights
              - light.is_off: cwww_led_capsule_lights
          then:
            - light.turn_on: main_can_lights
          else:
            - script.execute: turn_off_interior_lights

binary_sensor:
# Button 1    Garage Light Button             Toggle garage lights on press
  - id: !extend button_1
    name: "Garage LED Light Button"
    internal: true
    on_press:
      - if:
          condition:
            light.is_on: garage_led_lights
          then:
            - logger.log: "Garage LED Light Button pressed, turning off light"
            - light.turn_off: garage_led_lights
          else:
            - logger.log: "Garage LED Light Button pressed, turning on light"
            - lambda: |-
                if (id(auto_color_temp_enabled).state) {
                  auto call = id(garage_led_lights).turn_on();
                  call.set_brightness(id(current_brightness));
                  call.perform();
                } else {
                  id(garage_led_lights).turn_on().perform();
                }

# Button 2    Up Cabin Light Button           tap - Turn on cabin lights
#                                             double tap - Turn on all cabin lights
#                                             press and hold - increase brightness of cabin lights
# Button 3    Down Cabin Light Button         tap - Turn off cabin lights
#                                             double tap - Turn off all cabin lights
#                                             press and hold - decrease brightness of cabin lights

  - id: !extend button_2
    name: "Cabin Interior Lights Button"
    internal: true
    on_multi_click:
      # Single click
      - timing:
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: toggle_interior_lights

      # Double click
      - timing:
          - ON for at most 500ms
          - OFF for at most 500ms
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: turn_on_interior_lights
  
      # Long press
      - timing:
          - ON for at least 1000ms
        then:
          - script.execute: turn_off_interior_lights

  - id: !extend button_3
    internal: true
    name: "Button 3"
    on_press:
      - light.turn_on:
          id: door_light
          brightness: 0%
      - while:
          condition:
            binary_sensor.is_on: button_3
          then:
            - light.dim_relative:
                id: door_light
                relative_brightness: 5%
                transition_length: 100ms
            - delay: 200ms
    on_release:
      - if:
          condition:
            lambda: 'return id(door_light).current_values.get_brightness() < 0.1;'
          then:
            - light.turn_on:
                id: door_light
                brightness: 100%

  - id: !extend button_4
    internal: true

# PFC8574 Buttons
# Button    Pin         Name                            Action
# ------    ------      -----                           ------
# 0         Button 1    Upper Roof Driver Lights        Turn on the upper and lower roof driver lights as long as the button is on
# 1         Button 2    Lower Driver Capsule Lights     Turn on the lower roof driver capsule lights
# 2         Button 3    Rear Roof Lights                tap - Toggle upper rear roof lights
#                                                       double tap - Turn on all exterior lights
#                                                       press and hold - Turn off all exterior lights
# 3         Button 4    Upper Roof Passenger Lights     Turn on the upper and lower roof passenger lights as long as the button is on
# 4         Button 5    Lower Passenger Capsule Lights  Turn on the lower roof passenger capsule lights
  - id: !extend pcf8574_button_0
    name: "Upper Exterior Driver Light Switch"
    internal: true
    on_press:
      - light.turn_on:
          id: light_exterior_roof_driver
          brightness: 100%
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_roof_driver
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_1
    name: "Lower Exterior Driver Light Switch"
    internal: true
    on_press:
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_2
    name: "Rear Exterior Light Switch"
    internal: true
    on_multi_click:
      # Single click
      - timing:
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: toggle_exterior_flood_lights

      # Double click
      - timing:
          - ON for at most 500ms
          - OFF for at most 500ms
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: turn_on_exterior_flood_lights
  
      # Long press
      - timing:
          - ON for at least 1000ms
        then:
          - script.execute: turn_off_exterior_flood_lights

  - id: !extend pcf8574_button_3
    name: "Upper Exterior Passenger Light Switch"
    internal: true
    on_press:
      - light.turn_on:
          id: light_exterior_roof_passenger
          brightness: 100%
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_roof_passenger
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%

  - id: !extend pcf8574_button_4
    name: "Lower Exterior Passenger Light Switch"
    internal: true
    on_press:
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_passenger_capsule

  - id: !extend pcf8574_button_5
    internal: true

  - id: !extend pcf8574_button_6
    internal: true

  - id: !extend pcf8574_button_7
    internal: true

# Wizmote Remote Control Buttons
  - id: !extend wizmote_on
    internal: true
    on_press:
      - script.execute: turn_on_lights
  
  - id: !extend wizmote_off
    internal: true
    on_press:
      - script.execute: turn_off_lights

  - id: !extend wizmote_sleep
    internal: true
    on_press:
      - script.execute: turn_off_exterior_flood_lights
      - light.turn_off: main_can_lights
      - light.turn_off: door_light
      - light.turn_off: cwww_led_dog_crate_lights
      - delay: 30000ms
      - light.turn_off: bed_can_lights

  - id: !extend wizmote_1
    internal: true
    on_press:
      - script.execute: toggle_interior_lights

  - id: !extend wizmote_2
    internal: true
    on_press:
      - script.execute: toggle_exterior_flood_lights

  - id: !extend wizmote_3
    internal: true
  - id: !extend wizmote_4
    internal: true

  - id: !extend wizmote_up
    internal: true
    on_press:
      - lambda: |-
          // Increase brightness for all lights that are currently on
          if (id(main_can_lights).current_values.is_on()) {
            auto call = id(main_can_lights).make_call();
            call.set_brightness(min(1.0f, id(main_can_lights).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(bed_can_lights).current_values.is_on()) {
            auto call = id(bed_can_lights).make_call();
            call.set_brightness(min(1.0f, id(bed_can_lights).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(door_light).current_values.is_on()) {
            auto call = id(door_light).make_call();
            call.set_brightness(min(1.0f, id(door_light).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
            auto call = id(cwww_led_dog_crate_lights).make_call();
            call.set_brightness(min(1.0f, id(cwww_led_dog_crate_lights).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(garage_led_lights).current_values.is_on()) {
            auto call = id(garage_led_lights).make_call();
            call.set_brightness(min(1.0f, id(garage_led_lights).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(cwww_led_capsule_lights).current_values.is_on()) {
            auto call = id(cwww_led_capsule_lights).make_call();
            call.set_brightness(min(1.0f, id(cwww_led_capsule_lights).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_awning_outside_light).current_values.is_on()) {
            auto call = id(light_awning_outside_light).make_call();
            call.set_brightness(min(1.0f, id(light_awning_outside_light).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_awning_inside_light).current_values.is_on()) {
            auto call = id(light_awning_inside_light).make_call();
            call.set_brightness(min(1.0f, id(light_awning_inside_light).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_exterior_passenger_capsule).current_values.is_on()) {
            auto call = id(light_exterior_passenger_capsule).make_call();
            call.set_brightness(min(1.0f, id(light_exterior_passenger_capsule).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_exterior_driver_capsule).current_values.is_on()) {
            auto call = id(light_exterior_driver_capsule).make_call();
            call.set_brightness(min(1.0f, id(light_exterior_driver_capsule).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_passenger).current_values.is_on()) {
            auto call = id(light_exterior_roof_passenger).make_call();
            call.set_brightness(min(1.0f, id(light_exterior_roof_passenger).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_driver).current_values.is_on()) {
            auto call = id(light_exterior_roof_driver).make_call();
            call.set_brightness(min(1.0f, id(light_exterior_roof_driver).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_rear).current_values.is_on()) {
            auto call = id(light_exterior_roof_rear).make_call();
            call.set_brightness(min(1.0f, id(light_exterior_roof_rear).current_values.get_brightness() + 0.1f));
            call.perform();
          }
          ESP_LOGD("wizmote", "Increased brightness for all active lights");

  - id: !extend wizmote_down
    internal: true
    on_press:
      - lambda: |-
          // Decrease brightness for all lights that are currently on
          if (id(main_can_lights).current_values.is_on()) {
            auto call = id(main_can_lights).make_call();
            call.set_brightness(max(0.01f, id(main_can_lights).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(bed_can_lights).current_values.is_on()) {
            auto call = id(bed_can_lights).make_call();
            call.set_brightness(max(0.01f, id(bed_can_lights).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(door_light).current_values.is_on()) {
            auto call = id(door_light).make_call();
            call.set_brightness(max(0.01f, id(door_light).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(cwww_led_dog_crate_lights).current_values.is_on()) {
            auto call = id(cwww_led_dog_crate_lights).make_call();
            call.set_brightness(max(0.01f, id(cwww_led_dog_crate_lights).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(garage_led_lights).current_values.is_on()) {
            auto call = id(garage_led_lights).make_call();
            call.set_brightness(max(0.01f, id(garage_led_lights).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(cwww_led_capsule_lights).current_values.is_on()) {
            auto call = id(cwww_led_capsule_lights).make_call();
            call.set_brightness(max(0.01f, id(cwww_led_capsule_lights).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_awning_outside_light).current_values.is_on()) {
            auto call = id(light_awning_outside_light).make_call();
            call.set_brightness(max(0.01f, id(light_awning_outside_light).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_awning_inside_light).current_values.is_on()) {
            auto call = id(light_awning_inside_light).make_call();
            call.set_brightness(max(0.01f, id(light_awning_inside_light).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_exterior_passenger_capsule).current_values.is_on()) {
            auto call = id(light_exterior_passenger_capsule).make_call();
            call.set_brightness(max(0.01f, id(light_exterior_passenger_capsule).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_exterior_driver_capsule).current_values.is_on()) {
            auto call = id(light_exterior_driver_capsule).make_call();
            call.set_brightness(max(0.01f, id(light_exterior_driver_capsule).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_passenger).current_values.is_on()) {
            auto call = id(light_exterior_roof_passenger).make_call();
            call.set_brightness(max(0.01f, id(light_exterior_roof_passenger).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_driver).current_values.is_on()) {
            auto call = id(light_exterior_roof_driver).make_call();
            call.set_brightness(max(0.01f, id(light_exterior_roof_driver).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          if (id(light_exterior_roof_rear).current_values.is_on()) {
            auto call = id(light_exterior_roof_rear).make_call();
            call.set_brightness(max(0.01f, id(light_exterior_roof_rear).current_values.get_brightness() - 0.1f));
            call.perform();
          }
          ESP_LOGD("wizmote", "Decreased brightness for all active lights");

switch:
  - platform: template
    name: "Auto Color Temperature"
    id: auto_color_temp_enabled
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: config
    on_turn_on:
      - script.execute: adjust_light_color_temperature
    on_turn_off:
      - logger.log: "Auto color temperature disabled"

interval:
  - interval: 5min
    then:
      - if:
          condition:
            switch.is_on: auto_color_temp_enabled
          then:
            - script.execute: adjust_light_color_temperature