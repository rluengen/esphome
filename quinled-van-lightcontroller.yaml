# The QuinLED Van Light Controller leverages the QuinLED An-Penta-Deca hardware platform to provide
# interior and exterior lighting in the van. It features 15 individually controllable LED channels,
# controlling various lights such as roof lights, capsule lights, and rear lights.

# Channel       Description
# ------        ----
# 1             Cabin Can Lights (x4)
# 2             Bed Can Lights (x4)
# 3             Sliding Door Light Strip
# 4             Dog Crate Light Strip (warm)
# 5             Dog Crate Light Strip (cold)
# 6             Garage Light Strip
# 7             Capsule Light Strip (Warm)
# 8             Capsule Light Strip (Cool)
# 9             Awning Outside Light Strip
# 10            Awning Inside Light Strip
# 11            Exterior Capsule Driver Flood Light
# 12            Exterior Capsule Passenger Flood Light
# 13            Roof Passenger Flood Lights
# 14            Roof Driver Flood Lights
# 15            Roof Rear Flood Lights

# Cabin Buttons - hooked in through the pcf8574 GPIO expander
# Upper Driver Roof Lights      Turn upper and lower driver roof lights on while pressed
# Lower Driver Capsule Lights   Turn lower driver capsule lights on while pressed
# Rear Roof Lights              Toggle upper rear roof lights on tap, turn on all exterior lights on double tap, turn off all exterior lights on press and hold
# Upper Passenger Roof Lights   Turn upper and lower passenger roof lights on while pressed
# Lower Passenger Roof Lights   Turn lower passenger capsule lights on while pressed

# Garage Pushbutton             Toggle garage lights on press
# Cabin Pushbutton              Toggle cabin can lights on press, turn on interior lights to preset on double tap, turn off all interior lights on press and hold

# todo: Do I have a direct light switch for the rest of the interior lights? Seems like I should have a toggle button somewhere...

# Cabin Dial Controller - connected to home assistant to control brightness of various light groups
# Bed Dial Controller - connected to home assistant to control brightness of various light groups

substitutions:
  device_name: quinled_van_lightcontroller
  friendly_name: QuinLED An-Penta-Deca LED Controller
  project_name: Van Light Controller
  project_version: "1.0.0"

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
          log_level: INFO
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: devices/quinled-an-penta-deca.yaml
      - path: i2c/pcf8574.yaml

esphome:
  name: led-van-controller
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}

light:
  - platform: monochromatic
    id: main_can_lights
    name: "Main Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: 500ms
    output: led_channel_1

  - platform: monochromatic
    id: bed_can_lights
    name: "Bed Can Lights"
    icon: "mdi:light-recessed"
    default_transition_length: 500ms
    output: led_channel_2

  - platform: monochromatic
    id: door_light
    name: "Door Light"
    icon: "mdi:door_light"
    default_transition_length: 500ms
    output: led_channel_3

  - platform: cwww
    cold_white: led_channel_4
    warm_white: led_channel_5
    id: cwww_led_dog_crate_lights
    name: "Dog Crate Lights"
    icon: "mdi:led-strip"
    default_transition_length: 500ms
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: garage_led_lights
    name: "Garage LED Light"
    default_transition_length: 500ms
    output: led_channel_6

  - platform: cwww
    cold_white: led_channel_7
    warm_white: led_channel_8
    id: cwww_led_capsule_lights
    name: "Bed Capsule Lights"
    icon: "mdi:led-strip"
    default_transition_length: 500ms
    cold_white_color_temperature: 6500 K
    warm_white_color_temperature: 2700 K

  - platform: monochromatic
    id: light_awning_outside_light
    name: "Awning Outside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_9

  - platform: monochromatic
    id: light_awning_inside_light
    name: "Awning Inside Light Strip"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_10

  - platform: monochromatic
    id: light_exterior_passenger_capsule
    name: "Exterior Capsule Passenger Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: 500ms
    output: led_channel_11

  - platform: monochromatic
    id: light_exterior_driver_capsule
    name: "Exterior Capsule Driver Flood Light"
    icon: "mdi:wall-sconce-flat"
    default_transition_length: 500ms
    output: led_channel_12

  - platform: monochromatic
    id: light_exterior_roof_passenger
    name: "Exterior Roof Passenger Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_13

  - platform: monochromatic
    id: light_exterior_roof_driver
    name: "Exterior Roof Driver Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_14

  - platform: monochromatic
    id: light_exterior_roof_rear
    name: "Exterior Roof Rear Flood Light"
    icon: "mdi:light-flood-down"
    default_transition_length: 500ms
    output: led_channel_15

# Button    Pin         Name                            Action
# ------    ------      -----                           ------
# 1         Button 1    Upper Roof Driver Lights        Turn on the upper and lower roof driver lights as long as the button is on
# 2         Button 2    Upper Roof Passenger Lights     Turn on the upper and lower roof passenger lights
# 3         Button 3    Lower Driver Capsule Lights     Turn on the lower roof driver capsule lights
# 4         Button 4    Lower Passenger Capsule Lights  Turn on the lower roof passenger capsule lights
# 5         Button 5    Rear Roof Lights                tap - Toggle upper rear roof lights
#                                                       double tap - Turn on all exterior lights
#                                                       press and hold - Turn off all exterior lights

# PCF8574 Port Expansion Board which has 8 additional GPIO pins per board.
# This allows us to connect multiple buttons to the QuinLED An-Penta-Deca.

script:
  - id: turn_off_exterior_flood_lights
    then:
      - light.turn_off: light_exterior_roof_rear
      - light.turn_off: light_exterior_roof_driver
      - light.turn_off: light_exterior_roof_passenger
      - light.turn_off: light_exterior_passenger_capsule
      - light.turn_off: light_exterior_driver_capsule
  
  - id: turn_on_exterior_flood_lights
    then:
      - light.turn_on: light_exterior_roof_rear
      - light.turn_on: light_exterior_roof_driver
      - light.turn_on: light_exterior_roof_passenger
      - light.turn_on: light_exterior_passenger_capsule
      - light.turn_on: light_exterior_driver_capsule

  - id: toggle_exterior_flood_lights
    then:
      - if:
          condition:
            and:
              - light.is_off: light_exterior_roof_rear
              - light.is_off: light_exterior_roof_driver
              - light.is_off: light_exterior_roof_passenger
              - light.is_off: light_exterior_passenger_capsule
              - light.is_off: light_exterior_driver_capsule
          then:
            - script.execute: turn_on_exterior_flood_lights
          else:
            - script.execute: turn_off_exterior_flood_lights

  - id: turn_on_interior_lights
    then:
      - light.turn_on: main_can_lights
      - light.turn_on: bed_can_lights
      - light.turn_on: door_light
      - light.turn_on: cwww_led_dog_crate_lights
      - light.turn_on: cwww_led_capsule_lights

  - id: turn_off_interior_lights
    then:
      - light.turn_off: main_can_lights
      - light.turn_off: bed_can_lights
      - light.turn_off: door_light
      - light.turn_off: cwww_led_dog_crate_lights
      - light.turn_off: cwww_led_capsule_lights

  - id: toggle_interior_lights
    then:
      - if:
          condition:
            and:
              - light.is_off: main_can_lights
              - light.is_off: bed_can_lights
              - light.is_off: door_light
              - light.is_off: cwww_led_dog_crate_lights
              - light.is_off: cwww_led_capsule_lights
          then:
            - light.turn_on: main_can_lights
          else:
            - script.execute: turn_off_interior_lights

binary_sensor:
  - id: !extend button_1
    name: "Garage LED Light Button"
    on_press:
      - if:
          condition:
            light.is_on: garage_led_lights
          then:
            - logger.log: "Garage LED Light Button pressed, turning off light"
            - light.turn_off: garage_led_lights
          else:
            - logger.log: "Garage LED Light Button pressed, turning on light to 100%"
            - light.turn_on:
                id: garage_led_lights
                brightness: 100%

  - id: !extend button_2
    name: "Cabin Interior Lights Button"
    on_multi_click:
      # Single click
      - timing:
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: toggle_interior_lights

      # Double click
      - timing:
          - ON for at most 500ms
          - OFF for at most 500ms
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: turn_on_interior_lights
  
      # Long press
      - timing:
          - ON for at least 1000ms
        then:
          - script.execute: turn_off_interior_lights
    internal: true

  - id: !extend button_3
    internal: true

  - id: !extend button_4
    internal: true
  
  - id: !extend pcf8574_button_0
    name: "Upper Exterior Driver Light Switch"
    on_press:
      - light.turn_on:
          id: light_exterior_roof_driver
          brightness: 100%
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_roof_driver
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_1
    name: "Lower Exterior Driver Light Switch"
    on_press:
      - light.turn_on:
          id: light_exterior_driver_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_driver_capsule

  - id: !extend pcf8574_button_2
    name: "Rear Exterior Light Switch"
    on_multi_click:
      # Single click
      - timing:
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: toggle_exterior_flood_lights

      # Double click
      - timing:
          - ON for at most 500ms
          - OFF for at most 500ms
          - ON for at most 500ms
          - OFF for at least 100ms
        then:
          - script.execute: turn_on_exterior_flood_lights
  
      # Long press
      - timing:
          - ON for at least 1000ms
        then:
          - script.execute: turn_off_exterior_flood_lights

  - id: !extend pcf8574_button_3
    name: "Upper Exterior Passenger Light Switch"
    on_press:
      - light.turn_on:
          id: light_exterior_roof_passenger
          brightness: 100%
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_roof_passenger
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%

  - id: !extend pcf8574_button_4
    name: "Lower Exterior Passenger Light Switch"
    on_press:
      - light.turn_on:
          id: light_exterior_passenger_capsule
          brightness: 100%
    on_release:
      - light.turn_off:
          id: light_exterior_passenger_capsule

  - id: !extend pcf8574_button_5
    internal: true

  - id: !extend pcf8574_button_6
    internal: true

  - id: !extend pcf8574_button_7
    internal: true
