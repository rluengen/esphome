substitutions:
  device_name: gps
  friendly_name: Global Positioning System
  project_name:  Mercedes Sprinter Control Modules
  project_version: "1.0.0"
  log_level: DEBUG

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/time/homeassistant.yaml
      - path: packages/gps-receiver.yaml
        vars:
          tx_pin: GPIO21
          rx_pin: GPIO20
      - path: devices/xiao-esp32c3.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: smartvan.${project_name}
    version: ${project_version}
  on_boot:
    priority: -10
    then:
      - delay: 500ms  # Let GPS stabilize
      - lambda: |-
          std::string rate = id(gps_rate_select).state;
          if (rate == "1Hz (Low Power)") {
            id(gps_uart).write_str("$PMTK220,1000*1F\r\n");
          } else if (rate == "5Hz (Normal)") {
            id(gps_uart).write_str("$PMTK220,200*2C\r\n");
          } else if (rate == "10Hz (High Speed)") {
            id(gps_uart).write_str("$PMTK220,100*2F\r\n");
          }
          ESP_LOGI("gps", "Applied saved GPS rate: %s", rate.c_str());