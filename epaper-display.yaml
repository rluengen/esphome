# https://jnan.co/tools/esphomelvglsim/

# Dashboard to display home assistant status and weather information.

# https://wikitwist.com/how-to-use-the-seeedstudio-reterminal-e1001-with-home-assistant-via-esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome/
# https://wiki.seeedstudio.com/reterminal_e10xx_with_esphome_advanced/

substitutions:
  device_name: terminal
  friendly_name: "Terminal Display"
  project_name: terminal-display
  project_version: "1.0.2"
  log_level: DEBUG
  sleep_duration: 15min

packages:
  remote_packages:
    url: https://github.com/rluengen/esphome
    ref: main
    refresh: always
    files:
      - path: packages/common.yaml
        vars:
          api_encryption_key: !secret encryption_key
      - path: packages/time/homeassistant.yaml
      - path: packages/time/sntp.yaml
      - path: packages/network/wifi.yaml
        vars:
          wifi_ssid: !secret wifi_ssid
          wifi_password: !secret wifi_password
      - path: packages/icons/network_icons.yaml
        vars:
          icon_bpp: 1
      - path: packages/icons/battery_icons.yaml
        vars:
          icon_bpp: 1
      - path: packages/icons/homeassistant_icons.yaml
        vars:
          icon_bpp: 1
      - path: devices/reterminal-e1001.yaml
      - path: packages/ota/http_update.yaml


esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  comment: "Terminal Dashboard Display"
  project:
    name: smartvan.${project_name}
    version: ${project_version}
  on_boot:
    priority: -100  # Run after all components are initialized (including SPI)
    then:
      - logger.log:
          level: INFO
          format: "[BOOT] ESPHome on_boot starting (priority -100)"
      - lambda: |-
          int cause = esp_sleep_get_wakeup_cause();
          const char* cause_str;
          switch (cause) {
            case 0: cause_str = "Not from deep sleep"; break;
            case 1: cause_str = "EXT0 (RTC_IO)"; break;
            case 2: cause_str = "EXT1 (RTC_CNTL)"; break;
            case 3: cause_str = "Timer"; break;
            case 4: cause_str = "Touchpad"; break;
            case 5: cause_str = "ULP"; break;
            case 6: cause_str = "GPIO"; break;
            case 7: cause_str = "UART"; break;
            default: cause_str = "Unknown"; break;
          }
          ESP_LOGI("BOOT", "Wakeup cause: %d (%s)", cause, cause_str);
          // Store wakeup cause for use in automations
          id(wakeup_from_sleep) = (cause != 0);
      # - logger.log:
      #     level: INFO
      #     format: "[BOOT] Pausing LVGL"
      # - lvgl.pause:
      - script.execute: update_display
      - script.execute: daily_ota_check
      - script.execute: validate_ha_sensors
      - logger.log:
          level: INFO
          format: "[BOOT] Boot sequence complete"

logger:
  level: ${log_level}
  baud_rate: 115200
  hardware_uart: UART0

# Globals for state tracking
globals:
  - id: wakeup_from_sleep
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: boot_complete
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: last_update_check
    type: uint32_t
    restore_value: yes
    initial_value: '0'

# Script to update display - called from boot and interval
script:
  - id: update_display
    mode: single  # Prevent multiple concurrent executions
    then:
      # Wait for API connection so HA sensors are available
      - logger.log:
          level: INFO
          format: "[DISPLAY] Waiting for API connection..."
      - wait_until:
          condition:
            binary_sensor.is_on: api_connected
          timeout: 30s
      - lambda: |-
          if (id(api_connected).state) {
            ESP_LOGI("DISPLAY", "API connected - waiting for sensor data...");
          } else {
            ESP_LOGW("DISPLAY", "API connection timeout - proceeding anyway");
          }
      # Give HA sensors time to populate after API connects
      - delay: 2s
      # Wait for time to be valid (up to 30 seconds)
      - logger.log:
          level: INFO
          format: "[DISPLAY] Waiting for time sync..."
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid() || id(sntp_time).now().is_valid();'
          timeout: 30s
      - lambda: |-
          if (id(ha_time).now().is_valid()) {
            ESP_LOGI("DISPLAY", "Time valid from Home Assistant");
          } else if (id(sntp_time).now().is_valid()) {
            ESP_LOGI("DISPLAY", "Time valid from SNTP");
          } else {
            ESP_LOGW("DISPLAY", "Time sync timeout - proceeding anyway");
          }
      - logger.log:
          level: INFO
          format: "[DISPLAY] Enabling battery measurement"
      - output.turn_on: bsp_battery_enable
      - delay: 200ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating battery sensors"
      - component.update: battery_voltage
      - component.update: sht4x_component
      - delay: 200ms
      # Wait for battery voltage to be valid
      - wait_until:
          condition:
            lambda: 'return !isnan(id(battery_voltage).state);'
          timeout: 5s
      - lambda: |-
          ESP_LOGI("DISPLAY", "Battery voltage: %.3fV", id(battery_voltage).state);
      - component.update: battery_level
      - delay: 200ms
      - component.update: battery_level
      - delay: 100ms
      - lambda: |-
          ESP_LOGI("DISPLAY", "Sensors - Fuel: %.1f%%, DEF: %.1f%%, Vehicle Battery: %.1f%%, Device Battery: %.0f%% (%.2fV)",
            id(fuel_level).state, id(def_level).state, id(vehicle_battery).state,
            id(battery_level).state, id(battery_voltage).state);
      - logger.log:
          level: INFO
          format: "[DISPLAY] Resuming LVGL"
      - lvgl.resume:
      - delay: 50ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating all widgets"
      # Status bar widgets
      - lvgl.label.update:
          id: lbl_status_location
          text: !lambda |-
            if (!id(location_city).state.empty() && !id(location_state).state.empty()) {
              static char buf[64];
              snprintf(buf, sizeof(buf), "%s, %s", 
                id(location_city).state.c_str(), 
                id(location_state).state.c_str());
              return buf;
            }
            if (!isnan(id(location_latitude).state) && !isnan(id(location_longitude).state)) {
              static char buf[32];
              snprintf(buf, sizeof(buf), "%.4f, %.4f", 
                id(location_latitude).state, 
                id(location_longitude).state);
              return buf;
            }
            return "-- , --";
      - lvgl.label.update:
          id: lbl_status_date
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) {
              ESP_LOGI("DISPLAY", "[TIME] ha_time is invalid, falling back to sntp_time");
              time = id(sntp_time).now();
            }

            if (time.is_valid()) {
              static char buf[40];
              snprintf(buf, sizeof(buf), "%s %s %d, %d", 
                time.strftime("%A").c_str(),
                time.strftime("%B").c_str(),
                time.day_of_month,
                time.year);
              return buf;
            }
            
            ESP_LOGI("DISPLAY", "[TIME] time is invalid");
            return "-- --, ----";
      - lvgl.label.update:
          id: lbl_ha_status
          text: !lambda |-
            if (id(api_connected).state) {
              ESP_LOGI("DISPLAY", "[API] API is connected");
              return "\U000F06A1";
            }
            ESP_LOGI("DISPLAY", "[API] API is not connected");
            return "\U000F0F21";
      - lvgl.label.update:
          id: lbl_wifi_status
          text: !lambda |-
            if (!id(wifi_connected).state) {
              return "\U000F05AA";
            }
            int rssi = (int)id(wifi_signal_db).state;
            if (rssi >= -50) return "\U000F0928";
            else if (rssi >= -60) return "\U000F0925";
            else if (rssi >= -70) return "\U000F0922";
            else if (rssi >= -80) return "\U000F091F";
            return "\U000F092F";
      - lvgl.label.update:
          id: lbl_battery_percent
          text: !lambda |-
            if (isnan(id(battery_level).state)) 
            {
              ESP_LOGI("BATTERY", "Battery percent is invalid");
              return "-- %";
            }
            static char buf[8];
            snprintf(buf, sizeof(buf), "%d%%", (int)id(battery_level).state);
            ESP_LOGI("BATTERY", "Setting battery percent label to: '%s'", buf);
            return buf;
      - lvgl.label.update:
          id: lbl_battery_status
          text: !lambda |-
            if (isnan(id(battery_level).state)) {
              ESP_LOGI("BATTERY", "Battery percent is invalid");
              return "\U000F0091";
            }

            ESP_LOGI("BATTERY", "Battery percent: %.1f%%", id(battery_level).state);

            int x = (int)id(battery_level).state;
            if (x >= 95) return "\U000F0079";
            else if (x >= 85) return "\U000F0082";
            else if (x >= 75) return "\U000F0081";
            else if (x >= 65) return "\U000F0080";
            else if (x >= 55) return "\U000F007F";
            else if (x >= 45) return "\U000F007E";
            else if (x >= 35) return "\U000F007D";
            else if (x >= 25) return "\U000F007C";
            else if (x >= 15) return "\U000F007B";
            else if (x >= 5)  return "\U000F007A";
            else return "\U000F008E";
      # Weather widgets
      - lvgl.label.update:
          id: lbl_weather_temp
          text: !lambda |-
            if (!id(weather_temp).state.empty()) {
              return id(weather_temp).state.c_str();
            }
            return "--°";
      - lvgl.label.update:
          id: lbl_weather_condition
          text: !lambda |-
            if (!id(weather_condition).state.empty()) {
              return id(weather_condition).state.c_str();
            }
            return "Unknown";
      # Sunrise/Sunset widgets
      - lvgl.label.update:
          id: lbl_sunrise_time
          text: !lambda |-
            if (!id(sunrise_time).state.empty()) {
              return id(sunrise_time).state.c_str();
            }
            return "--:--";
      - lvgl.label.update:
          id: lbl_sunset_time
          text: !lambda |-
            if (!id(sunset_time).state.empty()) {
              return id(sunset_time).state.c_str();
            }
            return "--:--";
      # Interior climate widgets
      - lvgl.label.update:
          id: lbl_interior_temp
          text: !lambda |-
            if (isnan(id(sht4x_temperature).state)) return "--°";
            static char buf[16];
            float temp = id(sht4x_temperature).state;
            bool use_f = (id(temp_unit_select).current_option() == "F");
            if (use_f) {
              temp = temp * 9.0f / 5.0f + 32.0f;
              snprintf(buf, sizeof(buf), "%.1f°F", temp);
            } else {
              snprintf(buf, sizeof(buf), "%.1f°C", temp);
            }
            return buf;
      - lvgl.label.update:
          id: lbl_interior_humidity
          text: !lambda |-
            if (isnan(id(sht4x_humidity).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(sht4x_humidity).state);
            return buf;
      - lvgl.label.update:
          id: lbl_fridge_temp
          text: !lambda |-
            if (isnan(id(fridge_temp).state)) return "--°";
            static char buf[16];
            float temp = id(fridge_temp).state;
            bool use_f = (id(temp_unit_select).current_option() == "F");
            if (use_f) {
              temp = temp * 9.0f / 5.0f + 32.0f;
              snprintf(buf, sizeof(buf), "%.1f°F", temp);
            } else {
              snprintf(buf, sizeof(buf), "%.1f°C", temp);
            }
            return buf;
      # Air quality widgets
      - lvgl.label.update:
          id: lbl_co2_value
          text: !lambda |-
            if (isnan(id(air_co2).state)) return "--ppm";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0fppm", id(air_co2).state);
            return buf;
      - lvgl.label.update:
          id: lbl_co2_status
          text: !lambda |-
            if (isnan(id(air_co2).state)) return "";
            float val = id(air_co2).state;
            if (val < 800) return "Good";
            if (val < 1000) return "Fair";
            if (val < 1500) return "Poor";
            return "Bad";
      - lvgl.label.update:
          id: lbl_pm25_value
          text: !lambda |-
            if (isnan(id(air_pm25).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_pm25).state);
            return buf;
      - lvgl.label.update:
          id: lbl_pm25_status
          text: !lambda |-
            if (isnan(id(air_pm25).state)) return "";
            float val = id(air_pm25).state;
            if (val < 12) return "Good";
            if (val < 35) return "Fair";
            if (val < 55) return "Poor";
            return "Bad";
      - lvgl.label.update:
          id: lbl_voc_value
          text: !lambda |-
            if (isnan(id(air_voc).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_voc).state);
            return buf;
      - lvgl.label.update:
          id: lbl_voc_status
          text: !lambda |-
            if (isnan(id(air_voc).state)) return "";
            float val = id(air_voc).state;
            if (val < 150) return "Good";
            if (val < 250) return "Fair";
            if (val < 400) return "Poor";
            return "Bad";
      - lvgl.label.update:
          id: lbl_nox_value
          text: !lambda |-
            if (isnan(id(air_nox).state)) return "--";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f", id(air_nox).state);
            return buf;
      - lvgl.label.update:
          id: lbl_nox_status
          text: !lambda |-
            if (isnan(id(air_nox).state)) return "";
            float val = id(air_nox).state;
            if (val < 20) return "Good";
            if (val < 50) return "Fair";
            if (val < 150) return "Poor";
            return "Bad";
      # Arc widgets
      - lvgl.label.update:
          id: lbl_fuel_value
          text: !lambda |-
            if (isnan(id(fuel_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(fuel_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_fuel
          value: !lambda 'return isnan(id(fuel_level).state) ? 0 : (int)id(fuel_level).state;'
      - lvgl.label.update:
          id: lbl_fuel_range
          text: !lambda |-
            if (isnan(id(fuel_range_calculated).state)) return "-- mi";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mi", id(fuel_range_calculated).state);
            return buf;
      - lvgl.label.update:
          id: lbl_def_value
          text: !lambda |-
            if (isnan(id(def_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(def_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_def
          value: !lambda 'return isnan(id(def_level).state) ? 0 : (int)id(def_level).state;'
      - lvgl.label.update:
          id: lbl_def_range
          text: !lambda |-
            if (isnan(id(def_range_calculated).state)) return "-- mi";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mi", id(def_range_calculated).state);
            return buf;
      - lvgl.label.update:
          id: lbl_vehicle_battery_value
          text: !lambda |-
            if (isnan(id(vehicle_battery).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(vehicle_battery).state);
            return buf;
      - lvgl.arc.update:
          id: arc_battery
          value: !lambda 'return isnan(id(vehicle_battery).state) ? 0 : (int)id(vehicle_battery).state;'
      - lvgl.label.update:
          id: lbl_battery_time
          text: !lambda |-
            if (isnan(id(battery_time_remaining).state)) return "-- hrs";
            static char buf[16];
            float hrs = id(battery_time_remaining).state;
            if (hrs >= 24) {
              snprintf(buf, sizeof(buf), "%.0f days", hrs / 24.0f);
            } else {
              snprintf(buf, sizeof(buf), "%.1f hrs", hrs);
            }
            return buf;
      - lvgl.label.update:
          id: lbl_water_value
          text: !lambda |-
            if (isnan(id(water_level).state)) return "--%";
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.0f%%", id(water_level).state);
            return buf;
      - lvgl.arc.update:
          id: arc_water
          value: !lambda 'return isnan(id(water_level).state) ? 0 : (int)id(water_level).state;'
      - lvgl.label.update:
          id: lbl_water_time
          text: !lambda |-
            if (isnan(id(water_time_remaining).state)) return "-- hrs";
            static char buf[16];
            float hrs = id(water_time_remaining).state;
            if (hrs >= 24) {
              snprintf(buf, sizeof(buf), "%.0f days", hrs / 24.0f);
            } else {
              snprintf(buf, sizeof(buf), "%.1f hrs", hrs);
            }
            return buf;
      - logger.log:
          level: INFO
          format: "[DISPLAY] All widgets updated, waiting for LVGL to process..."
      - delay: 100ms  # Give LVGL time to process all updates
      - logger.log:
          level: INFO
          format: "[DISPLAY] Updating epaper display"
      - component.update: epaper_display
      - delay: 100ms
      - logger.log:
          level: INFO
          format: "[DISPLAY] Disabling battery measurement"
      - output.turn_off: bsp_battery_enable
      - lambda: 'id(boot_complete) = true;'
      - logger.log:
          level: INFO
          format: "[DISPLAY] Update complete"
      - logger.log:
          level: INFO
          format: "[DISPLAY] Pausing LVGL"
      - lvgl.pause:

  - id: daily_ota_check
    mode: single
    then:
      # Wait for network + time before checking
      - wait_until:
          condition:
            wifi.connected:
          timeout: 30s
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid() || id(sntp_time).now().is_valid();'
          timeout: 30s
      - lambda: |-
          auto time = id(ha_time).now();
          if (!time.is_valid()) time = id(sntp_time).now();
          if (!time.is_valid()) {
            ESP_LOGW("OTA", "No valid time - skipping update check");
            return;
          }
          uint32_t now_epoch = time.timestamp;
          uint32_t last = id(last_update_check);
          uint32_t elapsed = now_epoch - last;
          ESP_LOGI("OTA", "Last update check: %us ago (threshold: 86400s)", elapsed);
          if (last == 0 || elapsed >= 86400) {
            ESP_LOGI("OTA", "24h elapsed - checking for firmware update");
            id(last_update_check) = now_epoch;
            id(daily_ota_check_run).execute();
          } else {
            ESP_LOGI("OTA", "Skipping update check - next in %us", 86400 - elapsed);
          }

  - id: daily_ota_check_run
    mode: single
    then:
      - update.check: firmware_update
      - wait_until:
          condition:
            lambda: 'return id(firmware_update).state != update::UPDATE_STATE_UNKNOWN;'
          timeout: 30s
      - if:
          condition:
            lambda: 'return id(firmware_update).state == update::UPDATE_STATE_AVAILABLE;'
          then:
            - logger.log:
                level: INFO
                format: "[OTA] Update available - installing automatically"
            - update.perform: firmware_update
          else:
            - logger.log:
                level: INFO
                format: "[OTA] Firmware is up to date"

  - id: validate_ha_sensors
    mode: single
    then:
      - logger.log:
          level: INFO
          format: "[HA_VALIDATE] Waiting for Home Assistant API connection..."
      - wait_until:
          condition:
            api.connected:
          timeout: 60s
      - if:
          condition:
            not:
              api.connected:
          then:
            - logger.log:
                level: ERROR
                format: "[HA_VALIDATE] Timed out waiting for Home Assistant API connection. Cannot validate sensors."
          else:
            - logger.log:
                level: INFO
                format: "[HA_VALIDATE] API connected. Waiting for initial state sync..."
            - delay: 5s  # Brief delay for HA to push initial entity states after API connects
            - logger.log:
                level: INFO
                format: "[HA_VALIDATE] Checking Home Assistant sensor availability..."
      - lambda: |-
          int missing = 0;
          // Numeric sensors
          if (isnan(id(location_latitude).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.global_positioning_system_latitude (id: location_latitude)"); missing++; }
          if (isnan(id(location_longitude).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.global_positioning_system_longitude (id: location_longitude)"); missing++; }
          if (isnan(id(fuel_level).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.fuel_level (id: fuel_level)"); missing++; }
          if (isnan(id(def_level).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.def_level (id: def_level)"); missing++; }
          if (isnan(id(vehicle_battery).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.vehicle_battery (id: vehicle_battery)"); missing++; }
          if (isnan(id(air_co2).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.airgradient_carbon_dioxide (id: air_co2)"); missing++; }
          if (isnan(id(air_pm25).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.airgradient_pm2_5 (id: air_pm25)"); missing++; }
          if (isnan(id(air_voc).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.airgradient_voc_index (id: air_voc)"); missing++; }
          if (isnan(id(air_nox).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.airgradient_nox_index (id: air_nox)"); missing++; }
          if (isnan(id(fridge_temp).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.fridge_temperature (id: fridge_temp)"); missing++; }
          if (isnan(id(water_level).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.water_level (id: water_level)"); missing++; }
          if (isnan(id(fuel_range).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.fuel_range (id: fuel_range)"); missing++; }
          if (isnan(id(def_range).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.def_range (id: def_range)"); missing++; }
          if (isnan(id(battery_time_remaining).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.battery_time_remaining (id: battery_time_remaining)"); missing++; }
          if (isnan(id(water_time_remaining).state)) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.water_time_remaining (id: water_time_remaining)"); missing++; }
          // Text sensors
          if (id(weather_condition).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: weather.forecast_home attribute:condition (id: weather_condition)"); missing++; }
          if (id(weather_temp).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: weather.forecast_home attribute:temperature (id: weather_temp)"); missing++; }
          if (id(location_city).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.location_city (id: location_city)"); missing++; }
          if (id(location_state).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.location_state (id: location_state)"); missing++; }
          if (id(sunrise_time).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.sunrise (id: sunrise_time)"); missing++; }
          if (id(sunset_time).state.empty()) { ESP_LOGW("HA_VALIDATE", "MISSING: sensor.sunset (id: sunset_time)"); missing++; }
          // Summary
          if (missing > 0) {
            ESP_LOGW("HA_VALIDATE", "==> %d sensor(s) not found in Home Assistant. Update the entity_id values in epaper-display.yaml to match your HA entities.", missing);
          } else {
            ESP_LOGI("HA_VALIDATE", "All Home Assistant sensors connected successfully!");
          }

  - id: page_previous
    mode: single
    then:
      - logger.log:
          level: INFO
          format: "[PAGE] Going to previous page"
      - lvgl.resume:
      - lvgl.page.previous:
          time: 0ms
      - delay: 50ms
      - component.update: epaper_display
      - delay: 100ms
      - lvgl.pause:

  - id: page_next
    mode: single
    then:
      - logger.log:
          level: INFO
          format: "[PAGE] Going to next page"
      - lvgl.resume:
      - lvgl.page.next:
          time: 0ms
      - delay: 50ms
      - component.update: epaper_display
      - delay: 100ms
      - lvgl.pause:

binary_sensor:
  - id: !extend button_left
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Left button pressed - going to previous page"
        - script.execute: page_previous

  - id: !extend button_right
    on_press:
      then:
        - logger.log:
            level: INFO
            format: "[BUTTON] Right button pressed - going to next page"
        - script.execute: page_next

  # API connection status
  - platform: status
    id: api_connected
    name: "API Connected"

  # WiFi connection status (uses template to check if signal exists)
  - platform: template
    id: wifi_connected
    name: "WiFi Connected"
    lambda: |-
      return !isnan(id(wifi_signal_db).state) && id(wifi_signal_db).state < 0;

  # Battery charging status (USB/external power connected)
  # Per Seeed wiki: voltage > 4.5V indicates USB power is connected
  - platform: template
    id: battery_charging
    name: "Battery Charging"
    lambda: |-
      // Returns true if USB/external power is connected
      // When on battery alone, voltage maxes out around 4.15-4.2V
      // When USB is connected, voltage reading exceeds 4.5V
      return !isnan(id(battery_voltage).state) && id(battery_voltage).state > 4.5;

font:
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_18
    size: 18
    bpp: 1
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°₂"
  
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_22
    size: 22
    bpp: 1
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"
  
  - file: "fonts/Roboto-Regular.ttf"
    id: roboto_26
    size: 26
    bpp: 1
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°"

  # Large weather icon for main display
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: weather_icon_large
    size: 48
    bpp: 1
    glyphs: [
      "\U000F0599", # weather-sunny
      ]

  # Small weather icons for sunrise/sunset
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: sun_icons
    size: 24
    bpp: 1
    glyphs: [
      "\U000F0599", # weather-sunny
      "\U000F059C", # weather-sunset-up (sunrise)
      "\U000F059B", # weather-sunset-down (sunset)
      ]

  # Climate icons for interior/fridge
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: climate_icons
    size: 20
    bpp: 1
    glyphs: [
      "\U000F11D4", # rv-truck (interior)
      "\U000F15EE", # fridge-industrial
      "\U000F0058", # water-percent (humidity)
      ]

interval:
  - interval: ${sleep_duration}
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete);'
          then:
            - logger.log:
                level: INFO
                format: "[INTERVAL] Refresh triggered"
            - script.execute: update_display
          else:
            - logger.log:
                level: INFO
                format: "[INTERVAL] Skipped - boot not complete"

lvgl:
  buffer_size: 10%  # Further reduced buffer for e-paper to prevent memory exhaustion
  border_width: 0
  outline_width: 0
  shadow_width: 0
  text_font: roboto_18
  align: center
  resume_on_input: false  # Don't auto-resume on input - we control rendering manually

  # Style definitions for reusable styling (inverted for e-paper)
  # Note: 7.50inv2 is 2-color only (black/white), no grayscale
  style_definitions:
    - id: style_arc
      arc_width: 18
      arc_color: 0x000000  # Black in LVGL → white on e-paper (unfilled track)
      arc_rounded: true
    - id: style_arc_indicator
      arc_width: 18
      arc_color: 0xFFFFFF  # White in LVGL → black on e-paper (filled portion)

  on_idle:
    timeout: 10s
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_idle triggered (10s timeout)"
      - lambda: |-
          ESP_LOGI("LVGL", "Idle timeout reached - display inactive for 10s");
  
  on_ready:
    then:
      - logger.log:
          level: INFO
          format: "[LVGL] on_ready - LVGL initialized"
      - lambda: |-
          ESP_LOGI("LVGL", "LVGL ready and initialized");

  on_pause:
    - logger.log:
        level: INFO
        format: "[LVGL] on_pause triggered"
    - lambda: |-
        ESP_LOGI("LVGL", "Battery charging: %s, voltage: %.2fV", 
          id(battery_charging).state ? "YES" : "NO", id(battery_voltage).state);
    # Wait for background scripts to finish before sleeping
    - if:
        condition:
          lambda: 'return id(daily_ota_check).is_running() || id(daily_ota_check_run).is_running();'
        then:
          - logger.log:
              level: INFO
              format: "[LVGL] Waiting for OTA check to complete before sleep..."
          - wait_until:
              condition:
                lambda: 'return !id(daily_ota_check).is_running() && !id(daily_ota_check_run).is_running();'
              timeout: 120s
          - logger.log:
              level: INFO
              format: "[LVGL] OTA check complete"
    - if:
        condition:
          lambda: 'return id(validate_ha_sensors).is_running();'
        then:
          - logger.log:
              level: INFO
              format: "[LVGL] Waiting for sensor validation to complete before sleep..."
          - wait_until:
              condition:
                lambda: 'return !id(validate_ha_sensors).is_running();'
              timeout: 90s
          - logger.log:
              level: INFO
              format: "[LVGL] Sensor validation complete"
    - if:
        condition:
          binary_sensor.is_off: battery_charging
        then:
          - logger.log:
              level: INFO
              format: "[LVGL] Not charging - entering deep sleep for ${sleep_duration}"
          - deep_sleep.enter:
              id: deep_sleep_id
              sleep_duration: ${sleep_duration}
        else:
          - logger.log:
              level: INFO
              format: "[LVGL] Charging detected - skipping deep sleep"

  on_resume:
    - logger.log:
        level: INFO
        format: "[LVGL] on_resume - display waking up"
  on_boot:
    - logger.log:
        level: INFO
        format: "[LVGL] on_boot - LVGL starting"

  pages:
    - id: main_page
      bg_color: 0x000000
      scrollbar_mode: "OFF"
      widgets:
        # Status Bar - at top of main page
        - obj:
            id: status_bar
            width: 100%
            height: 30
            align: TOP_MID
            bg_color: 0x000000
            x: 0
            y: 0
            border_width: 0
            radius: 0
            pad_all: 3
            widgets:
              # Left side: Location (lat/long)
              - label:
                  id: lbl_status_location
                  align: LEFT_MID
                  x: 5
                  text_font: roboto_22
                  text_color: 0xFFFFFF
                  text: "-"

              # Center: Date
              - label:
                  id: lbl_status_date
                  align: CENTER
                  x: 0
                  y: 0
                  text_font: roboto_22
                  text_color: 0xFFFFFF
                  text: "-- --, ----"

              # Right side container with flex layout
              - obj:
                  id: status_icons_container
                  align: RIGHT_MID
                  x: 0
                  y: 0
                  width: SIZE_CONTENT
                  height: 100%
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: ROW_REVERSE
                    flex_align_main: START
                    flex_align_cross: CENTER
                    pad_column: 5
                  widgets:
                    # Home Assistant status (rightmost)
                    - label:
                        id: lbl_ha_status
                        text_font: homeassistant_icons
                        text_color: 0xFFFFFF
                        text: "\U000F0F21"

                    # WiFi status
                    - label:
                        id: lbl_wifi_status
                        text_font: wifi_icons
                        text_color: 0xFFFFFF
                        text: "\U000F05AA"

                    # Battery icon
                    - label:
                        id: lbl_battery_status
                        text_font: battery_icons
                        text_color: 0xFFFFFF
                        text: "\U000F0091"

                    # Battery percentage text (leftmost)
                    - label:
                        id: lbl_battery_percent
                        text_font: roboto_22
                        text_color: 0xFFFFFF
                        text: "--%"  # Static initial, updated by script

        # Weather Section (left side)
        - obj:
            id: weather_container
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            align: TOP_LEFT
            x: 20
            y: 35
            pad_all: 10
            bg_opa: TRANSP
            border_width: 0
            layout:
              type: FLEX
              flex_flow: COLUMN
              flex_align_main: START
              flex_align_cross: CENTER
              pad_row: 5
            widgets:
              - label:
                  id: lbl_weather_icon
                  text_font: weather_icon_large
                  text_color: 0xFFFFFF
                  text: "\U000F0599"  # Default sunny icon
              
              - label:
                  id: lbl_weather_temp
                  text_font: roboto_26
                  text_color: 0xFFFFFF
                  text: "--°"
              
              - label:
                  id: lbl_weather_condition
                  text_color: 0xFFFFFF
                  text: "Unknown"

        # Info Column (right of weather)
        - obj:
            id: info_column
            width: SIZE_CONTENT
            height: SIZE_CONTENT
            align: TOP_LEFT
            x: 140
            y: 35
            bg_opa: TRANSP
            border_width: 0
            pad_all: 5
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: START
              flex_align_cross: START
              pad_column: 20
            widgets:
              # Sunrise/Sunset Column
              - obj:
                  id: sun_container
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: START
                    flex_align_cross: START
                    pad_row: 5
                  widgets:
                    # Sunrise row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_sunrise_icon
                              text_font: sun_icons
                              text_color: 0xFFFFFF
                              text: "\U000F059C"  # mdi:weather-sunset-up
                          - label:
                              id: lbl_sunrise_time
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--:--"
                    # Sunset row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_sunset_icon
                              text_font: sun_icons
                              text_color: 0xFFFFFF
                              text: "\U000F059B"  # mdi:weather-sunset-down
                          - label:
                              id: lbl_sunset_time
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--:--"

              # Interior Climate Column
              - obj:
                  id: interior_container
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: START
                    flex_align_cross: START
                    pad_row: 5
                  widgets:
                    # Interior temp/humidity row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_interior_label
                              text_font: climate_icons
                              text_color: 0xFFFFFF
                              text: "\U000F11D4"
                          - label:
                              id: lbl_interior_temp
                              text_font: roboto_22
                              text_color: 0xFFFFFF
                              text: "--°"
                          - label:
                              id: lbl_humidity_icon
                              text_font: climate_icons
                              text_color: 0xFFFFFF
                              text: "\U000F0058"
                          - label:
                              id: lbl_interior_humidity
                              text_font: roboto_22
                              text_color: 0xFFFFFF
                              text: "--%"
                    # Fridge row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_fridge_label
                              text_font: climate_icons
                              text_color: 0xFFFFFF
                              text: "\U000F15EE"
                          - label:
                              id: lbl_fridge_temp
                              text_font: roboto_22
                              text_color: 0xFFFFFF
                              text: "--°"

              # Air Quality Column
              - obj:
                  id: air_quality_container
                  width: SIZE_CONTENT
                  height: SIZE_CONTENT
                  bg_opa: TRANSP
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: FLEX
                    flex_flow: COLUMN
                    flex_align_main: START
                    flex_align_cross: START
                    pad_row: 5
                  widgets:
                    # CO2 row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_co2_label
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "CO₂:"
                          - label:
                              id: lbl_co2_value
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--ppm"
                          - label:
                              id: lbl_co2_status
                              text_font: roboto_18
                              text_color: 0x888888
                              text: ""
                    # PM2.5 row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_pm25_label
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "PM2.5:"
                          - label:
                              id: lbl_pm25_value
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--"
                          - label:
                              id: lbl_pm25_status
                              text_font: roboto_18
                              text_color: 0x888888
                              text: ""
                    # VOC row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_voc_label
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "VOC:"
                          - label:
                              id: lbl_voc_value
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--"
                          - label:
                              id: lbl_voc_status
                              text_font: roboto_18
                              text_color: 0x888888
                              text: ""
                    # NOx row
                    - obj:
                        width: SIZE_CONTENT
                        height: SIZE_CONTENT
                        bg_opa: TRANSP
                        border_width: 0
                        pad_all: 0
                        layout:
                          type: FLEX
                          flex_flow: ROW
                          flex_align_cross: CENTER
                          pad_column: 5
                        widgets:
                          - label:
                              id: lbl_nox_label
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "NOx:"
                          - label:
                              id: lbl_nox_value
                              text_font: roboto_18
                              text_color: 0xFFFFFF
                              text: "--"
                          - label:
                              id: lbl_nox_status
                              text_font: roboto_18
                              text_color: 0x888888
                              text: ""

        # Arc gauges container - evenly spaced across bottom
        - obj:
            id: arcs_container
            width: 100%
            height: 170
            align: BOTTOM_MID
            y: -10
            bg_opa: TRANSP
            border_width: 0
            scrollbar_mode: "OFF"
            pad_left: 20
            pad_right: 20
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: SPACE_EVENLY
              flex_align_cross: CENTER
            widgets:
              # Fuel Level Arc
              - arc:
                  id: arc_fuel
                  width: 150
                  height: 150
                  start_angle: 135
                  end_angle: 45
                  rotation: 0
                  min_value: 0
                  max_value: 100
                  styles: style_arc
                  indicator:
                    styles: style_arc_indicator
                  widgets:
                    - label:
                        id: lbl_fuel_value
                        align: CENTER
                        y: -10
                        text_font: roboto_26
                        text_color: 0xFFFFFF
                        text: "-- %"
                    - label:
                        id: lbl_fuel_range
                        align: CENTER
                        y: 15
                        text_font: roboto_18
                        text_color: 0xFFFFFF
                        text: "-- mi"
                    - label:
                        id: lbl_fuel_label
                        align: BOTTOM_MID
                        y: -5
                        text_color: 0xFFFFFF
                        text: "Fuel"

              # DEF Level Arc
              - arc:
                  id: arc_def
                  width: 150
                  height: 150
                  start_angle: 135
                  end_angle: 45
                  rotation: 0
                  min_value: 0
                  max_value: 100
                  styles: style_arc
                  indicator:
                    styles: style_arc_indicator
                  widgets:
                    - label:
                        id: lbl_def_value
                        align: CENTER
                        y: -10
                        text_font: roboto_26
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (isnan(id(def_level).state)) return "--%";
                          static char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f%%", id(def_level).state);
                          return buf;
                    - label:
                        id: lbl_def_range
                        align: CENTER
                        y: 15
                        text_font: roboto_18
                        text_color: 0xFFFFFF
                        text: "-- mi"
                    - label:
                        id: lbl_def_label
                        align: BOTTOM_MID
                        y: -5
                        text_color: 0xFFFFFF
                        text: "DEF"

              # Battery Level Arc
              - arc:
                  id: arc_battery
                  width: 150
                  height: 150
                  start_angle: 135
                  end_angle: 45
                  rotation: 0
                  min_value: 0
                  max_value: 100
                  styles: style_arc
                  indicator:
                    styles: style_arc_indicator
                  widgets:
                    - label:
                        id: lbl_vehicle_battery_value
                        align: CENTER
                        y: -10
                        text_font: roboto_26
                        text_color: 0xFFFFFF
                        text: !lambda |-
                          if (isnan(id(vehicle_battery).state)) return "--%";
                          static char buf[16];
                          snprintf(buf, sizeof(buf), "%.0f%%", id(vehicle_battery).state);
                          return buf;
                    - label:
                        id: lbl_battery_time
                        align: CENTER
                        y: 15
                        text_font: roboto_18
                        text_color: 0xFFFFFF
                        text: "-- hrs"
                    - label:
                        id: lbl_vehicle_battery_label
                        align: BOTTOM_MID
                        y: -5
                        text_color: 0xFFFFFF
                        text: "Battery"

              # Water Level Arc
              - arc:
                  id: arc_water
                  width: 150
                  height: 150
                  start_angle: 135
                  end_angle: 45
                  rotation: 0
                  min_value: 0
                  max_value: 100
                  value: 0
                  styles: style_arc
                  indicator:
                    styles: style_arc_indicator
                  widgets:
                    - label:
                        id: lbl_water_value
                        align: CENTER
                        y: -10
                        text_font: roboto_26
                        text_color: 0xFFFFFF
                        text: "--%"
                    - label:
                        id: lbl_water_time
                        align: CENTER
                        y: 15
                        text_font: roboto_18
                        text_color: 0xFFFFFF
                        text: "-- hrs"
                    - label:
                        id: lbl_water_label
                        align: BOTTOM_MID
                        y: -5
                        text_color: 0xFFFFFF
                        text: "Water"

# Deep sleep configuration - https://esphome.io/components/deep_sleep/
# Note: GPIO3 wakeup disabled due to false triggers - using timer only
deep_sleep:
  id: deep_sleep_id
  sleep_duration: ${sleep_duration}
  wakeup_pin: GPIO3
  wakeup_pin_mode: INVERT_WAKEUP

sensor:
  # Override battery sensors to use manual updates only
  - id: !extend battery_voltage
    update_interval: never

  - id: !extend battery_level
    update_interval: never

  - platform: wifi_signal
    id: wifi_signal_db
    name: "WiFi Signal"
    update_interval: 60s

  - platform: template
    name: "Wakeup Cause"
    accuracy_decimals: 0
    lambda: return esp_sleep_get_wakeup_cause();

  - platform: homeassistant
    id: location_latitude
    entity_id: sensor.global_positioning_system_latitude
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_latitude updated: %.6f", x);

  - platform: homeassistant
    id: location_longitude
    entity_id: sensor.global_positioning_system_longitude
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "location_longitude updated: %.6f", x);

  - platform: homeassistant
    id: fuel_level
    entity_id: sensor.fuel_level
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fuel_level updated: %.1f%%", x);

  - platform: homeassistant
    id: def_level
    entity_id: sensor.def_level
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "def_level updated: %.1f%%", x);

  - platform: homeassistant
    id: vehicle_battery
    entity_id: sensor.vehicle_battery
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "vehicle_battery updated: %.1f%%", x);

  - platform: homeassistant
    id: air_co2
    entity_id: sensor.airgradient_carbon_dioxide
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_co2 updated: %.0f ppm", x);

  - platform: homeassistant
    id: air_pm25
    entity_id: sensor.airgradient_pm2_5
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_pm25 updated: %.0f", x);

  - platform: homeassistant
    id: air_voc
    entity_id: sensor.airgradient_voc_index
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_voc updated: %.0f", x);

  - platform: homeassistant
    id: air_nox
    entity_id: sensor.airgradient_nox_index
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "air_nox updated: %.0f", x);

  - platform: homeassistant
    id: fridge_temp
    entity_id: sensor.fridge_temperature  # TODO: Change to your actual fridge temp entity
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fridge_temp updated: %.1f", x);

  - platform: homeassistant
    id: water_level
    entity_id: sensor.water_level  # TODO: Change to your actual water level entity
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "water_level updated: %.1f%%", x);

  - platform: homeassistant
    id: fuel_range
    entity_id: sensor.fuel_range  # Estimated miles remaining on fuel
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "fuel_range updated: %.0f mi", x);

  # Calculated fuel range based on local percentage and calibration
  - platform: template
    id: fuel_range_calculated
    name: "${friendly_name} Fuel Range Calculated"
    unit_of_measurement: "mi"
    accuracy_decimals: 0
    icon: "mdi:gas-station"
    state_class: measurement
    lambda: |-
      if (isnan(id(fuel_level).state)) return {};
      // Calculate gallons remaining: percentage * tank capacity
      float gallons_remaining = (id(fuel_level).state / 100.0) * id(fuel_tank_capacity).state;
      // Calculate miles: gallons * miles per gallon
      float miles = gallons_remaining * id(fuel_consumption_rate).state;
      return miles;
    update_interval: 60s

  - platform: homeassistant
    id: def_range
    entity_id: sensor.def_range  # Estimated miles remaining on DEF
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "def_range updated: %.0f mi", x);

  # Calculated DEF range based on local percentage and calibration
  - platform: template
    id: def_range_calculated
    name: "${friendly_name} DEF Range Calculated"
    unit_of_measurement: "mi"
    accuracy_decimals: 0
    icon: "mdi:fuel"
    state_class: measurement
    lambda: |-
      if (isnan(id(def_level).state)) return {};
      // Calculate gallons remaining: percentage * tank capacity
      float gallons_remaining = (id(def_level).state / 100.0) * id(def_tank_capacity).state;
      // Calculate miles: gallons * miles per gallon
      float miles = gallons_remaining * id(def_consumption_rate).state;
      return miles;
    update_interval: 60s

  - platform: homeassistant
    id: battery_time_remaining
    entity_id: sensor.battery_time_remaining  # Estimated hours remaining on battery
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "battery_time_remaining updated: %.1f hrs", x);

  - platform: homeassistant
    id: water_time_remaining
    entity_id: sensor.water_time_remaining  # Estimated hours remaining on water
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_SENSOR", "water_time_remaining updated: %.1f hrs", x);

select:
  - platform: template
    id: temp_unit_select
    name: "Temperature Unit"
    optimistic: true
    restore_value: true
    options:
      - "C"
      - "F"
    initial_option: "F"
    icon: "mdi:thermometer"

number:
  # DEF tank calibration (2025 Mercedes Sprinter)
  - platform: template
    id: def_tank_capacity
    name: "${friendly_name} DEF Tank Capacity"
    optimistic: true
    min_value: 1.0
    max_value: 15.0
    step: 0.1
    initial_value: 5.8
    restore_value: true
    unit_of_measurement: "gal"
    mode: box
    entity_category: config
    icon: "mdi:tank"

  - platform: template
    id: def_consumption_rate
    name: "${friendly_name} DEF Consumption Rate"
    optimistic: true
    min_value: 500
    max_value: 3000
    step: 50
    initial_value: 1000
    restore_value: true
    unit_of_measurement: "mi/gal"
    mode: box
    entity_category: config
    icon: "mdi:gauge"

  # Fuel tank calibration (2025 Mercedes Sprinter)
  - platform: template
    id: fuel_tank_capacity
    name: "${friendly_name} Fuel Tank Capacity"
    optimistic: true
    min_value: 10.0
    max_value: 100.0
    step: 0.5
    initial_value: 45.0
    restore_value: true
    unit_of_measurement: "gal"
    mode: box
    entity_category: config
    icon: "mdi:gas-station"

  - platform: template
    id: fuel_consumption_rate
    name: "${friendly_name} Fuel Consumption Rate"
    optimistic: true
    min_value: 5.0
    max_value: 35.0
    step: 0.5
    initial_value: 19.5
    restore_value: true
    unit_of_measurement: "mpg"
    mode: box
    entity_category: config
    icon: "mdi:gauge"

display:
  - id: !extend epaper_display
    auto_clear_enabled: false
    update_interval: never

# Home Assistant sensors for dashboard
text_sensor:
  - platform: homeassistant
    id: weather_condition
    entity_id: weather.forecast_home
    attribute: condition
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_condition updated: %s", x.c_str());

  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_home
    attribute: temperature
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "weather_temp updated: %s", x.c_str());

  - platform: homeassistant
    id: location_city
    entity_id: sensor.location_city
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_city updated: %s", x.c_str());

  - platform: homeassistant
    id: location_state
    entity_id: sensor.location_state
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "location_state updated: %s", x.c_str());

  - platform: homeassistant
    id: sunrise_time
    entity_id: sensor.sunrise
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "sunrise_time updated: %s", x.c_str());

  - platform: homeassistant
    id: sunset_time
    entity_id: sensor.sunset
    internal: true
    on_value:
      then:
        - lambda: |-
            ESP_LOGI("HA_TEXT", "sunset_time updated: %s", x.c_str());
